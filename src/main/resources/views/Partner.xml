<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_0.9.xsd">
    
    <grid name="partner-grid" title="Partners" model="com.axelor.apps.base.db.Partner" orderBy="name">
	    <toolbar>
	        <button name="printPhoneBook" title="PhoneBook" icon="icon-print" onClick="action-print-phonebook"/>
	        <button name="printCompanyPhoneBook" title="Company phoneBook" icon="icon-print" onClick="action-print-compnay-phonebook"/>
	    </toolbar>
	    <field name="fullName"/>
	    <field name="mainInvoicingAddress"/>
	    <field name="fixedPhone"/>
		<field name="emailAddress.address"/>
	    <field name="partnerCategory"/>
		<button name="logCall" title="Log Call" colSpan="1" icon="icon-phone" help="Log Call" onClick="action-partner-view-create-call"/>
		<button name="scheduleMeeting" title="Schedule Meeting" colSpan="1" help="Schedule Meeting" icon="icon-group" onClick="action-partner-view-create-meeting"/>
		<button name="sendByEmail" title="Send Email" colSpan="1" help="Send Email" icon="icon-envelope" onClick="action-send-by-email-with-template"/>
	</grid>
    
    <grid name="partner-contact-grid" title="Contacts" model="com.axelor.apps.base.db.Partner">
	    <field name="fullName"/>
	    <field name="fixedPhone"/>
	    <field name="mobilePhone"/>
	    <field name="emailAddress.address"/>
	    <button name="logCall" title="Log Call" colSpan="1" icon="icon-phone" help="Log Call" onClick="action-partner-view-create-call"/>
		<button name="scheduleMeeting" title="Schedule Meeting" colSpan="1" help="Schedule Meeting" icon="icon-group" onClick="action-partner-view-create-meeting"/>
		<button name="sendByEmail" title="Send Email" colSpan="1" help="Send Email" icon="icon-envelope" onClick="action-send-by-email-with-template"/>
	</grid>
    
     <grid name="partner-grid-group" title="Partner" model="com.axelor.apps.base.db.Partner" groupBy="userInfo">
        <field name="fullName"/>
        <field name="mainInvoicingAddress"/>
        <field name="fixedPhone"/>
		<field name="mobilePhone"/>
        <field name="emailAddress.address"/>
        <field name="userInfo"/>
    </grid>
    
    <form name="partner-form" title="Partner" model="com.axelor.apps.base.db.Partner" cols="6" colWidths="25*" 
    onNew="action-partner-record-partner-type-select,action-partner-record-set-default" 
    onLoad="action-partner-attrs-change-name,action-partner-attrs-hide-tabs" 
    onSave="save,action-set-partner-seq,action-create-accounting-situation">
	    <toolbar>
	        <button name="sendByEmail" title="Send email" colSpan="1" icon="icon-envelope" onClick="save,action-send-by-email-with-template"/>
	        <button name="showPartnerInfo" title="Print Informations" colSpan="1" icon="icon-print" onClick="save,action-partner-method-show-partner-info"/>
	    </toolbar>
	    <menubar>
	        <menu title="Actions" icon="img/16px/create_16px.png" showTitle="true">
	            <item title="Create call" action="save,action-partner-view-create-call"/>
	            <item title="Schedule meeting" action="save,action-partner-view-create-meeting"/>
	            <item title="Create task" action="save,action-partner-view-create-task"/>
	            <item title="Create opportunity" action="save,action-partner-view-create-opportunity"/>
	        </menu>
	    </menubar>
	    <group colSpan="6" cols="6">
	        <group colSpan="1" cols="1">
	            <group colSpan="1">
	                <field name="picture" showTitle="false"/>
	            </group>
	        </group>
	        <group colSpan="1">
	            <field name="titleSelect" showTitle="false" hideIf="partnerTypeSelect != 2" placeholder="Civility"/>
	            <break/>
	            <field name="name" showTitle="false" css="highlight" placeholder="Name"/>
	            <break/>
	            <field name="firstName" showTitle="false" hideIf="partnerTypeSelect != 2" css="highlight" placeholder="First name"/>
	            <break/>
	            <field name="partnerTypeSelect" showTitle="false" onChange="action-partner-attrs-change-name,action-partner-attrs-hide-tabs"/>
	        </group>
	        <group colSpan="4" cols="4">
	            <field name="contactPartnerSet" hideIf="isContact || partnerTypeSelect == 2" colSpan="4" domain="self.isContact = 'true'" form-view="partner-contact-form" grid-view="partner-contact-grid"/>    
	        </group>
	    </group>
	    <break/>
	    <notebook colSpan="4">
	        <page name="information" title="Informations">
	            <group colSpan="4" cols="4" hideIf="isContact">
	                <group colSpan="2" cols="4" colWidths="20%,20%,40%,20%">
	                    <field name="isCustomer" hideIf="partnerTypeSelect == 2"/>
	                    <field name="customerTypeSelect" showTitle="false" hideIf="(isContact &amp;&amp; partnerTypeSelect == 2) || !isCustomer"/>
	                    <spacer/>
	                </group>
	                <group colSpan="2" cols="4" colWidths="20%,20%,40%,20%">
	                    <field name="isSupplier" hideIf="partnerTypeSelect == 2" onChange="action-set-supplier-type-select"/>
	                    <field name="supplierTypeSelect" showTitle="false" hideIf="partnerTypeSelect == 2 || isContact || !isSupplier"/>
	                </group>
	            </group>
	            <group title="Partner Details" hideIf="partnerTypeSelect == 2" colSpan="4" cols="4">
	                <group colSpan="2" cols="2">
	                    <field name="partnerCategory" widget="SuggestBox"/>
	                    <field name="industrySectorSelect"/>
	                    <field name="source"/>
	                    <field name="site" domain="self.partner.id = :id"/>
	                    <field name="department"/>
	                </group>
	                <group colSpan="2" cols="2">
	                    <field name="salesTurnover"/>
	                    <field name="nbrEmployees"/>
	                    <field name="registrationCode"/>
	                    <field name="taxNbr"/>
	                    <field name="parentPartner" hideIf="partnerTypeSelect != 1"/>
	                </group>
	            </group>
	            <group title="Postal addresses" colSpan="4" cols="4">
	                <field name="deliveryAddress" onChange="action-partner-record-main-invoicing-address"/>
	                <field name="mainInvoicingAddress"/>
	            </group>
	            <group title="Contact" colSpan="4" cols="4">
	                <field name="fixedPhone"/>
	                <field name="mobilePhone" hideIf="partnerTypeSelect == 1"/>
	                <field name="emailAddress" canSelect="false" canNew="false" form-view="email-address-simple-form"/>
	                <field name="fax"/>
	                <field name="webSite"/>
	            </group>
	        </page>
	        <page title="Notes">
	            <field name="description" showTitle="false" colSpan="4" widget="Html[lite=true]"/>
	        </page>
	        <page name="payment" title="Invoicing/Payment" hideIf="partnerTypeSelect == 2" colSpan="4" cols="4">
	            <field name="invoiceSendingFormatSelect"/>
	            <field name="paymentMode"/>
	            <field name="paymentCondition"/>
	            <field name="currency"/>
	            <field name="bankDetails" widget="SuggestBox" domain="self.partner.id = :id"/>
	            <field name="bankDetailsList" showTitle="false" colSpan="4" form-view="bank-details-form" grid-view="bank-details-grid"/>
	        </page>
	        <page title="Settings" cols="4">
	            <field name="partnerSeq"/>
	            <field name="languageSelect"/>
	            <group title="Assigned to" colSpan="4" cols="4" canCollapse="true">
	                <field name="companySet" colSpan="4" widget="TagSelect[create=name]" onChange="action-partner-company-set-validate"/>
	                <break/>
	                <field name="userInfo"/>
	                <field name="team"/>
	            </group>
	        </page>
	        <page name="activities" title="Activities" >
			    <portlet colSpan="6" action="action-partner-view-upcoming-events"/>
			    <portlet colSpan="6" action="action-partner-view-historical-events-completed"/>
			    <portlet colSpan="6" action="action-partner-view-opportunities"/>
			    <portlet colSpan="6" action="action-partner-view-tickets"/>
	        </page>
	    </notebook>
	</form>
	
	<grid name="partner-light-grid" title="Contacts" model="com.axelor.apps.base.db.Partner">
        <field name="fullName"/>
        <field name="mainInvoicingAddress"/>
        <field name="fixedPhone"/>
		<field name="mobilePhone"/>
        <field name="email"/>
    </grid>
    
    <form cols="4" colWidths="25*" name="partner-light-form" title="Partner" model="com.axelor.apps.base.db.Partner"
	    onNew="action-partner-record-partner-type-select" 
	    onLoad="action-partner-attrs-change-namet" 
	    onSave="save,action-set-partner-seq">
	    
	    <toolbar>
    		<button name="sendByEmail" title="Send email" onClick="save,action-send-by-email-with-template" colSpan="1"/>
    	</toolbar>
    	
	    <group colSpan="1">
	        <field name="picture"/>
	    </group>
	    <group colSpan="3" cols="6">
	        <field name="titleSelect" hideIf="partnerTypeSelect != 2" css="highlight"/>
	        <field name="name" css="highlight"/>
	        <field name="firstName" hideIf="partnerTypeSelect != 2" css="highlight"/>
	        <break/>
	        <field name="partnerCategory" widget="SuggestBox"/>
	        <field name="partnerTypeSelect" onChange="action-partner-attrs-change-name"/>
	        <field name="isContact" hideIf="partnerTypeSelect != 2"/>
	        <break/>
	        <field name="mainPartner" hideIf="!isContact"/>
	    </group>
	    <notebook colSpan="4">
	        <page name="information" title="Informations">
	            <group title="Partner details" colSpan="3" cols="4" hideIf="partnerTypeSelect == 2">
	                <field name="site" domain="self.partner.id = :id"/>
	                <field name="department"/>
	                <field name="source" hideIf="isContact"/>
	            </group>
	            <group title="Postal addresses" hideIf="isContact" colSpan="3" cols="4">
	                <field name="mainInvoicingAddress" onChange="action-partner-record-main-invoicing-address"/>
	                <field name="deliveryAddress"/>
	            </group>
	            <group title="Contact" colSpan="3" cols="4">
	                <field name="emailAddress" canSelect="false" canNew="false" form-view="email-address-simple-form"/>
	                <field name="fax"/>
	                <field name="fixedPhone"/>
					<field name="mobilePhone"/>
	                <field name="webSite"/>
	            </group>
	        </page>
	    </notebook>
    </form>
	

	<form name="partner-contact-form" title="Contact" model="com.axelor.apps.base.db.Partner" cols="6" colWidths="25*" 
	onNew="action-partner-record-partner-type-select,action-partner-contact-record-default" 
	onLoad="action-partner-attrs-change-name,action-partner-attrs-hide-tabs" 
	onSave="save,action-set-partner-seq">
	    <toolbar>
	        <button name="sendByEmail" title="Send email" colSpan="1" onClick="save,action-send-by-email-with-template"/>
	        <button name="showPartnerInfo" title="Print Informations" colSpan="1" icon="icon-print" onClick="save,action-partner-method-show-partner-info"/>
	    </toolbar>
	    <menubar>
	        <menu title="Actions" icon="img/16px/create_16px.png" showTitle="true">
	            <item title="Create call" action="save,action-partner-view-create-call"/>
	            <item title="Schedule meeting" action="save,action-partner-view-create-meeting"/>
	            <item title="Create task" action="save,action-partner-view-create-task"/>
	            <item title="Create opportunity" action="save,action-partner-view-create-opportunity"/>
	        </menu>
	    </menubar>
	    <group colSpan="6" cols="6">
	        <group colSpan="1" cols="1">
	            <group colSpan="1">
	                <field name="picture" showTitle="false"/>
	            </group>
	        </group>
	        <group colSpan="1" cols="1">
	            <field name="titleSelect" showTitle="false" placeholder="Civility"/>
	            <break/>
	            <field name="name" showTitle="false" css="highlight" placeholder="Name"/>
	            <break/>
	            <field name="firstName" showTitle="false" css="highlight" placeholder="First name"/>
	            <break/>
	            <separator title="Company"/>
	            <field name="mainPartner"/>
	        </group>
	        <group title="Contact" colSpan="4" cols="4">
	            <field name="jobTitle"/>
	            <field name="reportsTo"/>
	            <separator colSpan="4"/>
	            <field name="fixedPhone"/>
	            <field name="mobilePhone"/>
	            <field name="emailAddress" canSelect="false" canNew="false" form-view="email-address-simple-form"/>
	            <field name="fax"/>
	            <field name="mainInvoicingAddress" title="Address"/>     
	        </group>
	    </group>
	    <break/>
	    <notebook colSpan="4">
	        <page title="Notes">
	            <field name="description" showTitle="false" colSpan="4" widget="Html[lite=true]"/>
	        </page>
	        <page title="Settings" cols="4">
	            <field name="partnerSeq"/>
	            <field name="languageSelect"/>
	            <group title="Assigned to" colSpan="4" cols="4" canCollapse="true">
	                <field name="companySet" colSpan="4" widget="TagSelect[create=name]" onChange="action-partner-company-set-validate"/>
	                <break/>
	                <field name="userInfo"/>
	                <field name="team"/>
	            </group>
	        </page>
		    <page name="activities" title="Activities" >
			    <portlet colSpan="6" action="action-partner-view-upcoming-events"/>
			    <portlet colSpan="6" action="action-partner-view-historical-events-completed"/>
			    <portlet colSpan="6" action="action-partner-view-opportunities"/>
			    <portlet colSpan="6" action="action-partner-view-tickets"/>
	        </page>
	    </notebook>
	</form>
	
	<action-record name="action-partner-record-get-lead-converted-context" model="com.axelor.apps.base.db.Partner">
		<field name="name" expr="eval: com.axelor.apps.crm.db.Lead.find(_parent._lead).name"/>
	</action-record>
	
    
    <action-method name="action-partner-method-show-partner-info">
		<call class="com.axelor.apps.base.web.PartnerController" method="showPartnerInfo"/>
	</action-method>
    
    <action-view name="action-partner-view-partner-invoice" title="Invoices" model="com.axelor.apps.account.db.Invoice">
		<view type="grid" name="invoice-grid"/>
		<view type="form" name="invoice-form"/>
		<domain>(self.partner = :id AND :_isContact = false) OR (self.contactPartner = :id AND :_isContact = true)</domain>
		<context name="id" expr="eval: id"/>
		<context name="_isContact" expr="eval: isContact"/>
	</action-view>
	
	<action-view name="action-partner-view-contact-invoice" title="Invoices" model="com.axelor.apps.account.db.Invoice">
		<view type="grid" name="invoice-grid"/>
		<view type="form" name="invoice-form"/>
		<domain>(self.partner = :id AND :_isContact = false) OR (self.contactPartner = :id AND :_isContact = true)</domain>
		<context name="id" expr="eval: id"/>
		<context name="_isContact" expr="eval: isContact"/>
	</action-view>
	
	<action-view name="action-partner-view-partner-sales-order" title="Sales orders" model="com.axelor.apps.supplychain.db.SalesOrder">
		<view type="grid" name="sales-order-grid"/>
		<view type="form" name="sales-order-form"/>
		<domain>(self.clientPartner = :id AND :_isContact = false) OR (self.contactPartner = :id AND :_isContact = true)</domain>
		<context name="id" expr="eval: id"/>
		<context name="_isContact" expr="eval: isContact"/>
	</action-view>
	
	<action-view name="action-partner-view-sn-profile" title="Profiles" model="com.axelor.apps.socialnetwork.db.SnProfile">
		<view type="form" name="sn-profile-form"/>
		<context name="id" expr="eval: id"/>
	</action-view>
    
<!--     CREATE CRM OBJECT FROM PARTNER -->
    
    <action-view name="action-partner-view-create-call" title="Create call" model="com.axelor.apps.crm.db.Event">
    	<view type="form" name="call-form"/>
    	<context name="_partner" expr="eval: __self__"/>
    	<context name="_typeSelect" expr="1"/>
    </action-view>
    
    <action-view name="action-partner-view-create-meeting" title="Create meeting" model="com.axelor.apps.crm.db.Event">
    	<view type="form" name="meeting-form"/>
    	<context name="_partner" expr="eval: __self__"/>
    	<context name="_typeSelect" expr="2"/>
    </action-view>
    
    <action-view name="action-partner-view-create-task" title="Create task" model="com.axelor.apps.crm.db.Event">
    	<view type="form" name="crm-task-form"/>
    	<context name="_partner" expr="eval: __self__"/>
    	<context name="_typeSelect" expr="3"/>
    </action-view>
    
    <action-view name="action-partner-view-create-opportunity" title="Create opportunity" model="com.axelor.apps.crm.db.Opportunity">
    	<view type="form" name="opportunity-form"/>
    	<context name="_partner" expr="eval: __self__"/>
    </action-view>
    
<!--     PORTLET -->
    
    <action-view name="action-partner-view-upcoming-events" title="Upcoming events" model="com.axelor.apps.crm.db.Event">
		<view type="grid" name="event-grid"/>
		<view type="form" name="event-form"/>
		<domain>((self.clientPartner.id = :id AND :_isContact = false) OR (self.contactPartner.id = :id AND :_isContact = true)) and self.startDateTime > :_todayTime and self.typeSelect != 5</domain>
		<context name="id" expr="eval: id"/>
		<context name="_todayTime" expr="eval: __datetime__"/>
		<context name="_isContact" expr="eval: isContact"/>
	</action-view>
	
	<action-view name="action-partner-view-historical-events-completed" title="Historical events completed" model="com.axelor.apps.crm.db.Event">
		<view type="grid" name="event-grid"/>
		<view type="form" name="event-form"/>
		<domain>((self.clientPartner.id = :id AND :_isContact = false) OR (self.contactPartner.id = :id AND :_isContact = true)) and self.endDateTime &lt; :_todayTime and self.typeSelect != 5</domain>
		<context name="id" expr="eval: id"/>
		<context name="_todayTime" expr="eval: __datetime__"/>
		<context name="_isContact" expr="eval: isContact"/>
	</action-view>
   	
   	<action-view name="action-partner-view-opportunities" title="Opportunities" model="com.axelor.apps.crm.db.Opportunity">
		<view type="grid" name="opportunity-grid"/>
		<view type="form" name="opportunity-form"/>
		<domain>self.partner.id = :id</domain>
		<context name="id" expr="eval: id"/>
		<context name="_isContact" expr="eval: isContact"/>
	</action-view>
    
    <action-view name="action-partner-view-sales-orders" title="Sales orders" model="com.axelor.apps.supplychain.db.SalesOrder">
		<view type="grid" name="sales-order-grid"/>
		<view type="form" name="sales-order-form"/>
		<domain>(self.clientPartner.id = :id AND :_isContact = false) OR (self.contactPartner.id = :id AND :_isContact = true)</domain>
		<context name="id" expr="eval: id"/>
		<context name="_isContact" expr="eval: isContact"/>
	</action-view>
	
	<action-view name="action-partner-view-tickets" title="Tickets" model="com.axelor.apps.crm.db.Event">
		<view type="grid" name="ticket-grid"/>
		<view type="form" name="ticket-form"/>
		<domain>((self.clientPartner.id = :id AND :_isContact = false) OR (self.contactPartner.id = :id AND :_isContact = true)) AND self.typeSelect = 5</domain>
		<context name="id" expr="eval: id"/>
		<context name="_isContact" expr="eval: isContact"/>
	</action-view>
    
    <action-record name="action-partner-record-main-invoicing-address" model="com.axelor.apps.base.db.Partner">
    	<field name="mainInvoicingAddress" expr="eval: deliveryAddress" if="mainInvoicingAddress == null"/>
    </action-record>
    
 	<action-attrs name="action-partner-attrs-change-name">
		<attribute name="title" for="name" expr="Raison sociale" if="partnerTypeSelect != 2"/>
    	<attribute name="title" for="name" expr="Nom" if="partnerTypeSelect == 2"/>
		<attribute name="required" for="name" expr="true"/>	
	</action-attrs>
	
	<action-attrs name="action-partner-attrs-hide-tabs">
		<attribute name="required" for="currency" expr="eval:!isContact || partnerTypeSelect != 2"/>
	</action-attrs>
	
	<action-record name="action-partner-record-partner-type-select" model="com.axelor.apps.base.db.Partner" >
    	<field name="partnerTypeSelect" expr="eval:_partnerTypeSelect"/>
    </action-record>
    
    <action-record name="action-partner-record-set-default" model="com.axelor.apps.base.db.Partner">
    	<field name="isCustomer" expr="eval:true" />
    	<field name="isSupplier" expr="eval:partnerTypeSelect != 2"/>
    	<field name="currency" expr="eval:com.axelor.apps.base.db.UserInfo.all().filter('internalUser = ?1',__user__).fetchOne()?.activeCompany?.currency" if="!isContact"/>
    	<field name="invoiceSendingFormatSelect" expr="eval:'emailpaper'" if="!isContact"/>
    	<field name="userInfo"  expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserInfo()"/>
    	<field name="team"  expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserActiveTeam()"/>
    	<field name="companySet" expr="call:com.axelor.apps.base.web.PartnerController:getActiveCompany()"/>
    </action-record>
    
    <action-record name="action-partner-contact-record-default" model="com.axelor.apps.base.db.Partner">
    	<field name="partnerTypeSelect" expr="2" />
    	<field name="isContact" expr="true"/>
    	<field name="companySet" expr="eval: _parent?.companySet"/>
    	<field name="languageSelect" expr="eval: _parent?.languageSelect"/>
    	<field name="userInfo"  expr="eval: _parent.userInfo" if="_parent._model == 'com.axelor.apps.base.db.Partner'"/>
    	<field name="team"  expr="eval: _parent.team" if="_parent._model == 'com.axelor.apps.base.db.Partner'"/>
    	<field name="userInfo"  expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserInfo()" if="_parent == null || _parent._model != 'com.axelor.apps.base.db.Partner'"/>
    	<field name="team"  expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserActiveTeam()" if="_parent == null || _parent._model != 'com.axelor.apps.base.db.Partner'"/>
    </action-record>
    
    <action-record name="action-partner-set-non-contact-fields" model="com.axelor.apps.base.db.Partner">
    	<field name="currency" expr="eval:null" if="!isContact"/>
    	<field name="invoiceSendingFormatSelect" expr="eval:null" if="!isContact"/>
    </action-record>
	
	<action-record name="action-set-supplier-type-select" model="com.axelor.apps.base.db.Partner">
		<field name="supplierTypeSelect" expr="eval:isSupplier ? 1 : null"/>
	</action-record>
	
	<action-method name="action-set-partner-seq" >
		<call class="com.axelor.apps.base.web.PartnerController" method="setPartnerSequence"/>
	</action-method>
    
    <action-method name="action-print-compnay-phonebook" >
		<call class="com.axelor.apps.base.web.PartnerController" method="printCompanyPhonebook"/>
	</action-method>
	
	<action-method name="action-print-phonebook" >
		<call class="com.axelor.apps.base.web.PartnerController" method="printContactPhonebook"/>
	</action-method>
	
	<action-method name="action-partner-method-show-client-situation" >
		<call class="com.axelor.apps.base.web.PartnerController" method="printClientSituation"/>
	</action-method>
	
	<search-filters name="partner-filters" model="com.axelor.apps.base.db.Partner" title="Partner filters">
		<filter title="All Enterprises">
			<domain>self.partnerTypeSelect = 1 AND self.isContact = false</domain>
		</filter>
		<filter title="All Individuals">
			<domain>self.partnerTypeSelect = 2 AND self.isContact = false</domain>
		</filter>
		<filter title="All Prospects">
			<domain>self.customerTypeSelect = 2 AND self.isContact = false</domain>
		</filter>
		<filter title="All Clients">
			<domain>self.customerTypeSelect = 3 AND self.isContact = false</domain>
		</filter>
		<filter title="All Suppliers">
			<domain>self.supplierTypeSelect = 2 AND self.isContact = false</domain>
		</filter>
	</search-filters>
	
	
</object-views>
