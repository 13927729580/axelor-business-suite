<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_0.9.xsd">
    
    <grid name="currency-conversion-line-grid" title="Currency conversion lines" model="com.axelor.apps.base.db.CurrencyConversionLine">
        <field name="startCurrency"/>
        <field name="endCurrency"/>
        <field name="conversionRate"/>
        <field name="variations" />
        <field name="fromDate"/>
        <field name="toDate"/>
        <field name="general" hidden="true" />
        <button name="checkRate" title="Check rate" icon="icon-repeat" onClick="wizard-check-currency-conversion-rate-line" />
    </grid>
    
    <form name="currency-conversion-line-form" title="Currency conversion line" model="com.axelor.apps.base.db.CurrencyConversionLine" cols="4"
    onNew="action-currency-conversion-line-default-record">
        <field name="startCurrency"/>
        <field name="endCurrency" />
        <field name="fromDate" onChange="action-currency-conversion-line-method-check-date" />
        <field name="toDate" onChange="action-currency-conversion-line-method-check-date" />
        <field name="conversionRate"/>
        <field name="variations" showTitle="false" />
    </form>
    
    <form onNew="action-currency-conversion-line-wizard-set-today,action-currency-conversion-line-set-current-rate" name="wizard-check-currency-rate-form" title="Check currency conversion rates" model="com.axelor.apps.base.db.Wizard" cols="4">
    	<field name="fromCurrency" widget="MANY_TO_ONE[target=com.axelor.apps.base.db.Currency|targetName=code]" title="Source Currency"/>
    	<field name="toCurrency" widget="MANY_TO_ONE[target=com.axelor.apps.base.db.Currency|targetName=code]" title="Destination Currency" />
    	<field name="general" widget="MANY_TO_ONE[target=com.axelor.apps.base.db.General|targetName=today]" title="General" hidden="true" />
    	<group colSpan="4" cols="6" title="System rates">
    		<field name="date" widget="DATE" title="Current Date" />
	    	<field name="currentRate" widget="DECIMAL" title="Current Rate" />
	    	<button title="Get Rate" help="Get rate at the 'Current Date'" readonlyIf="fromCurrency == null || toCurrency == null || date == null" onClick="action-currency-conversion-line-set-current-rate" name="getRate"/>
	    	<label title="" />
	    </group>
	    <group colSpan="4" cols="6" title="New Rates">
	    	<field name="conversionRate" widget="DECIMAL" title="New rate" />
	    	<field name="variation" title="Variation" />
	    	<button title="Get new rates" help="Get new rate at present from internet" readonlyIf="fromCurrency == null || toCurrency == null" onClick="action-currency-conversion-line-set-conversion-rate,action-currency-conversion-line-set-varation-rate" name="checkRate"/>
	    	<label title="" />
	    </group>
	    <button name="updateRate"  title="Apply Currency Conversion Rate"  help="Update currency conversion lines with new rate" onClick="action-currency-conversion-line-method-apply-conversion-rate" colSpan="4" readonlyIf="fromCurrency == null || toCurrency == null || conversionRate == null"/>
    </form>
    
    <action-method name="action-currency-conversion-line-method-getTodayDate">
    	<call class="com.axelor.apps.base.service.administration.GeneralService" method="getTodayDate()"/>
   	</action-method>
    
    <action-method name="action-currency-conversion-line-method-check-date">
    	<call class="com.axelor.apps.base.web.CurrencyConversionLineController" method="checkDate"/>
    </action-method>
    
    <action-method name="action-currency-conversion-line-method-apply-conversion-rate">
    	<call class="com.axelor.apps.base.web.CurrencyConversionLineController" method="applyConversionRate"/>
    </action-method>
    
    <action-record name="action-currency-conversion-line-set-conversion-rate" model="com.axelor.apps.base.db.Wizard">
    	<field name="conversionRate" expr="call:com.axelor.apps.base.service.CurrencyConversionService:convert(Currency.find(fromCurrency.id),Currency.find(toCurrency.id))" />
    </action-record>
    
    <action-record name="action-currency-conversion-line-set-varation-rate" model="com.axelor.apps.base.db.Wizard">
    	<field name="variation" expr="call:com.axelor.apps.base.service.CurrencyConversionService:getVariations(conversionRate as BigDecimal, currentRate as BigDecimal)" />
    </action-record>
    
    <action-record name="action-currency-conversion-line-reset-dates" model="com.axelor.apps.base.db.CurrencyConversionLine">
    	<field name="fromDate" expr="eval:null" />
    	<field name="toDate" expr="eval:null" />
    </action-record>
    
    <action-record name="action-currency-conversion-line-set-current-rate" model="com.axelor.apps.base.db.Wizard">
    	<field name="currentRate" if="fromCurrency != null &amp;&amp; toCurrency != null &amp;&amp; date != null" expr="call:com.axelor.apps.base.service.CurrencyConversionService:getRate(Currency.find(fromCurrency.id),Currency.find(toCurrency.id), new LocalDate(date))" />
    </action-record>
    
     <action-record name="action-currency-conversion-line-wizard-set-today" model="com.axelor.apps.base.db.Wizard">
    	<field name="date" expr="call:com.axelor.apps.base.service.administration.GeneralService:getTodayDate()" />
    	<field name="fromCurrency" expr="eval:Currency.find(_fromCurrency.id)" if="_fromCurrency != null"/>
    	<field name="toCurrency" expr="eval:Currency.find(_toCurrency.id)" if="_toCurrency != null"/>
    	<field name="general" expr="eval:_general"  />
    </action-record>
    
    <action-view title="Check currency conversion rate" model="com.axelor.apps.base.db.Wizard" name="wizard-check-currency-conversion-rate-line">
	    <view type="form" name="wizard-check-currency-rate-form"/>
	    <view-param name="popup" value="reload"/>
	    <view-param name="forceEdit" value="true"/> 
	    <view-param name="width" value="800" />
	    <view-param name="show-confirm" value="false" />
	    <context name="_fromCurrency" expr="eval:startCurrency" if="startCurrency != null" />
	    <context name="_toCurrency" expr="eval:endCurrency" if="endCurrency != null" />
	    <context name="_general" expr="eval:general"/>
	</action-view>

</object-views>
