<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_0.9.xsd">
    
    <grid name="currency-conversion-line-grid" groupBy="startCurrency,endCurrency" orderBy="-fromDate" title="Currency conversion lines" model="com.axelor.apps.base.db.CurrencyConversionLine">
        <field name="startCurrency"/>
        <field name="endCurrency"/>
        <field name="exchangeRate"/>
        <field name="variations" />
        <field name="fromDate"/>
        <field name="toDate" />
        <field name="general" hidden="true" />
        <button name="checkRate" title="Check rate" readonlyIf="toDate != null" icon="icon-repeat" onClick="wizard-check-currency-conversion-rate-line" />
    </grid>
    
    <form name="currency-conversion-line-form" title="Currency conversion line" model="com.axelor.apps.base.db.CurrencyConversionLine" cols="4"
    onNew="action-currency-conversion-line-default-record">
        <field name="startCurrency"/>
        <field name="endCurrency" />
        <button title="Get rate" readonlyIf="startCurrency == null || endCurrency == null || toDate != null" onClick="action-currency-conversion-line-validate-rate-change,action-currency-conversion-line-method-convert" name="getRate"/>
        <label colSpan="3" title="" />
        <group title="Applicable dates" colSpan="4">
	        <field name="fromDate" onChange="action-currency-conversion-line-method-check-date" />
	        <field name="toDate" onChange="action-currency-conversion-line-method-check-date" readonlyIf="fromDate == null"/>
        </group>
        <group title="Rate" colSpan="4">
	        <field name="exchangeRate"/>
	        <field name="variations" />
        </group>
    </form>
    
    <form onNew="action-currency-conversion-line-wizard-set-today,action-currency-conversion-line-set-exchange-rate,action-currency-conversion-line-method-convert" 
    name="wizard-check-currency-rate-form" title="Check currency exhange rates" model="com.axelor.apps.base.db.Wizard" cols="4">
    	<field name="startCurrency" widget="MANY_TO_ONE[target=com.axelor.apps.base.db.Currency|targetName=code]" title="Source Currency"/>
    	<field name="endCurrency" widget="MANY_TO_ONE[target=com.axelor.apps.base.db.Currency|targetName=code]" title="Destination Currency" />
    	<field name="general" widget="MANY_TO_ONE[target=com.axelor.apps.base.db.General|targetName=today]" title="General" hidden="true" />
    	<group colSpan="4" cols="6" title="System active rate">
    		<field name="date" widget="DATE" title="Rate Date" readonly="true" />
	    	<field name="exchangeRate" widget="DECIMAL" title="Exchange rate" readonly="true"/>
	    </group>
	    <group colSpan="4" cols="6" title="Rate updation">
	    	<field name="newExchangeRate" widget="DECIMAL" title="New exchange rate" />
	    	<field name="variations" title="Variation" />
	    	<button title="Check / Update rate" help="Get new rate at present from internet" readonlyIf="startCurrency == null || endCurrency == null" onClick="action-currency-conversion-line-method-convert" name="checkRate"/>
	    	<label title="" />
	    </group>
	    <button name="updateRate"  title="Save new rate"  help="Create currency conversion lines with new rate" onClick="action-currency-conversion-line-method-apply-conversion-rate" colSpan="4" readonlyIf="startCurrency == null || endCurrency == null || exchangeRate == null"/>
    </form>
    
    <action-method name="action-currency-conversion-line-method-getTodayDate">
    	<call class="com.axelor.apps.base.service.administration.GeneralService" method="getTodayDate()"/>
   	</action-method>
    
    <action-method name="action-currency-conversion-line-method-check-date">
    	<call class="com.axelor.apps.base.web.CurrencyConversionLineController" method="checkDate"/>
    </action-method>
    
    <action-method name="action-currency-conversion-line-method-apply-conversion-rate">
    	<call class="com.axelor.apps.base.web.CurrencyConversionLineController" method="applyExchangeRate"/>
    </action-method>
    
    <action-method name="action-currency-conversion-line-method-convert" >
    	<call class="com.axelor.apps.base.web.CurrencyConversionLineController" method="convert"/>
    </action-method>
    
    <action-record name="action-currency-conversion-line-reset-dates" model="com.axelor.apps.base.db.CurrencyConversionLine">
    	<field name="fromDate" expr="eval:null" />
    	<field name="toDate" expr="eval:null" />
    </action-record>
    
    <action-record name="action-currency-conversion-line-set-exchange-rate" model="com.axelor.apps.base.db.Wizard">
    	<field name="exchangeRate" if="startCurrency != null &amp;&amp; endCurrency != null &amp;&amp; date != null" expr="call:com.axelor.apps.base.service.CurrencyConversionService:getRate(Currency.find(startCurrency.id),Currency.find(endCurrency.id), new LocalDate(date))" />
    </action-record>
    
     <action-record name="action-currency-conversion-line-wizard-set-today" model="com.axelor.apps.base.db.Wizard">
    	<field name="date" expr="call:com.axelor.apps.base.service.administration.GeneralService:getTodayDate()" />
    	<field name="startCurrency" expr="eval:Currency.find(_startCurrency.id)" if="_startCurrency != null"/>
    	<field name="endCurrency" expr="eval:Currency.find(_endCurrency.id)" if="_endCurrency != null"/>
    	<field name="general" expr="eval:_general"  />
    </action-record>
    
    <action-view title="Check currency exhange rate" model="com.axelor.apps.base.db.Wizard" name="wizard-check-currency-conversion-rate-line">
	    <view type="form" name="wizard-check-currency-rate-form"/>
	    <view-param name="popup" value="reload"/>
	    <view-param name="forceEdit" value="true"/> 
	    <view-param name="width" value="800" />
	    <view-param name="show-confirm" value="false" />
	    <context name="_startCurrency" expr="eval:startCurrency" if="startCurrency != null" />
	    <context name="_endCurrency" expr="eval:endCurrency" if="endCurrency != null" />
	    <context name="_general" expr="eval:general"/>
	</action-view>
	
	<action-validate name="action-currency-conversion-line-validate-rate-change" >
		<alert message="You are about to overwrite an existing exchange rate. This rate may already be in use in the system. Do you wish to continue ?" 
		if="fromDate != null &amp;&amp; exchangeRate != null &amp;&amp; id != null"/>
	</action-validate>

</object-views>
