<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_2.1.xsd">
    
    <grid name="lead-grid" title="Leads" model="com.axelor.apps.crm.db.Lead" orderBy="-contactDate,statusSelect">
    	<toolbar>
    		<button name="grabLeads" help="Assign to me" icon="fa-suitcase" onClick="com.axelor.apps.crm.web.EventController:assignToMeLead" />
    		<button name="print" title="Print" icon="fa-print" onClick="action-crm-lead-method-print"/>
<!--     		<button name="showMap" title="Map" onClick="action-show-leads-on-map-page" /> -->
    		<button name="checkDuplicate" title="Check duplicate" onClick="action-general-check-duplicate-records" help=""/>
    	</toolbar>
    	<hilite color="warning" if="statusSelect == 1 &amp;&amp; (user == null || contactDate == null) &amp;&amp; $moment(todayDate).diff(createdOn,'days') &gt;= 15"/>
	    <hilite color="primary" if="statusSelect == 1"/>
	    <hilite color="danger" if="(statusSelect == 2 || statusSelect == 3) &amp;&amp; $moment(todayDate).diff(updatedOn,'days') &gt;= 15"/>
	    <hilite color="success" if="statusSelect == 4"/>
  	  	<field name="createdOn" hidden="true"/>
    	<field name="updatedOn" hidden="true"/>
        <field name="name"/>
        <field name="firstName"/>
		<field name="enterpriseName"/>
        <field name="fixedPhone"/>
		<field name="emailAddress.address"/>
		<field name="contactDate"/>
		<field name="user"/>
        <field name="statusSelect"/>
        <button name="grabLead" help="Assign to me" icon="fa-suitcase" onClick="com.axelor.apps.crm.web.EventController:assignToMeLead" readonlyIf="user != null"/>
		<button name="logCall" title="Log Call" icon="fa-phone" onClick="action-lead-view-create-call"/>
		<button name="scheduleMeeting" title="Schedule Meeting" icon="fa-group" onClick="action-lead-view-create-meeting"/>
		<button name="sendByEmail" title="Send Email" icon="fa-envelope" onClick="action-send-by-email-with-template"/>
    </grid>
    
   <form cols="4" onLoad="action-lead-attrs-readonly-other-address" onNew="action-group-crm-lead-onnew" name="lead-form" title="Lead" model="com.axelor.apps.crm.db.Lead">
  <toolbar>
    <button name="convertLead" title="Convert lead" hideIf="statusSelect == 4" readonlyIf="statusSelect == 4 || statusSelect == 6" onClick="save,action-lead-view-convert-lead"/>
    <button name="sendByEmail" title="Send email" readonlyIf="statusSelect == 4 || statusSelect == 6" icon="fa-envelope" onClick="save,action-send-by-email-with-template"/>
    <button name="print" title="Print" icon="fa-print" onClick="action-crm-lead-method-print"/>
  </toolbar>
  <menubar>
    <menu title="Actions" icon="img/16px/create_16px.png" showTitle="true">
      <item title="Create call" action="save,action-lead-view-create-call"/>
      <item title="Schedule meeting" action="save,action-lead-view-create-meeting"/>
      <item title="Create task" action="save,action-lead-view-create-task"/>
      <item title="Create opportunity" action="save,action-lead-view-create-opportunity"/>
    </menu>
  </menubar>
  <panel readonlyIf="statusSelect == 4 || statusSelect == 6">
    <panel title="Personal" x-span="12">
      <panel x-span="4">
        <field name="picture" showTitle="false" widget="Image"/>
      </panel>
      <panel x-span="8">
        <field name="titleSelect" showTitle="false" placeholder="Civility" x-span="2"/>
        <field name="name" showTitle="false" css="highlight" placeholder="Name" x-span="5"/>
        <field name="firstName" showTitle="false" css="highlight" placeholder="First name" x-span="5"/>
      </panel>
    </panel>
    <panel title="Company" x-span="12">
          <field name="enterpriseName" showIf="partner == null" placeholder="Enterprise name"/>
          <field name="partner" showIf="statusSelect == 4" domain="self.isContact = false" form-view="partner-form" grid-view="partner-grid"/>
          <field name="jobTitle" placeholder="Function"/>
    </panel>

    <panel title="CoordonnÃ©es">
      <field name="fixedPhone"/>
      <field name="fax"/>
      <field name="mobilePhone"/>
      <field name="emailAddress" canSelect="false" canNew="false" form-view="email-address-simple-form"/>
    </panel>
    <panel title="Assigned to">
          <field name="contactDate"/>
          <button name="grabLead" title="Assign to me" hideIf="user.id == _internalUserId" colSpan="2" icon="fa-suitcase" onClick="save,com.axelor.apps.crm.web.EventController:assignToMeLead"/>
          <field name="user"/>
          <field name="team"/>
    </panel>
  </panel>
  <panel-tabs>
     <panel name="information" title="Informations">
      <panel title="Primary address" readonlyIf="statusSelect == 4 || statusSelect == 6" x-span="6">
        <field name="primaryAddress" x-span="12"/>
        <field name="primaryCity" x-span="4"/>
        <field name="primaryState" x-span="4"/>
        <field name="primaryPostalCode" x-span="4"/>
        <field name="primaryCountry" x-span="12"/>
      </panel>
       <panel title="Other address" readonlyIf="statusSelect == 4 || statusSelect == 6" x-span="6">
        <field name="otherAddress" x-span="12"/>
        <field name="otherCity" x-span="4"/>
        <field name="otherState" x-span="4"/>
        <field name="otherPostalCode" x-span="4"/>
        <field name="otherCountry" x-span="12"/>
        <field name="isCopyAddress" onChange="action-group-crm-lead-iscopyaddress-onchange"/>
      </panel>
      <panel title="Extra information" readonlyIf="statusSelect == 4 || statusSelect == 6" x-span="12">
        <field name="officeName"/>
        <field name="department"/>
        <field name="webSite"/>
        <field name="description" colSpan="6" widget="TEXT" x-height="3"/>
      </panel>
     </panel>
      <panel title="Status details" x-span="12">
        <field name="statusSelect"/>
        <field name="statusDescription"/>
      </panel>
      <panel title="Source details" readonlyIf="statusSelect == 4 || statusSelect == 6" x-span="12">
        <field name="source"/>
        <field name="sourceDescription"/>
      </panel>
      <panel title="Marketing" readonlyIf="statusSelect == 4 || statusSelect == 6" x-span="12">
        <field name="campaign"/>
        <field name="referredBy"/>
        <field name="isDoNotCall"/>
        <field name="isDoNotSendEmail"/>
         <field name="opportunityAmount" readonlyIf="statusSelect == 4 || statusSelect == 6"/>
      </panel>
     
    
  
    <!--TODO:Remove this comment when portlet starts working-->
    <!--<panel name="activities" title="Activities" readonlyIf="statusSelect == 4 || statusSelect == 6">
      <portlet colSpan="4" action="action-lead-view-upcoming-events"/>
      <portlet colSpan="4" action="action-lead-view-historical-events-completed"/>
      <portlet colSpan="4" action="action-lead-view-opportunity"/>
      <portlet colSpan="4" action="action-lead-view-event-ticket"/>
    </panel>-->
  </panel-tabs>
</form>

	
	
	<grid name="lead-event-grid" title="Leads" model="com.axelor.apps.crm.db.Lead" orderBy="enterpriseName">
        <field name="name"/>
        <field name="firstName"/>
		<field name="enterpriseName"/>
        <field name="fixedPhone"/>
		<field name="emailAddress.address"/>
		<field name="contactDate"/>
		<field name="user"/>
        <field name="statusSelect"/>
		<button name="add" title="Add" icon="fa-plus" onClick="action-lead-event-add-attendee"/>
    </grid>
	
	<grid orderBy="-contactDate,statusSelect" edit-icon="true" name="my-lead-grid" title="My Leads" model="com.axelor.apps.crm.db.Lead">
		<hilite color="warning" if="statusSelect == 1 &amp;&amp; (user == null || contactDate == null) &amp;&amp; $moment(todayDate).diff(createdOn,'days') &gt;= 15"/>
	    <hilite color="primary" if="statusSelect == 1"/>
	    <hilite color="danger" if="(statusSelect == 2 || statusSelect == 3) &amp;&amp; $moment(todayDate).diff(updatedOn,'days') &gt;= 15"/>
	    <hilite color="success" if="statusSelect == 4"/>
		<field name="createdOn" hidden="true"/>
		<field name="updatedOn" hidden="true"/>
		<field name="name"/>
		<field name="firstName"/>
		<field name="enterpriseName"/>
		<field name="fixedPhone"/>
		<field name="mobilePhone"/>
		<field name="emailAddress.address"/>
		<field name="statusSelect"/>
		<button name="logCall" title="Log Call" icon="fa-phone" onClick="action-lead-view-create-call"/>
		<button name="scheduleMeeting" title="Schedule Meeting" icon="fa-group" onClick="action-lead-view-create-meeting"/>
		<button name="sendByEmail" title="Send Email" icon="fa-envelope" onClick="action-send-by-email-with-template"/>
	</grid>
	
	<action-group name="action-group-crm-lead-onnew">
		<action name="action-account-record-new"/>
		<action name="action-lead-default-record-new"/>
	</action-group>
	
	<action-group name="action-group-crm-lead-iscopyaddress-onchange">
		<action name="action-lead-record-other-address"/>
		<action name="action-lead-attrs-readonly-other-address"/>
	</action-group>
	
	<action-method name="action-lead-event-add-attendee">
		<call class="com.axelor.apps.crm.web.EventController" method="addLeadAttendee"/>
	</action-method>
	
	<action-method name="action-crm-lead-method-print">
		<call method="print" class="com.axelor.apps.crm.web.LeadController"/>
	</action-method>
    
    <action-record name="action-lead-record-new" model="com.axelor.apps.crm.db.Lead">
    	<field name="company"  expr="call:com.axelor.apps.base.service.user.UserService:getUserActiveCompany()"/>
    </action-record>
    
    <action-record name="action-lead-default-record-new" model="com.axelor.apps.crm.db.Lead">
    	<field name="statusSelect" expr="2"/>
    	<field name="contactDate" expr="call:com.axelor.apps.base.service.administration.GeneralService:getTodayDate()" if="contactDate == null"/>
    	<field name="user"  expr="eval:__user__"/>
    	<field name="team"  expr="call:com.axelor.apps.base.service.user.UserService:getUserActiveTeam()"/>
    </action-record>
    
    <action-record name="action-lead-record-other-address" model="com.axelor.apps.crm.db.Lead">
    	<field name="otherAddress" expr="eval: primaryAddress" if="isCopyAddress"/>
    	<field name="otherCity" expr="eval: primaryCity" if="isCopyAddress"/>
    	<field name="otherState" expr="eval: primaryState" if="isCopyAddress"/>
    	<field name="otherPostalCode" expr="eval: primaryPostalCode" if="isCopyAddress"/>
    	<field name="otherCountry" expr="eval: primaryCountry" if="isCopyAddress"/>
    </action-record>
    
   	<action-attrs name="action-lead-attrs-readonly-other-address">
   		<attribute name="readonly" for="otherAddress" expr="isCopyAddress"/>
   		<attribute name="readonly" for="otherCity" expr="eval: isCopyAddress"/>
   		<attribute name="readonly" for="otherState" expr="eval: isCopyAddress"/>
   		<attribute name="readonly" for="otherPostalCode" expr="eval: isCopyAddress"/>
   		<attribute name="readonly" for="otherCountry" expr="eval: isCopyAddress"/>
   	</action-attrs>
   	
   	<action-view name="action-lead-view-convert-lead" title="Convert lead" model="com.axelor.apps.base.db.Wizard">
		<view type="form" name="convert-lead-wizard-form"/>
		<context name="_lead" expr="eval: __self__"/>
		<context name="_primaryAddress" expr="eval: primaryAddress"/>
	</action-view>
    
    <!--     CREATE CRM OBJECT FROM LEAD -->
    
    <action-view name="action-lead-view-create-call" title="Create call" model="com.axelor.apps.crm.db.Event">
    	<view type="form" name="call-form"/>
    	<context name="_lead" expr="eval: __self__"/>
    	<context name="_typeSelect" expr="1"/>
    </action-view>
    
    <action-view name="action-lead-view-create-meeting" title="Create meeting" model="com.axelor.apps.crm.db.Event">
    	<view type="form" name="meeting-form"/>
    	<context name="_lead" expr="eval: __self__"/>
    	<context name="_typeSelect" expr="2"/>
    </action-view>
    
    <action-view name="action-lead-view-create-task" title="Create task" model="com.axelor.apps.crm.db.Event">
    	<view type="form" name="crm-task-form"/>
    	<context name="_lead" expr="eval: __self__"/>
    	<context name="_typeSelect" expr="3"/>
    </action-view>
    
    <action-view name="action-lead-view-create-opportunity" title="Create opportunity" model="com.axelor.apps.crm.db.Opportunity">
    	<view type="form" name="opportunity-form"/>
    	<context name="_lead" expr="eval: __self__"/>
    </action-view>
   	
<!--    	PORTLET -->
   	
	<action-view name="action-lead-view-upcoming-events" title="Upcoming events" model="com.axelor.apps.crm.db.Event">
		<view type="grid" name="event-grid"/>
		<view type="form" name="event-form"/>
		<domain>self.lead.id = :id and self.startDateTime > :_todayTime and self.typeSelect != 5</domain>
		<context name="id" expr="eval: id"/>
		<context name="_todayTime" expr="eval: __datetime__"/>
	</action-view>
	
	<action-view name="action-lead-view-historical-events-completed" title="Historical events completed" model="com.axelor.apps.crm.db.Event">
		<view type="grid" name="event-grid"/>
		<view type="form" name="event-form"/>
		<domain>self.lead.id = :id and self.endDateTime &lt; :_todayTime and self.typeSelect != 5</domain>
		<context name="id" expr="eval: id"/>
		<context name="_todayTime" expr="eval: __datetime__"/>
	</action-view>
   	
   	<action-view name="action-lead-view-opportunity" title="Opportunities" model="com.axelor.apps.crm.db.Opportunity">
		<view type="grid" name="opportunity-grid"/>
		<view type="form" name="opportunity-form"/>
		<domain>self.lead.id = :id</domain>
		<context name="id" expr="eval: id"/>
	</action-view>
	
	<action-view name="action-lead-view-event-ticket" title="Tickets" model="com.axelor.apps.crm.db.Event">
		<view type="grid" name="ticket-grid"/>
		<view type="form" name="ticket-form"/>
		<domain>self.lead.id = :id AND self.typeSelect = 5</domain>
		<context name="id" expr="eval: id"/>
	</action-view>
	
	<action-method name="action-show-leads-on-map-page">
	  <call method="showLeadsOnMap" class="com.axelor.apps.crm.web.LeadController"/>
	</action-method>	
	
   	<search-filters name="lead-filters" model="com.axelor.apps.crm.db.Lead" title="Lead filters">
		<filter title="My Leads">
			<domain>self.user = :__user__</domain>
		</filter>
		<filter title="Unassigned Leads">
			<domain>self.user IS NULL</domain>
		</filter>
		<filter title="My Team Leads">
			<domain>self.team = :_myActiveTeam</domain>
		</filter>
	</search-filters>
	
</object-views>
