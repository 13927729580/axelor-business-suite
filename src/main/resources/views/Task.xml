<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_0.9.xsd">
    
    <calendar name="task-calendar" title="Tasks" mode="month" colorBy="userInfo" 
	    eventStart="startDateT" 
	    eventStop="endDateT" 
	    eventLength="1">
	    <field name="name" />
 	 </calendar>
    
    <grid name="task-grid" title="Tasks" model="com.axelor.apps.organisation.db.Task" orderBy="taskProgress">
        <field name="name"/>
        <field name="project"/>
        <field name="totalTaskQty"/>
        <field name="totalTimeSheetQty"/>
        <field name="taskProgress" widget="SelectProgress"/>
    </grid>
    
    <grid name="task-project-grid" title="Tasks" model="com.axelor.apps.organisation.db.Task" orderBy="taskProgress">
        <field name="name"/>
        <field name="userInfo"/>
        <field name="totalPlannedQty"/>
        <field name="totalTimeSheetQty"/>
    </grid>
    
    <form name="task-form" title="Task" model="com.axelor.apps.organisation.db.Task" cols="4" onNew="action-task-default-record,action-task-attrs-hide-financial" 
    onLoad="action-task-method-update-financial-information,action-task-method-get-spent-time,action-task-method-get-planned-time,action-task-record-remaining-time,action-task-record-progress,action-task-attrs-status-select,action-task-record-task-completed,save">
    	<group colSpan="4" cols="3">
    		<field name="name" showTitle="false" css="highlight" placeholder="Task name" colSpan="2"/>
    		<field name="statusSelect" showTitle="false" colSpan="1" widget="NavSelect" onChange="action-task-attrs-status-select"/>
    	</group>
    	<group name="context" title="Context" colSpan="4" cols="6">
       		<field name="project" onChange="action-task-attrs-project-title,action-task-attrs-hide-financial"/>
        	<field name="startDateT"/>
        	<field name="endDateT"/>  
        	<field name="userInfo"/>
        	<field name="totalTime"/>
        	<field name="unit"/>  
    	</group>
	    <group colSpan="4" cols="6">
	        <group title="Times" colSpan="6" cols="6">
	            <field name="plannedTime"/>
	            <field name="spentTime"/>
	            <field name="remainingTime"/>
	        </group>
	        <group title="Avancement" colSpan="6" cols="6">
		        <field name="taskProgress" widget="SelectProgress" onChange="action-task-record-delays-and-advance,action-task-record-task-completed"/>
	            <field name="delays"/>
	            <field name="advance"/>
	        </group>
	    </group>
	    <button name="generateDraftInvoice" title="Generate draft invoice" showIf="isToInvoice == true &amp;&amp; statusSelect == 3" colSpan="1" onClick="save,action-task-validate-generate-invoice,action-task-method-create-invoice"/>
	    <break/>
	    <notebook colSpan="4">
	        <page title="Planification and realization">
	            <field name="planningLineList" onChange="action-task-method-get-planned-time" colSpan="4" form-view="planning-line-task-form" grid-view="planning-line-task-grid"/>
	        </page>
	        <page title="Suivi Facturation">
	            <field name="salesOrderLine" onChange="action-task-salesOrderLine-on-change"/>
	            <field name="product"/>
	            <field name="qty"/>
	            <field name="price"/> 
	            <field name="isToInvoice"/>
	            <field name="isTimesheetAffected"/>
	            <field name="invoicingDate"/>
	            <field name="amountToInvoice"/>  
	        </page>
	        <page title="Notes">
	            <field name="notes" colSpan="4" showTitle="false"/>
	        </page>
	        <page name="financialInformation" title="Financial information" colSpan="4">
	        	<field name="exportTypeSelect"/>
	            <button name="printTask" colSpan="2" title="Voir rapport estimations" onClick="action-print-task-report" icon="img/icons/print.png"/>
				<group title="Initial" colSpan="4" cols="6">
	                <field name="initialTurnover"/>
	                <field name="initialCost"/>
	                <field name="initialMargin"/>
	            </group>
	            <group title="Estimated" colSpan="4" cols="6">
	                <field name="estimatedTurnover"/>
	                <field name="estimatedCost"/>
	                <field name="estimatedMargin"/>
	            </group>
	            <group title="Realized" colSpan="4" cols="6">
	                <field name="realizedTurnover"/>
	                <field name="realizedCost"/>
	                <field name="realizedMargin"/>
	            </group>
	            
	        </page>
	        <page title="Links" colSpan="4">
<!-- 	        	<field name="taskUpdateLineList" colSpan="4"/> -->
	        	<notebook>
	        		<page title="Initial">
	        			<portlet colSpan="4" action="action-task-view-submitted-sales-order-line"/>
	     				<portlet colSpan="4" action="action-task-view-submitted-purchase-order-line"/>
	        		</page>
	        		<page title="Estimated">
	        			<portlet colSpan="4" action="action-task-view-validated-sales-order-line"/>
	     				<portlet colSpan="4" action="action-task-view-validated-purchase-order-line"/>
	        		</page>
	        		<page title="Realized">
	        			<portlet colSpan="4" action="action-task-view-customer-invoice-line"/>
			     		<portlet colSpan="4" action="action-task-view-supplier-invoice-line"/>
			     		<portlet colSpan="4" action="action-task-view-timesheet-line"/>
			     		<portlet colSpan="4" action="action-task-view-expense-line"/>
	        		</page>
	        	</notebook>
	        </page>
	        <page title="Description" colSpan="4">
	            <field name="description" showTitle="false" colSpan="4"/>
	        </page>
	        <page title="Spent times">
        		<field name="spentTimeList" showTitle="false" colSpan="4" grid-view="spent-time-task-grid" form-view="spent-time-task-form" onChange="action-task-method-get-spent-time,action-task-record-progress,action-task-record-task-completed"/>
        	</page>
	    </notebook>
	</form>
	
	<grid name="task-leave-reason-grid" title="Tasks" model="com.axelor.apps.organisation.db.Task">
        <field name="name"/>
        <field name="hasCummulation"/>
        <field name="accountingDay"/>
    </grid>
	
	<form name="task-leave-reason-form" title="Task" model="com.axelor.apps.organisation.db.Task" cols="4" onNew="action-task-default-record">
    	<group colSpan="4" cols="3">
    		<field name="name" showTitle="false" css="highlight" placeholder="Task name" colSpan="2"/>
    		<field name="statusSelect" showTitle="false" colSpan="1" widget="NavSelect"/>
    		<field name="hasCummulation"/>
    		<field name="accountingDay"/>
    	</group>
    	<group title="Context" colSpan="4" cols="6">
       		<field name="project" onChange="action-task-attrs-project-title,action-task-attrs-hide-financial"/>
        	<field name="userInfo"/>
        	<field name="taskProgress" widget="Progress"/>
        	<field name="startDateT"/>
        	<field name="endDateT"/>    
        	<field name="totalTask"/>
    	</group>
	    <notebook colSpan="4">
	        <page title="Planification and realization">
	            <field name="planningLineList" onChange="action-task-compute-total-planned-qty" colSpan="4" form-view="planning-line-task-form" grid-view="planning-line-task-grid"/>
	        </page>
	        <page title="Notes">
	            <field name="notes" colSpan="4"/>
	        </page>
	        <page title="Description" colSpan="4">
	            <field name="description" showTitle="false" colSpan="4"/>
	        </page>
	        <page title="Spent times">
        		<field name="spentTimeList" showTitle="false" colSpan="4" grid-view="spent-time-task-grid" form-view="spent-time-task-form"/>
        	</page>
	    </notebook>
	</form>
    
    <action-record name="action-task-default-record" model="com.axelor.apps.organisation.db.Task">
    	<field name="startDateT" expr="call:com.axelor.apps.base.service.administration.GeneralService:getTodayDateTime()" if="startDateT == null"/>
    	<field name="statusSelect" expr="eval: 1"/>
    	<field name="userInfo" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserInfo()"/>
    	<field name="isTimesheetAffected" expr="true"/>
    	<field name="exportTypeSelect" expr="eval: pdf"/>
    </action-record>
    
    <action-record name="action-task-record-delays-and-advance" model="com.axelor.apps.organisation.db.Task">
		<field name="advance" expr="eval: spentTime - taskProgress*totalTime/100" if="spentTime - taskProgress*totalTime/100 > 0"/>
		<field name="delays" expr="eval: taskProgress*totalTime/100 - spentTime" if="taskProgress*totalTime/100 - spentTime > 0"/>
		<field name="delays" expr="eval: 0" if="spentTime - taskProgress*totalTime/100 >= 0"/>
		<field name="advance" expr="eval: 0" if="taskProgress*totalTime/100 - spentTime >= 0"/>
	</action-record>
	
	<action-record name="action-task-record-task-completed" model="com.axelor.apps.organisation.db.Task">
		<field name="statusSelect" expr="4" if="taskProgress == 100"/>
	</action-record>
	
	<action-record name="action-task-record-progress" model="com.axelor.apps.organisation.db.Task">
		<field name="taskProgress" expr="eval: 100 * spentTime / totalTime" if="totalTime > 0"/>
		<field name="taskProgress" expr="eval: 0" if="totalTime == 0"/>
	</action-record>
	
	<action-attrs name="action-task-attrs-status-select">
		<attribute name="readonly" for="context" expr="eval: statusSelect >= 3"/>
	</action-attrs>
	
	<action-record name="action-task-record-remaining-time" model="com.axelor.apps.organisation.db.Task">
		<field name="remainingTime" expr="eval: totalTime - spentTime"/>
	</action-record>
	
	<action-method name="action-task-method-get-spent-time">
		<call class="com.axelor.apps.organisation.web.TaskController" method="getSpentTime"/>
	</action-method>
	
	<action-method name="action-task-method-get-planned-time">
		<call class="com.axelor.apps.organisation.web.TaskController" method="getPlannedTime"/>
	</action-method>
    
    <action-record name="action-task-salesOrderLine-on-change" model="com.axelor.apps.organisation.db.Task">
    	<field name="product" expr="eval:salesOrderLine?.product" if="salesOrderLine"/>
    	<field name="qty" expr="eval:salesOrderLine?.qty" if="salesOrderLine"/>
    	<field name="price" expr="eval:salesOrderLine?.price" if="salesOrderLine"/>
    </action-record>
    
    <action-method name="action-task-method-create-invoice">
		<call class="com.axelor.apps.accountorganisation.web.TaskInvoiceController" method="createInvoice"/>
	</action-method>
	
	<action-validate name="action-task-validate-generate-invoice">
   		<alert message="Generating invoice is impossible, Please link the task to a saleOrderLine to do so." if="salesOrderLine == null"/>
	</action-validate> 
	
	<action-attrs name="action-task-attrs-project-title">
		<attribute name="title" for="project" expr="Projet" if="project?.isProject == true &amp;&amp; project?.isAffair == false"/>
		<attribute name="title" for="project" expr="Affaire" if="project?.isProject == false &amp;&amp; project?.isAffair == true"/>
		<attribute name="title" for="project" expr="Projet/Affaire" if="project?.isProject == true &amp;&amp; project?.isAffair == true"/>
	</action-attrs>
	
	<action-attrs name="action-task-attrs-hide-financial">
		<attribute name="hidden" for="financialInformation" expr="eval: project == null || project?.isAffair == false"/>
	</action-attrs>
	
	<action-method name="action-task-method-update-financial-information">
		<call class="com.axelor.apps.organisation.web.TaskController" method="updateFinancialInformation"/>
	</action-method>
	
	<action-method name="action-print-task-report" >
		<call class="com.axelor.apps.organisation.web.TaskController" method="printTaskReport"/>
	</action-method>
  	
  	<action-view name="action-task-view-submitted-sales-order-line" title="Submitted customer order lines" model="com.axelor.apps.supplychain.db.SalesOrderLine">
  		<view type="grid" name="sales-order-line-grid"/>
		<view type="form" name="sales-order-line-form"/>
  		<domain>self.salesOrder.statusSelect = 2 and self.task.id = :id</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
  	<action-view name="action-task-view-submitted-purchase-order-line" title="Submitted supplier order lines" model="com.axelor.apps.supplychain.db.PurchaseOrderLine">
  		<view type="grid" name="purchase-order-line-grid"/>
		<view type="form" name="purchase-order-line-form"/>
  		<domain>self.purchaseOrder.statusSelect = 2 and self.task.id = :id</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
  	<action-view name="action-task-view-validated-sales-order-line" title="Validated Customer order lines" model="com.axelor.apps.supplychain.db.SalesOrderLine">
  		<view type="grid" name="sales-order-line-grid"/>
		<view type="form" name="sales-order-line-form"/>
  		<domain>self.salesOrder.statusSelect = 3 and self.task.id = :id</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
  	<action-view name="action-task-view-validated-purchase-order-line" title="Validated supplier order lines" model="com.axelor.apps.supplychain.db.PurchaseOrderLine">
  		<view type="grid" name="purchase-order-line-grid"/>
		<view type="form" name="purchase-order-line-form"/>
  		<domain>self.purchaseOrder.statusSelect = 3 and self.task.id = :id</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
  	<action-view name="action-task-view-customer-invoice-line" title="Customer invoice lines" model="com.axelor.apps.account.db.InvoiceLine">
  		<view type="grid" name="invoice-line-grid"/>
		<view type="form" name="invoice-line-form"/>
  		<domain>self.invoice.status.code = 'dis' and self.task.id = :id and (self.invoice.operationTypeSelect = 3 or self.invoice.operationTypeSelect = 4)</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
  	<action-view name="action-task-view-supplier-invoice-line" title="Supplier invoice lines" model="com.axelor.apps.account.db.InvoiceLine">
  		<view type="grid" name="invoice-line-grid"/>
		<view type="form" name="invoice-line-form"/>
  		<domain>self.invoice.status.code = 'dis' and self.task.id = :id and (self.invoice.operationTypeSelect = 1 or self.invoice.operationTypeSelect = 2)</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
  	<action-view name="action-task-view-timesheet-line" title="Timesheet lines" model="com.axelor.apps.organisation.db.TimesheetLine">
  		<view type="grid" name="timesheet-line-employee-grid"/>
		<view type="form" name="timesheet-line-employee-form"/>
  		<domain>self.timesheet.statusSelect = 3 and self.task.id = :id</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
  	<action-view name="action-task-view-expense-line" title="Travel expense lines" model="com.axelor.apps.organisation.db.ExpenseLine">
  		<view type="grid" name="expense-line-grid"/>
		<view type="form" name="expense-line-form"/>
  		<domain>self.expense.statusSelect = 3 and self.task.id = :id</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
	
	<search-filters name="tasks-filters" model="com.axelor.apps.organisation.db.Task" title="Tasks filters">
		<filter title="My Tasks">
			<domain>self.userInfo.internalUser.id = :_internalUser</domain>
		</filter>
		<filter title="My Today tasks">
			<domain>self.userInfo.internalUser.id = :_internalUser and self.startDateT &lt;= :_todayDateTime</domain>
		</filter>
		<filter title="My Upcoming Tasks">
			<domain>self.userInfo.internalUser.id = :_internalUser and self.startDateT &lt; :_newDate</domain>
		</filter>
		<filter title="Tasks Underevaluated">
			<domain>self.spentTime &gt; self.estimateTime</domain>
		</filter>
		<filter title="Tasks To Invoice">
			<domain>self.isToInvoice = true</domain>
		</filter>
	</search-filters>
	
</object-views>