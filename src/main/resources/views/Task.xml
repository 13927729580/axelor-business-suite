<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_0.9.xsd">
    
    <calendar name="task-calendar" title="Tasks" mode="month" colorBy="userInfo" 
	    eventStart="startDateT" 
	    eventStop="endDateT" 
	    eventLength="1">
	    <field name="name" />
 	 </calendar>
    
    <grid name="task-grid" title="Tasks" model="com.axelor.apps.organisation.db.Task" orderBy="taskProgress">
        <field name="name"/>
        <field name="project"/>
        <field name="totalTaskQty"/>
        <field name="totalTimeSheetQty"/>
        <field name="taskProgress" widget="Progress"/>
    </grid>
    
    <grid name="task-project-grid" title="Tasks" model="com.axelor.apps.organisation.db.Task" orderBy="taskProgress">
        <field name="name"/>
        <field name="userInfo"/>
        <field name="totalPlannedQty"/>
        <field name="totalTimeSheetQty"/>
    </grid>
    
    <form name="task-form" title="Task" model="com.axelor.apps.organisation.db.Task" cols="4" onNew="action-task-default-record,action-task-attrs-hide-financial" 
    onSave="action-task-compute-margin">
    	<group colSpan="4" cols="3">
    		<field name="name" showTitle="false" css="highlight" placeholder="Task name" colSpan="2"/>
    		<field name="statusSelect" showTitle="false" colSpan="1" widget="NavSelect"/>
    	</group>
    	<group title="Context" colSpan="4" cols="6">
       		<field name="project" onChange="action-task-attrs-project-title,action-task-attrs-hide-financial"/>
        	<field name="userInfo"/>
        	<field name="taskProgress" widget="Progress"/>
        	<field name="startDateT"/>
        	<field name="endDateT"/>    
        	<field name="totalTask"/>
    	</group>
	    <group colSpan="4" cols="6">
	        <group title="Total" colSpan="2" cols="2">
	            <field name="totalTaskQty"/>
	            <field name="totalTaskUnit"/>
	        </group>
	        <group title="Planned" colSpan="2" cols="2">
	            <field name="totalPlannedQty"/>
	            <field name="totalPlannedUnit"/>
	        </group>
	        <group title="Real" colSpan="2" cols="2">
	            <field name="totalTimeSheetQty" title="Total worked quantity"/>
	            <field name="totalTimeSheetUnit" title="Total worked unit"/>
	        </group>
	    </group>
	    <button name="generateDraftInvoice" title="Generate draft invoice" showIf="isToInvoice == true &amp;&amp; statusSelect == 3" colSpan="1" onClick="save,action-task-validate-generate-invoice,action-task-method-create-invoice"/>
	    <break/>
	    <notebook colSpan="4">
	        <page title="Planification and realization">
	            <field name="planningLineList" onChange="action-task-compute-total-planned-qty" colSpan="4" form-view="planning-line-task-form" grid-view="planning-line-task-grid"/>
	        </page>
	        <page title="Suivi Facturation">
	            <field name="salesOrderLine" onChange="action-task-salesOrderLine-on-change"/>
	            <field name="product"/>
	            <field name="qty"/>
	            <field name="price"/> 
	            <field name="isToInvoice"/>
	            <field name="isTimesheetAffected"/>
	            <field name="invoicingDate"/>
	            <field name="amountToInvoice"/>  
	        </page>
	        <page title="Notes">
	            <field name="notes" colSpan="4"/>
	        </page>
	        <page name="financialInformation" title="Financial information" colSpan="4">
	            <group title="Estimated" colSpan="4" cols="6">
	                <field name="estimatedTurnover"/>
	                <field name="estimatedCost"/>
	                <field name="estimatedMargin"/>
	            </group>
	            <group title="Confirmed" colSpan="4" cols="6">
	                <field name="confirmedTurnover"/>
	                <field name="confirmedCost"/>
	                <field name="confirmedMargin"/>
	            </group>
	            <group title="Reaslized" colSpan="4" cols="6">
	                <field name="realizedTurnover"/>
	                <field name="realizedCost"/>
	                <field name="realizedMargin"/>
	            </group>
	            <field name="otherCostTaskProductLine" colSpan="4"/>
	            <field name="otherRevenueTaskProductLine" colSpan="4"/>
	            <field name="taskUpdateLineList" colSpan="4"/>
	            <field name="estimateTime"/>
	            <field name="spentTime"/>
	            <field name="remainingTime"/>
	            <field name="generatedCharge"/>
	        </page>
	        <page title="Links" colSpan="4">
	            <field name="submittedSalesOrderLineSet" colSpan="4"/>
	            <field name="submittedPurchaseOrderLineSet" colSpan="4"/>
	            <field name="validatedSalesOrderLineSet" colSpan="4"/>
	            <field name="validatedPurchaseOrderLineSet" colSpan="4"/>
	            <field name="customerInvoiceLineSet" colSpan="4"/>
	            <field name="supplierInvoiceLineSet" colSpan="4"/>
	            <field name="timesheetLineSet" colSpan="4"/>
	            <field name="expenseLineSet" colSpan="4"/>
	        </page>
	        <page title="Description" colSpan="4">
	            <field name="description" showTitle="false" colSpan="4"/>
	        </page>
	        <page title="Past times">
        		<field name="pastTimeList" showTitle="false" colSpan="4" grid-view="past-time-task-grid" form-view="past-time-task-form"/>
        	</page>
	    </notebook>
	</form>
	
	<grid name="task-leave-reason-grid" title="Tasks" model="com.axelor.apps.organisation.db.Task">
        <field name="name"/>
        <field name="hasCummulation"/>
        <field name="accountingDay"/>
    </grid>
	
	<form name="task-leave-reason-form" title="Task" model="com.axelor.apps.organisation.db.Task" cols="4" onNew="action-task-default-record"
    onSave="action-task-compute-margin">
    	<group colSpan="4" cols="3">
    		<field name="name" showTitle="false" css="highlight" placeholder="Task name" colSpan="2"/>
    		<field name="statusSelect" showTitle="false" colSpan="1" widget="NavSelect"/>
    		<field name="hasCummulation"/>
    		<field name="accountingDay"/>
    	</group>
    	<group title="Context" colSpan="4" cols="6">
       		<field name="project" onChange="action-task-attrs-project-title,action-task-attrs-hide-financial"/>
        	<field name="userInfo"/>
        	<field name="taskProgress" widget="Progress"/>
        	<field name="startDateT"/>
        	<field name="endDateT"/>    
        	<field name="totalTask"/>
    	</group>
	    <notebook colSpan="4">
	        <page title="Planification and realization">
	            <field name="planningLineList" onChange="action-task-compute-total-planned-qty" colSpan="4" form-view="planning-line-task-form" grid-view="planning-line-task-grid"/>
	        </page>
	        <page title="Notes">
	            <field name="notes" colSpan="4"/>
	        </page>
	        <page title="Description" colSpan="4">
	            <field name="description" showTitle="false" colSpan="4"/>
	        </page>
	        <page title="Past times">
        		<field name="pastTimeList" showTitle="false" colSpan="4" grid-view="past-time-task-grid" form-view="past-time-task-form"/>
        	</page>
	    </notebook>
	</form>
    
    <action-record name="action-task-default-record" model="com.axelor.apps.organisation.db.Task">
    	<field name="startDateT" expr="call:com.axelor.apps.base.service.administration.GeneralService:getTodayDateTime()" if="startDateT == null"/>
    	<field name="statusSelect" expr="eval: 1"/>
    	<field name="userInfo" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserInfo()"/>
    	<field name="isTimesheetAffected" expr="true"/>
    </action-record>
    
    <action-record name="action-task-salesOrderLine-on-change" model="com.axelor.apps.organisation.db.Task">
    	<field name="product" expr="eval:salesOrderLine?.product" if="salesOrderLine"/>
    	<field name="qty" expr="eval:salesOrderLine?.qty" if="salesOrderLine"/>
    	<field name="price" expr="eval:salesOrderLine?.price" if="salesOrderLine"/>
    </action-record>
    
    <action-record name="action-task-compute-total-planned-qty" model="com.axelor.apps.organisation.db.Task">
    	<field name="totalPlannedQty" expr="eval: planningLineList?.collect(){it?.duration}?.sum()" if="planningLineList != null"/>
    </action-record>
    	
    <action-method name="action-task-method-create-invoice">
		<call class="com.axelor.apps.accountorganisation.web.TaskInvoiceController" method="createInvoice"/>
	</action-method>
	
	<action-validate name="action-task-validate-generate-invoice">
   		<alert message="Generating invoice is impossible, Please link the task to a saleOrderLine to do so." if="salesOrderLine == null"/>
	</action-validate> 
	
	<action-attrs name="action-task-attrs-project-title">
		<attribute name="title" for="project" expr="Projet" if="project?.isProject == true &amp;&amp; project?.isAffair == false"/>
		<attribute name="title" for="project" expr="Affaire" if="project?.isProject == false &amp;&amp; project?.isAffair == true"/>
		<attribute name="title" for="project" expr="Projet/Affaire" if="project?.isProject == true &amp;&amp; project?.isAffair == true"/>
	</action-attrs>
	
	<action-attrs name="action-task-attrs-hide-financial">
		<attribute name="hidden" for="financialInformation" expr="eval: project == null || project?.isAffair == false"/>
	</action-attrs>
	
	<search-filters name="tasks-filters" model="com.axelor.apps.organisation.db.Task" title="Tasks filters">
		<filter title="My Tasks">
			<domain>self.userInfo.internalUser.id = :_internalUser</domain>
		</filter>
		<filter title="My Today tasks">
			<domain>self.userInfo.internalUser.id = :_internalUser and self.startDateT &lt;= :_todayDateTime</domain>
		</filter>
		<filter title="My Upcoming Tasks">
			<domain>self.userInfo.internalUser.id = :_internalUser and self.startDateT &lt; :_newDate</domain>
		</filter>
		<filter title="Tasks Underevaluated">
			<domain>self.spentTime &gt; self.estimateTime</domain>
		</filter>
		<filter title="Tasks To Invoice">
			<domain>self.isToInvoice = true</domain>
		</filter>
	</search-filters>
	
</object-views>