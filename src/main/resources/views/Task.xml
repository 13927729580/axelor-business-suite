<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_0.9.xsd">
    
    <calendar name="task-calendar" title="Tasks" mode="month" colorBy="userInfo" 
	    eventStart="startDateT" 
	    eventStop="endDateT" 
	    eventLength="1">
	    <field name="name" />
 	 </calendar>
    
    <grid name="task-grid" title="Tasks" model="com.axelor.apps.organisation.db.Task" orderBy="taskProgress">
        <field name="name"/>
        <field name="project"/>
        <field name="totalTaskQty"/>
        <field name="totalTimeSheetQty"/>
        <field name="taskProgress" widget="Progress"/>
    </grid>
    
    <grid name="task-project-grid" title="Tasks" model="com.axelor.apps.organisation.db.Task" orderBy="taskProgress">
        <field name="name"/>
        <field name="userInfo"/>
        <field name="totalPlannedQty"/>
        <field name="totalTimeSheetQty"/>
    </grid>
    
    <form cols="4" onNew="action-task-default-record" name="task-form" title="Task" model="com.axelor.apps.organisation.db.Task"
    onSave="action-task-compute-margin">
    	<field name="name"/>
    	<field name="statusSelect" showTitle="false" colSpan="2" widget="NavSelect"/>
    	<group title="Context" colSpan="4" cols="6">
       		<field name="project"/>
        	<field name="userInfo"/>
        	<field name="taskProgress" widget="Progress"/>
        	<field name="startDateT"/>
        	<field name="endDateT"/>    
        	<field name="totalTask"/>
    	</group>
	    <group colSpan="4" cols="6">
	        <group title="Total" colSpan="2" cols="2">
	            <field name="totalTaskQty"/>
	            <field name="totalTaskUnit"/>
	        </group>
	        <group title="Planned" colSpan="2" cols="2">
	            <field name="totalPlannedQty"/>
	            <field name="totalPlannedUnit"/>
	        </group>
	        <group title="Real" colSpan="2" cols="2">
	            <field name="totalTimeSheetQty" title="Total worked quantity"/>
	            <field name="totalTimeSheetUnit" title="Total worked unit"/>
	        </group>
	    </group>
	    <button name="backup" title="Backup" colSpan="2"/>
	    <break/>
	    <notebook colSpan="4">
	        <page title="Planification and realization">
	            <field name="planningLineList" onChange="action-task-compute-total-planned-qty" colSpan="4" form-view="planning-line-task-form" grid-view="planning-line-task-grid"/>
	        </page>
	        <page title="Suivi Facturation">
	            <field name="salesOrderLine" onChange="action-task-salesOrderLine-on-change"/>
	            <field name="product"/>
	            <field name="qty"/>
	            <field name="price"/> 
	            <field name="isToInvoice"/>
	            <field name="isTimesheetAffected"/>
	            <field name="invoicingDate"/>
	            <field name="amountToInvoice"/>  
	        </page>
	        <page title="Notes">
	            <field name="notes" colSpan="4"/>
	        </page>
	        <page title="Financial information" colSpan="4">
	            <group title="Budget initial" colSpan="4" cols="6">
	                <field name="initialBudgetTurnover" onChange="action-task-compute-margin"/>
	                <field name="initialBudgetCost" onChange="action-task-compute-margin"/>
	                <field name="initialBudgetMargin"/>
	            </group>
	            <group title="Reaslized" colSpan="4" cols="6">
	                <field name="realizedTurnover" onChange="action-task-compute-margin"/>
	                <field name="realizedBudgetCost" onChange="action-task-compute-margin"/>
	                <field name="realizedBudgetMargin"/>
	            </group>
	            <group title="Remaining to do" colSpan="4" cols="6">
	                <field name="remainingTurnover" onChange="action-task-compute-margin"/>
	                <field name="remainingBudgetCost" onChange="action-task-compute-margin"/>
	                <field name="remainingBudgetMargin"/>
	            </group>
	            <group title="Estimated final" colSpan="4" cols="6">
	                <field name="expectedFinalTurnover" onChange="action-task-compute-margin"/>
	                <field name="expectedFinalCost" onChange="action-task-compute-margin"/>
	                <field name="expectedFinalMargin"/>
	                <field name="gapBetweenFinalAndInitial"/>
	            </group>
	            <field name="otherCostTaskProductLine" colSpan="4"/>
	            <field name="otherRevenueTaskProductLine" colSpan="4"/>
	            <field name="taskUpdateLineList" colSpan="4"/>
	            <field name="estimateTime"/>
	            <field name="spentTime"/>
	            <field name="remainingTime"/>
	            <field name="generatedCharge"/>
	        </page>
	        <page title="Links" colSpan="4">
	            <field name="salesOrderLineList" colSpan="4"/>
	            <field name="customerInvoiceLineList" colSpan="4"/>
	            <field name="supplierOrderLineList" colSpan="4"/>
	            <field name="supplierInvoiceLineList" colSpan="4"/>
	            <field name="expenseLineList" colSpan="4"/>
	            <field name="timesheetLineList" colSpan="4"/>
	        </page>
	        <page title="Description" colSpan="4">
	            <field name="description" showTitle="false" colSpan="4"/>
	        </page>
	    </notebook>
	</form>
    
    <action-record name="action-task-default-record" model="com.axelor.apps.organisation.db.Task">
    	<field name="startDateT" expr="call:com.axelor.apps.base.service.administration.GeneralService:getTodayDateTime()" if="startDateT == null"/>
    	<field name="statusSelect" expr="eval: 1"/>
    	<field name="userInfo" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserInfo()"/>
    </action-record>
    
    <action-record name="action-task-salesOrderLine-on-change" model="com.axelor.apps.organisation.db.Task">
    	<field name="product" expr="eval:salesOrderLine?.product" if="salesOrderLine"/>
    	<field name="qty" expr="eval:salesOrderLine?.qty" if="salesOrderLine"/>
    	<field name="price" expr="eval:salesOrderLine?.price" if="salesOrderLine"/>
    </action-record>
    
    <action-record name="action-task-compute-total-planned-qty" model="com.axelor.apps.organisation.db.Task">
    	<field name="totalPlannedQty" expr="eval: planningLineList?.collect(){it?.duration}?.sum()" if="planningLineList != null"/>
    </action-record>
    
    <action-record name="action-task-compute-margin" model="com.axelor.apps.organisation.db.Task">
<!--     	<field name="initialBudgetMargin" expr="eval: (1-initialBudgetCost)/(initialBudgetTurnover)" if="initialBudgetCost != null &amp;&amp; initialBudgetTurnover != null"/> -->
<!--     	<field name="realizedBudgetMargin" expr="eval: (1-realizedBudgetCost)/(realizedTurnover)" if="realizedBudgetCost != null &amp;&amp; realizedTurnover != null"/> -->
<!--     	<field name="remainingBudgetMargin" expr="eval: (1-remainingBudgetCost)/(remainingTurnover)" if="remainingBudgetCost != null &amp;&amp; remainingTurnover != null"/> -->
<!--     	<field name="expectedFinalMargin" expr="eval: (1-expectedFinalCost)/(expectedFinalTurnover)" if="expectedFinalCost != null &amp;&amp; expectedFinalTurnover != null"/> -->
		<field name="initialBudgetMargin" expr="call:com.axelor.apps.organisation.service.TaskService:computeMargin(initialBudgetTurnover,initialBudgetCost)" if="initialBudgetCost != null &amp;&amp; initialBudgetTurnover != null"/>
		<field name="realizedBudgetMargin" expr="call:com.axelor.apps.organisation.service.TaskService:computeMargin(realizedTurnover,realizedBudgetCost)" if="realizedBudgetCost != null &amp;&amp; realizedTurnover != null"/>
		<field name="remainingBudgetMargin" expr="call:com.axelor.apps.organisation.service.TaskService:computeMargin(remainingTurnover,remainingBudgetCost)" if="remainingBudgetCost != null &amp;&amp; remainingTurnover != null"/>
		<field name="expectedFinalMargin" expr="call:com.axelor.apps.organisation.service.TaskService:computeMargin(expectedFinalTurnover,expectedFinalCost)" if="expectedFinalCost != null &amp;&amp; expectedFinalTurnover != null"/>
    </action-record>
    
</object-views>