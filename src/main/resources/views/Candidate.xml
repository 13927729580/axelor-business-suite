<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_0.9.xsd">


	<grid name="candidate-grid" title="Candidates" model="com.axelor.apps.organisation.db.Candidate">
		<field name="name" />
		<field name="firstName" />
		<field name="mobilePhone" />
		<field name="email"/>
		<field name="availabilitySelect" />
		<field name="availabilityDate" />
		<field name="currentJobKeyword" domain="self.typeSelect = '3'"/>
		<field name="searchedJobKeyword" domain="self.typeSelect = '3'"/>		
		<field name="salaryExpectation" />
		<button name="sendByEmail" title="Send by email" colSpan="1" onClick="action-send-by-email-with-template" icon="img/Mail.png"/>
	</grid>


	<form name="candidate-form" title="Candidate" model="com.axelor.apps.organisation.db.Candidate" cols="6" 
	onNew="action-record-candidate-default,action-method-candidate-default-record,action-attrs-candidate-recruitment-advancement" 
	onSave="action-organisation-candidate-save-record">
	    <toolbar>
	        <button name="showCandidate" title="Print CV" onClick="save,action-partner-method-show-candidate"/>
	        <button name="sendByEmail" title="Send email" onClick="save,action-send-by-email-with-template"/>
	        <button name="transformInEmployee" title="Transform into employee" onClick="save,action-candidate-method-transform-in-employee"/>
	    </toolbar>
	    <group colSpan="6" cols="6">
	        <group colSpan="1">
	            <field name="picture" showTitle="false" widget="image"/>
	        </group>
	        <group colSpan="5" cols="5">
	            <group title="Contact" colSpan="1" cols="1">
	                <field name="titleSelect" showTitle="false" placeholder="Civility"/>
	                <break/>
	                <field name="name" showTitle="false" css="highlight" placeholder="Name"/>
	                <break/>
	                <field name="firstName" showTitle="false" css="highlight" placeholder="First Name"/>
	                <break/>
	                <field name="currentJobKeyword" domain="self.typeSelect = '3'" placeholder="Function" form-view="keyword-profession-form" grid-view="keyword-profession-grid"/>
	            </group>
	            <group colSpan="4" cols="4">
	                <group title="Main Contact details" colSpan="2" cols="4">
	                    <field name="mobilePhone"/>
	                    <field name="fixedPhone"/>
	                    <field name="email" widget="Email"/>
	                    <break/>
	                    <field name="address" colSpan="4"/>
	                </group>
	                <group title="Search criterias" colSpan="2" cols="4">
	                    <field name="contractType"/>
	                    <field name="searchedJobKeyword" domain="self.typeSelect = '3'" form-view="keyword-profession-form" grid-view="keyword-profession-grid"/>
	                    <field name="relocationSelect"/>
	                    <field name="salaryExpectation"/>
	                    <field name="resume"/>
	                    <field name="coverLetter"/>
	                </group>
	            </group>
	        </group>
	    </group>
	    <notebook>
	        <page title="General" colSpan="6" cols="6">
	            <group title="Availability and Decision" colSpan="6" cols="6">
	                    <field name="availabilitySelect"/>
	                    <field name="availabilityDate"/>
	                    <field name="decisionDate"/>
	            </group>
	            <group title="Follow-up" colSpan="6" cols="6">
	                <group colSpan="4" cols="4">
	                    <field name="userInfo"/>
	                    <field name="recruitmentStatusSelect" readonly="true"/>
	                    <field name="globalEvaluation"/>
	                    <field name="createdOn" readonly="true"/>
	                </group>
	                <group colSpan="2" cols="4">
	                    <group hideIf="recruitmentStatusSelect == 8" colSpan="2">
	                        <button name="newCandidate" title="New candidate" showIf="recruitmentStatusSelect == 6 || recruitmentStatusSelect == 9" colSpan="6" onClick="action-record-recruitment-advancement,save,action-method-candidate-create-recruitment-process-line,action-record-candidate-reset-fields,save"/>
	                        <button name="preSelection" title="Pre-selected" showIf="recruitmentStatusSelect == 1" colSpan="6" onClick="action-record-recruitment-advancement,save,action-method-candidate-create-recruitment-process-line,action-record-candidate-reset-fields,save"/>
	                        <button name="firstInterview" title="1st Interview" showIf="recruitmentStatusSelect == 2" onClick="action-record-recruitment-advancement,save,action-method-candidate-create-recruitment-process-line,action-record-candidate-reset-fields,save"/>
	                        <button name="secondInterview" title="2nd Interview" showIf="recruitmentStatusSelect == 3" onClick="action-record-recruitment-advancement,save,action-method-candidate-create-recruitment-process-line,action-record-candidate-reset-fields,save"/>
	                        <button name="thirdInterview" title="3rd Interview" showIf="recruitmentStatusSelect == 4" onClick="action-record-recruitment-advancement,save,action-method-candidate-create-recruitment-process-line,action-record-candidate-reset-fields,save"/>
	                        <button name="rejectRecruitmentAdvancement" title="Rejected" showIf="recruitmentStatusSelect == 2 || recruitmentStatusSelect == 3 || recruitmentStatusSelect == 4 || etatCandidature == 5" onClick="action-record-button-reject,save,action-method-candidate-create-recruitment-process-line,action-record-candidate-reset-fields,save"/>
	                        <button name="proposeOfferRecruitmentAdvancement" title="Offer proposed" showIf="recruitmentStatusSelect == 3 || recruitmentStatusSelect == 4 || recruitmentStatusSelect == 5" onClick="action-record-candidate-propose-offer-recruitment-advancement,save,action-method-candidate-create-recruitment-process-line,action-record-candidate-reset-fields,save"/>
	                        <button name="acceptOfferRecruitmentAdvancement" title="Offer accepted" showIf="recruitmentStatusSelect == 7" onClick="action-record-candidate-propose-offer-recruitment-advancement,save,action-method-candidate-create-recruitment-process-line,action-record-candidate-reset-fields,save"/>
	                        <button name="rejectOfferRecruitmentAdvancement" title="Offer refused" showIf="recruitmentStatusSelect == 7" onClick="action-record-button-reject-offer,save,action-method-candidate-create-recruitment-process-line,action-record-candidate-reset-fields,save"/>
	                    </group>
	                    <break/>
	                    <field name="recruitementDate" showIf="recruitmentStatusSelect == 2 || recruitmentStatusSelect == 3 || recruitmentStatusSelect == 4"/>
	                </group>
	                <field name="note" colSpan="6"/>
	                <field name="recruitmentProcessAdvancementList" readonly="true" colSpan="6" grid-view="recruitment-candidate-process-advancement-grid"/>
	            </group>
	        </page>
	        <page title="Profile">
	            <group colSpan="6" cols="4">
	                <group title="Keywords" colSpan="2">
	                    <field name="toolKeywordSet" colSpan="2" widget="TagSelect[create=keyWord]" domain="self.typeSelect = '1'" form-view="keyword-tool-form" grid-view="keyword-tool-grid"/>
	                    <field name="fieldKeywordSet" colSpan="2" widget="TagSelect[create=keyWord]" domain="self.typeSelect = '2'" form-view="keyword-area-form" grid-view="keyword-area-grid"/>
	                    <field name="jobKeywordSet" colSpan="2" widget="TagSelect[create=keyWord]" domain="self.typeSelect = '3'" form-view="keyword-profession-form" grid-view="keyword-profession-grid"/>
	                </group>
	                <group title="Recruitment Type" colSpan="2" cols="2">
	                    <field name="recruitmentTypeSelect"/>
	                    <field name="macroCategorySelect"/>
	                    <field name="categorySelect"/>
	                </group>
	            </group>
	            <field name="positionList" colSpan="4"/>
	            <group title="Education/Trainings" colSpan="4" cols="4">
	                <field name="degree"/>
	                <field name="educationLevel"/>
	                <field name="trainingLineList" colSpan="4"/>
	            </group>
	        </page>
	        <page title="Evaluation">
	            <field name="evaluationLineList" colSpan="4" form-view="evaluation-line-form" grid-view="evaluation-line-grid"/>
	            <group colSpan="2">
		            <field name="evaluationGrade" readonly="true"/>
		            <button name="compute" title="Compute" onClick="save,action-organisation-candidate-evaluation-record"/>
	            </group>
	            <portlet action="chart:chart.candidate.evaluation" colSpan="2"/>
	        </page>
	        <page title="Additionnal information">
	            <field name="drivingLicence"/>
	            <field name="source"/>
	            <field name="personalInfo" hidden="true" widget="NestedEditor" form-view="personal-info-edit-form" summary-view="true"/>
	            <break/>
	        </page>
	        <page title="Competences">
	            <field name="competence" hidden="true" widget="NestedEditor" form-view="competence-edit-form" summary-view="true"/>
	        </page>
	        <page title="Other opportunities">
	            <field name="candidateOtherOpportunityList" form-view="candidate-other-opportunity-form" grid-view="candidate-other-opportunity-grid"/>
	        </page>
	    </notebook>
	</form>

	<action-record name="action-organisation-candidate-evaluation-record" model="com.axelor.apps.organisation.db.Candidate">
		<field name="evaluationGrade" expr="eval: evaluationLineList?.collect(){ it?.coefficient * it?.gradeSelect }?.sum() / evaluationLineList?.collect(){ it?.coefficient }?.sum()" />
	</action-record>

	<action-record name="action-organisation-candidate-save-record" model="com.axelor.apps.organisation.db.Candidate">
		<field name="toolKeywordSet" expr="eval: toolKeywordSet*.typeSelect = '0';toolKeywordSet" />
		<field name="fieldKeywordSet" expr="eval: fieldKeywordSet*.typeSelect = '1';fieldKeywordSet" />
		<field name="jobKeywordSet"	expr="eval: jobKeywordSet*.typeSelect = '2';jobKeywordSet" />
	</action-record>

	<action-method name="action-method-candidate-default-record">
		<call class="com.axelor.apps.organisation.web.CandidateController" method="onNew" />
	</action-method>
	
	<action-method name="action-partner-method-show-candidate">
		<call class="com.axelor.apps.organisation.web.CandidateController" method="showCandidate" />
	</action-method>
	
	<action-method name="action-candidate-method-transform-in-employee">
		<call class="com.axelor.apps.organisation.web.CandidateController" method="transformInEmployee"/>
	</action-method>

	<action-record name="action-record-recruitment-advancement" model="com.axelor.apps.organisation.db.Candidate">
		<field name="etatCandidature" expr="5" if="etatCandidature == 4"/>
		<field name="etatCandidature" expr="4" if="etatCandidature == 3"/>
		<field name="etatCandidature" expr="3" if="etatCandidature == 2"/>
		<field name="etatCandidature" expr="2" if="etatCandidature == 1"/>
		<field name="etatCandidature" expr="1" if="etatCandidature == 6"/>
		<field name="etatCandidature" expr="1" if="etatCandidature == 9"/>			
	</action-record>
	
	<action-record name="action-record-candidate-propose-offer-recruitment-advancement" model="com.axelor.apps.organisation.db.Candidate">
		<field name="etatCandidature" expr="8" if="etatCandidature == 7"/>
		<field name="etatCandidature" expr="7" if="etatCandidature == 5"/>
		<field name="etatCandidature" expr="7" if="etatCandidature == 4"/>
		<field name="etatCandidature" expr="7" if="etatCandidature == 3"/>
	</action-record>
	
	<action-record name="action-record-candidate-default" model="com.axelor.apps.organisation.db.Candidate">
		<field name="etatCandidature" expr="1" />
	</action-record>
	
	<action-record name="action-record-button-reject" model="com.axelor.apps.organisation.db.Candidate">
		<field name="etatCandidature" expr="6" />
	</action-record>
	
	<action-record name="action-record-button-reject-offer" model="com.axelor.apps.organisation.db.Candidate">
		<field name="etatCandidature" expr="9" />
	</action-record>

	<action-record name="action-record-candidate-reset-fields" model="com.axelor.apps.organisation.db.Candidate">
		<field name="recruitementDate" expr=""/>
		<field name="commentaire" expr=""/>
	</action-record>
	
	<action-method name="action-method-candidate-create-recruitment-process-line">
		<call class="com.axelor.apps.organisation.web.CandidateController" method="createRecruitmentProcessAdvancementLine" />
	</action-method>
	
	<chart name="chart.candidate.evaluation" title="Grade by skills">
			<dataset type="jpql">
			    <![CDATA[
			    SELECT
				    evaluationLine.label as label,
				    sum(evaluationLine.gradeSelect) as grade
				FROM
				    EvaluationLine evaluationLine
				WHERE 
				    evaluationLine.candidate.id = :id
				GROUP BY evaluationLine.label
				  ]]>
		    </dataset>
		    <category key="label" type="text"/>
		    <series key="grade" type="bar"/>
		</chart>

</object-views>