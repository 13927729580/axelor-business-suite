<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_0.9.xsd">
    
    <grid name="sales-order-grid" title="Sale orders" model="com.axelor.apps.supplychain.db.SalesOrder">
        <field name="salesOrderSeq"/>
        <field name="company"/>
        <field name="currency"/>
        <field name="clientReference"/>
        <field name="creationDate"/>
        <field name="inTaxTotal"/>
    </grid>
    
	<form name="sales-order-form" title="Sale order" model="com.axelor.apps.supplychain.db.SalesOrder" cols="4" onNew="action-sales-order-record-default,action-sales-order-record-currency,action-sales-order-attrs-collapse-specific-settings-group"
	onSave="action-sales-order-set-sequence" onLoad="action-sales-order-attrs-collapse-specific-settings-group">
	    <toolbar>
	        <button name="createDocument" title="Create Document" onClick="com.axelor.apps.supplychain.web.SalesOrderController:saveDocumentForOrder"/>
	    </toolbar>
	    <group colSpan="3" cols="4" colWidths="17%,33%,17%,33%">
	        <field name="salesOrderSeq"/>
	        <field name="company"/>
	        <field name="affairProject"/>
	        <field name="currency"/>
	        <field name="externalReference"/>
	        <field name="creationDate"/>
	    </group>
	    <group colSpan="1" cols="1">
	        <field name="statusSelect" widget="NavSelect"/>
	        <button name="showInvoice" title="Show Invoices" colSpan="1" onClick="action-sales-order-view-invoice" showIf="statusSelect == 3"/>
	    </group>
	    <notebook colSpan="4">
	        <page title="Customer information">
	            <field name="clientPartner" onChange="action-sales-order-record-partner" domain="self.isContact = 'false'"/>
	            <field name="contactPartner" domain="self.isContact = 'true'"/>
	            <field name="mainInvoicingAddress"/>
	            <field name="deliveryAddress"/>
	            <field name="invoicingTypeSelect"/>
	            <field name="priceList" domain="self.typeSelect = 1 and (self.partner = null or self.partner = :clientPartner)"/>
	            <group title="Specific settings" name="specificSettings" canCollapse="true" colSpan="4">
	                <separator title="Sale order Settings" colSpan="4"/>
	                    <field name="isToPrintLineSubTotal"/>
	                    <field name="project" showIf="hasToCreateTaskByLine"/>
	                <separator title="Sale order lines Settings" colSpan="4"/>
	                    <field name="hasToCreateTaskByLine"/>
	                    <field name="hasToCreateMoByLine"/>
	                    <field name="hasToCreateProposal"/>
	            </group>
	            <break/>
	            <separator title="Sale order content" colSpan="4"/>
	            <field name="salesOrderLineList" colSpan="4"/>
	            
	            <group showTitle="false" colSpan="4" cols="3">
	                <group title="-" colSpan="2" cols="2">
	                    <field name="salesOrderLineVatList" showTitle="false" colSpan="2"/>
	                    <group title="Action(s)" colSpan="2" cols="2">
	                        <group colSpan="1" cols="1">
	                            <button name="compute" title="Compute" hideIf="statusSelect == 3" colSpan="1" onClick="save,action-sales-order-method-compute,save"/>
	                            <button name="confirm" title="Confirm" showIf="statusSelect == 1 || statusSelect == 4" colSpan="1" onClick="save,action-sales-order-record-confirm,save"/>
	                            <button name="validate" title="Validate" showIf="statusSelect == 2" colSpan="1" onClick="action-sales-order-button-validation,save,action-sales-order-record-validate,save,action-sales-order-create-tasks"/>
	                            <button name="cancel" title="Cancel" showIf="statusSelect == 1 || statusSelect == 2" colSpan="1" onClick="save,action-sales-order-record-cancel"/>
	                            <button name="showSalesOrder" title="Print" showIf="statusSelect == 3" colSpan="1" icon="img/icons/print.png" onClick="save,action-sales-order-method-show-sales-order"/>
	                            <button name="sendByEmail" title="Send by email" showIf="statusSelect == 3" colSpan="1"/>
	                    </group>
	                    <group readonly="true" colSpan="1" cols="2">
	                        <field name="validatedByUserInfo" colSpan="1"/>
	                        <field name="validationDate" colSpan="1"/>
	                    </group>
	                </group>
	                </group>
	                <group title="Totaux" colSpan="1" cols="1">
	                    <group readonly="true" colSpan="1" css="subtotal" cols="2" colWidths="50%,50%">
	                        <field name="exTaxTotal"/>
	                        <field name="vatTotal"/>
	                        <field name="inTaxTotal" css="subtotal-total"/>
	                        <field name="amountRemainingToBeInvoiced"/>
	                    </group>
	                </group>
	            </group>
	        </page>
	        <page title="Other informations">
	            <group title="Sales follow-up" colSpan="4">
		            <field name="salesmanUserInfo"/>
		            <field name="team" onSelect="action-sales-order-domain-on-team"/>
	            </group>
	            <group title="Financial terms" colSpan="4">
		            <field name="paymentMode"/>
		            <field name="paymentCondition"/>
	            </group>
	            <group title="Marketing" colSpan="4">
		            <field name="source"/>
	            </group>
	        </page>
	        <page title="Payment schedule">
	            <field name="invoicingMomentSelect" colSpan="3"/>
	            <field name="salesOrderScheduleLineList" colSpan="4"/>
	        </page>
	        <page title="Invoicing" showIf="statusSelect == 3">
	            <field name="invoiceSet" colSpan="4"/>
	        </page>
	        <page title="Customer order">
	            <field name="orderDate"/>
	            <field name="orderNumber"/>
	            <button name="generateInvoice" title="Generate invoice" colSpan="2" onClick="save,action-sales-order-method-generate-invoice"/>
	            <button name="generateProject" title="Generate project" colSpan="2"/>
	        </page>
	    </notebook>
    </form>
    
    <action-attrs name="action-sales-order-domain-on-team">
    	<attribute name="domain" for="team" expr="eval: salesmanUserInfo?.teamSet?.collect{it.id}?.size() > 0 ? &quot;self.id IN (${salesmanUserInfo?.teamSet?.collect{it.id}?.join(',')})&quot; : null"/>
    </action-attrs>
    
    <action-method name="action-sales-order-method-show-sales-order">
		<call class="com.axelor.apps.supplychain.web.SalesOrderController" method="showSalesOrder"/>
	</action-method>
    
    <action-record name="action-sales-order-record-confirm" model="com.axelor.apps.supplychain.db.SalesOrder">
    	<field name="statusSelect" expr="eval: 2"/>
    </action-record>
    
    <action-record name="action-sales-order-record-validate" model="com.axelor.apps.supplychain.db.SalesOrder">
    	<field name="statusSelect" expr="eval: 3"/>
    	<field name="validationDate" expr="eval: __date__"/>
    </action-record>
    
     <action-record name="action-sales-order-record-cancel" model="com.axelor.apps.supplychain.db.SalesOrder">
    	<field name="statusSelect" expr="eval: 4"/>
    </action-record>
    
    <action-record name="action-sales-order-record-currency" model="com.axelor.apps.supplychain.db.SalesOrder">
	    <field name="currency" expr="eval: company?.currency"/>
	</action-record>
    
    <action-record name="action-sales-order-record-default" model="com.axelor.apps.supplychain.db.SalesOrder">
    	<field name="creationDate" expr="eval: __date__"/>
    	<field name="statusSelect" expr="eval: 1"/>
    	<field name="company"  expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserActiveCompany()"/>
    	<field name="invoicingTypeSelect" expr="eval: 6"/>
    	<field name="salesmanUserInfo" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserInfo()"/>
    	<field name="team" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserActiveTeam()"/>
    </action-record>
    
    <action-record name="action-sales-order-record-partner" model="com.axelor.apps.supplychain.db.SalesOrder">
    	<field name="paymentCondition" expr="eval: clientPartner?.paymentCondition"/>
 		<field name="currency" expr="eval: clientPartner?.currency"/>
 		<field name="paymentMode" expr="eval: clientPartner?.paymentMode"/>
 		<field name="mainInvoicingAddress" expr="eval: clientPartner?.mainInvoicingAddress"/>
		<field name="deliveryAddress" expr="eval: clientPartner?.deliveryAddress"/>
    </action-record>
    
    <action-method name="action-sales-order-method-compute">
    	<call class="com.axelor.apps.supplychain.web.SalesOrderController" method="compute"/>
    </action-method>
    
    <action-method name="action-sales-order-method-generate-invoice">
 		<call class="com.axelor.apps.supplychain.web.SalesOrderInvoiceController" method="generateInvoice"/>
	</action-method>
	
	<action-method name="action-sales-order-set-sequence">
		<call class="com.axelor.apps.supplychain.web.SalesOrderController" method="setSequence"/>
	</action-method>
	
	 <action-view name="action-sales-order-view-invoice" title="Invoices" model="com.axelor.apps.account.db.Invoice">
		<view type="grid" name="invoice-grid"/>
		<view type="form" name="invoice-form"/>
		<domain>self.id IN :invoiceSet</domain>
	</action-view>
	
	<action-attrs name="action-sales-order-attrs-collapse-specific-settings-group">
		<attribute name="collapse" for="specificSettings" expr="eval: true"/>
	</action-attrs>
    
    <action-validate name="action-sales-order-button-validation">
   		<error message="Project must be filled if create task by line is check." if="hasToCreateTaskByLine &amp;&amp; project == null"/>
	</action-validate> 
	
	<action-method name="action-sales-order-create-tasks">
		<call class="com.axelor.apps.supplychain.web.SalesOrderController" method="createTaskByLines"/>
	</action-method>
	
</object-views>
