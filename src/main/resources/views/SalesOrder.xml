<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_0.9.xsd">
    
    <grid name="sales-order-grid" title="Sale orders" model="com.axelor.apps.supplychain.db.SalesOrder">
        <field name="salesOrderSeq"/>
        <field name="company"/>
        <field name="currency"/>
        <field name="clientReference"/>
        <field name="creationDate"/>
        <field name="inTaxTotal"/>
    </grid>
    
	<form name="sales-order-form" title="Sale order" model="com.axelor.apps.supplychain.db.SalesOrder" cols="4" onNew="action-sales-order-record-default,action-sales-order-record-currency"
	onSave="action-sales-order-set-sequence">
		<toolbar>
		    <!--  Use this button to create document for the current entity using the template, u have to define the controller for it... -->
		    <button name="createDocument" title="Create Document" onClick="com.axelor.apps.supplychain.web.SalesOrderController:saveDocumentForOrder" />
		</toolbar>
    	<group colSpan="3" cols="4" colWidths="17%,33%,17%,33%">
	    	<field name="salesOrderSeq"/>
			<field name="company"/>
	    	<field name="affairProject"/>
	    	<field name="currency"/>
	    	<field name="externalReference"/>
	    	<field name="creationDate"/>
<!--  	    	<field name="RÃ©cuperer les informations de l'affaire"/>-->
        </group>
        <group colSpan="1" cols="1" >
        	<field name="statusSelect" widget="NavSelect"/>
        	<button name="showInvoice" title="Les factures" colSpan="1" onClick="action-sales-order-view-invoice"/>
        </group>
        <notebook colSpan="4">
        	<page title="Customer information">
        		<field name="clientPartner" domain="self.isContact = 'false'" onChange="action-sales-order-record-partner"/>
        		<field name="contactPartner" domain="self.isContact = 'true'"/>
        		<field name="mainInvoicingAddress"/>
        		<field name="priceList"/>
        		<field name="deliveryAddress"/>
        		<field name="isToPrintLineSubTotal"/>
<!--         		<field name="hasSubLineDefaultValue"/> -->
				<field name="hasToCreateProject"/>
				<field name="project" hideIf="!hastToCreateProject"/>
        		<field name="invoicingTypeSelect"/>
        		<break/>
        		<separator title="Sale order content" colSpan="4"/>
        		<field name="hasToCreateTaskByLine"/>
        		<field name="hasToCreateProposal"/>
        		<field name="salesOrderLineList" colSpan="4"/>
        		<field name="salesOrderLineVatList" colSpan="4"/>
        		<group colSpan="4" cols="3" noLabel="true">
	        		<group colSpan="2" cols="2" title="Action(s)">
	        			<group colSpan="1" cols="1">
	        				<button name="compute" title="Compute" colSpan="1" onClick="save,action-sales-order-method-compute,save" hideIf="statusSelect == 3"/>
			                <button name="confirm" title="Confirm" colSpan="1" onClick="save,action-sales-order-record-confirm,save" showIf="statusSelect == 1 || statusSelect == 4"/>
			                <button name="validate" title="Validate" colSpan="1" onClick="save,action-sales-order-record-validate,save" showIf="statusSelect == 2"/>
			                <button name="cancel" title="Cancel" colSpan="1" onClick="save,action-sales-order-record-cancel" showIf="statusSelect == 1 || statusSelect == 2"/>
			                <button name="showSalesOrder" title="Print" colSpan="1" onClick="save,action-sales-order-method-show-sales-order" icon="img/icons/print.png" showIf="statusSelect == 3"/>
			                <button name="sendByEmail" title="Send by email" colSpan="1" showIf="statusSelect == 3"/>
	        			</group>
	        			<group colSpan="1" cols="2" readonly="true">
	        				<field name="validatedByUserInfo" colSpan="1"/>
		                	<field name="validationDate" colSpan="1"/>
	        			</group>
        			</group>
        			<group colSpan="1" cols="1" title="Totaux">
		        		<group colSpan="1" css="subtotal" cols="2" colWidths="50%,50%" readonly="true">
		        			<field name="exTaxTotal"/>
		        			<field name="vatTotal"/>
		        			<field name="inTaxTotal" css="subtotal-total"/>
		        			<field name="amountRemainingToBeInvoiced"/>
		        		</group>
	        		</group>
        		</group>
        	</page>
        	<page title="Other informations">
        		<field name="salesmanUserInfo"/>
        		<field name="team" onSelect="action-sales-order-domain-on-team"/>
        		<field name="paymentMode"/>
        		<field name="paymentCondition"/>
        		<field name="source"/>
        	</page>
        	<page title="Payment schedule">
        		<field name="invoicingMomentSelect" colSpan="3"/>
        		<field name="salesOrderScheduleLineList" colSpan="4"/>
        	</page>
        	<page title="Invoicing">
        		<field name="invoiceSet" colSpan="4"/>
        	</page>
        	<page title="Customer order">
        		<field name="orderDate"/>
        		<field name="orderNumber"/>
        		<button name="generateInvoice" title="Generate invoice" onClick="save,action-sales-order-method-generate-invoice" colSpan="2"/>
        		<button name="generateProject" title="Generate project" colSpan="2"/>
        	</page>
        
        </notebook>
    </form>
    
    <action-attrs name="action-sales-order-domain-on-team">
    	<attribute name="domain" for="team" expr="eval: salesmanUserInfo?.teamSet?.collect{it.id}?.size() > 0 ? &quot;self.id IN (${salesmanUserInfo?.teamSet?.collect{it.id}?.join(',')})&quot; : null"/>
    </action-attrs>
    
    <action-method name="action-sales-order-method-show-sales-order">
		<call class="com.axelor.apps.supplychain.web.SalesOrderController" method="showSalesOrder"/>
	</action-method>
    
    <action-record name="action-sales-order-record-confirm" model="com.axelor.apps.supplychain.db.SalesOrder">
    	<field name="statusSelect" expr="eval: 2"/>
    </action-record>
    
    <action-record name="action-sales-order-record-validate" model="com.axelor.apps.supplychain.db.SalesOrder">
    	<field name="statusSelect" expr="eval: 3"/>
    	<field name="validationDate" expr="eval: __date__"/>
    </action-record>
    
     <action-record name="action-sales-order-record-cancel" model="com.axelor.apps.supplychain.db.SalesOrder">
    	<field name="statusSelect" expr="eval: 4"/>
    </action-record>
    
    <action-record name="action-sales-order-record-currency" model="com.axelor.apps.supplychain.db.SalesOrder">
	    <field name="currency" expr="eval: company?.currency"/>
	</action-record>
    
    <action-record name="action-sales-order-record-default" model="com.axelor.apps.supplychain.db.SalesOrder">
    	<field name="creationDate" expr="eval: __date__"/>
    	<field name="statusSelect" expr="eval: 1"/>
    	<field name="company"  expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserActiveCompany()"/>
    	<field name="invoicingTypeSelect" expr="eval: 6"/>
    	<field name="salesmanUserInfo" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserInfo()"/>
    	<field name="team" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserActiveTeam()"/>
    </action-record>
    
    <action-record name="action-sales-order-record-partner" model="com.axelor.apps.supplychain.db.SalesOrder">
    	<field name="paymentCondition" expr="eval: clientPartner?.paymentCondition"/>
 		<field name="currency" expr="eval: clientPartner?.currency"/>
 		<field name="paymentMode" expr="eval: clientPartner?.paymentMode"/>
 		<field name="mainInvoicingAddress" expr="eval: clientPartner?.mainInvoicingAddress"/>
		<field name="deliveryAddress" expr="eval: clientPartner?.deliveryAddress"/>
    </action-record>
    
    <action-method name="action-sales-order-method-compute">
    	<call class="com.axelor.apps.supplychain.web.SalesOrderController" method="compute"/>
    </action-method>
    
    <action-method name="action-sales-order-method-generate-invoice">
 		<call class="com.axelor.apps.supplychain.web.SalesOrderInvoiceController" method="generateInvoice"/>
	</action-method>
	<action-method name="action-sales-order-set-sequence">
		<call class="com.axelor.apps.supplychain.web.SalesOrderController" method="setSequence"/>
	</action-method>
	 <action-view name="action-sales-order-view-invoice" title="Invoices" model="com.axelor.apps.account.db.Invoice">
		<view type="grid" name="invoice-grid"/>
		<view type="form" name="invoice-form"/>
		<domain>self.id IN :invoiceSet</domain>
	</action-view>
    
</object-views>
