<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_0.9.xsd">
    
    <grid name="event-grid" title="Events" model="com.axelor.apps.crm.db.Event" orderBy="startDateTime">
    	<toolbar>
    		<button name="exportCalendar" title="Export calendar" onClick="com.axelor.apps.crm.web.CalendarController:exportCalendar" colSpan="1"/>
    		<button name="importCalendar" title="Import calendar" onClick="com.axelor.apps.crm.web.CalendarController:importCalendar" colSpan="1"/>
    		<button name="synchronizeCalendars" title="Synchronize calendar" onClick="com.axelor.apps.crm.web.CalendarController:synchronizeCalendars" colSpan="1"/>
    	</toolbar>
        <field name="typeSelect"/>
        <field name="subject"/>
        <field name="startDateTime"/>
        <field name="durationHours"/>
        <field name="userInfo"/>
        <field name="team"/>
    </grid>
    
    
    <calendar name="event-calendar" title="Meetings" mode="month" colorBy="calendar" 
    	eventStart="startDateTime" eventStop="endDateTime" eventLength="1" model="com.axelor.apps.crm.db.Event">
    	<field name="subject" />
 	</calendar>
    
    <form name="event-form" title="Events" model="com.axelor.apps.crm.db.Event">
    	<toolbar>
    		<button name="exportCalendar" title="Export calendar" onClick="com.axelor.apps.crm.web.CalendarController:exportCalendar" colSpan="1"/>
    		<button name="importCalendar" title="Import calendar" onClick="com.axelor.apps.crm.web.CalendarController:importCalendar" colSpan="1"/>
    		<button name="synchronizeCalendars" title="Synchronize calendars" onClick="com.axelor.apps.crm.web.CalendarController:synchronizeCalendars" colSpan="1"/>
    	</toolbar>
        <group title="Informations" cols="4" colSpan="1">
        	<field name="subject" colSpan="2"/>
	        <field name="eventStatusSelect" colSpan="2"/>
	        <field name="clientPartner"/>
        	<field name="contactPartner"/>
	        <spacer/><break/>
	        <group title="Event dates" colSpan="4" cols="4" colWidths="25*" css="groupTitle">
	        <label title="Duration" colSpan="1"/>
		        <field name="startDateTime" onChange="action-meeting-method-compute-start-date-time"/>
		        <field name="endDateTime" onChange="action-meeting-method-compute-end-date-time"/>
		        <field name="durationHours" placeholder="Hours" onChange="action-meeting-method-compute-duration"/>
		        <field name="durationMinutesSelect" showTitle="false" placeholder="Minutes" colSpan="1"/>
	        </group>
	        <spacer/><break/>
	        <field name="description" widget="TEXT[height=4]" colSpan="4"/>
	        <group title="Reminders" colSpan="2" cols="2">
	        	<field name="eventReminderList" widget="MasterDetail" colSpan="2" showTitle="false"/>
	        </group>
        </group>
        <group title="Related to" colSpan="1" cols="2">
	        <field name="relatedToSelect" widget="RefSelect[related=relatedToSelectId]"/>
        </group>
        <group title="Assignment" cols="4" colSpan="2" canCollapse="true">
	        <field name="userInfo"/>
	    	<field name="team" readonlyIf="!userInfo" onSelect="action-event-attrs-team-domain"/>
        </group>
        <group title="Attendees" cols="4" colSpan="2" canCollapse="true">
        	<field name="contactEventAttendeeList" grid-view="event-attendee-contact-grid" form-view="event-attendee-contact-form" colSpan="4"/>
        	<field name="leadEventAttendeeList" grid-view="event-attendee-lead-grid" form-view="event-attendee-lead-form" colSpan="4"/>
        </group>
        <field name="calendar" widget="SuggestBox"/>
        <field name="calendarEventUid"/>
        
<!--         A completer -->
    </form>
    
    
    <grid name="call-grid" title="Calls" model="com.axelor.apps.crm.db.Event" orderBy="-startDateTime">
        <field name="subject"/>
        <field name="callStatusSelect"/>
        <field name="statusSelect"/>
        <field name="startDateTime"/>
        <field name="relatedToSelect"/>
    </grid>
    
    <form name="call-form" title="Call" model="com.axelor.apps.crm.db.Event" cols="2" colWidths="*,400"
    	onNew="action-event-new-record">
        <group title="Informations" cols="4" colSpan="1">
        	<field name="subject" colSpan="2"/>
	        <field name="callStatusSelect" colSpan="2"/>
	        <field name="statusSelect" showTitle="false" colSpan="1"/>
	        <field name="clientPartner"/>
        	<field name="contactPartner"/>
	        <spacer/><break/>
	        <group title="Call date" colSpan="4" cols="3" css="groupTitle">
	        	<field name="startDateTime" colSpan="2"/>
	         	<field name="durationHours" placeholder="Hours" colSpan="2"/>
		        <field name="durationMinutesSelect" showTitle="false" placeholder="Minutes" colSpan="1"/>
	        </group>
	        <spacer/><break/>
	        <field name="description" widget="TEXT[height=4]" colSpan="4"/>
	        <group title="Reminders" colSpan="4" cols="2">
	        	<field name="eventReminderList" widget="MasterDetail" colSpan="2" showTitle="false"/>
	        </group>
        </group>
        <group title="Related to" colSpan="1" cols="2">
	        <field name="relatedToSelect" widget="RefSelect[related=relatedToSelectId]"/>
        </group>
        <group title="Assignment" cols="4" colSpan="2" canCollapse="true">
	        <field name="userInfo"/>
	    	<field name="team" readonlyIf="!userInfo" onSelect="action-event-attrs-team-domain"/>
        </group>
        <group title="Attendees" cols="4" colSpan="2" canCollapse="true">
        	<field name="contactEventAttendeeList" grid-view="event-attendee-contact-grid" form-view="event-attendee-contact-form" colSpan="4"/>
        	<field name="leadEventAttendeeList" grid-view="event-attendee-lead-grid" form-view="event-attendee-lead-form" colSpan="4"/>
        </group>
    </form>
    
  <calendar name="meeting-calendar" title="Meetings" mode="month" colorBy="userInfo" 
    eventStart="startDateTime" 
    eventStop="endDateTime" 
    eventLength="1">
    <field name="subject" />
  </calendar>
    
    
    <grid name="meeting-grid" title="Meetings" model="com.axelor.apps.crm.db.Event" orderBy="-startDateTime">
        <field name="subject"/>
        <field name="statusSelect"/>
        <field name="startDateTime"/>
        <field name="relatedToSelect"/>
    </grid>
    
    <form name="meeting-form" title="Meeting" model="com.axelor.apps.crm.db.Event" cols="2" colWidths="*,400"  
    onNew="action-event-new-record">
	    <field name="subject" showTitle="false" css="highlight" placeholder="Subject" colSpan="4"/>
	    <group title="Informations" colSpan="2" cols="4">
	        <field name="statusSelect"/>
	        <field name="meetingType"/>
	        <field name="clientPartner"/>
        	<field name="contactPartner"/>
	        <spacer/>
	        <break/>
	        <group title="Meeting dates" colSpan="2" css="groupTitle" cols="2" colWidths="50%,50%">
	            <group colSpan="1" cols="2">
	            	<separator title="Start/End dates" colSpan="2"/>
	            	<field name="startDateTime" onChange="action-meeting-method-compute-start-date-time"/>
	            	<field name="endDateTime" onChange="action-meeting-method-compute-end-date-time"/>
	            </group>
	            <group colSpan="1" cols="3">
	            	<separator title="Duration" colSpan="3"/>
	                <field name="durationHours" showTitle="false" onChange="action-meeting-method-compute-duration" colSpan="1" />
	                <label title=":" colSpan="1"/>
	                <field name="durationMinutesSelect" showTitle="false" colSpan="1"/>
	            </group>
	        </group>
	        <group title="Reminders" colSpan="2" cols="2">
	        	<field name="eventReminderList" widget="MasterDetail" colSpan="2" showTitle="false"/>
	        </group>
	        <spacer/>
	        <break/>
	        <field name="location"/>
	        <field name="description" colSpan="4" widget="TEXT[height=4]"/>
	    </group>
	    <group title="Related to" colSpan="2" cols="2">
	        <field name="relatedToSelect" widget="RefSelect[related=relatedToSelectId]"/>
	    </group>
	    <group title="Assigned to" colSpan="2" cols="4" canCollapse="true">
	        <field name="userInfo"/>
	        <field name="team" readonlyIf="!userInfo" onSelect="action-event-attrs-team-domain"/>
	    </group>
	    <group title="Attendees" colSpan="2" cols="4" canCollapse="true">
	    	<group colSpan="2" cols="4">
	    		<separator title="Contacts" colSpan="4"/>
	    	 	<field name="contactEventAttendeeList" colSpan="4" form-view="event-attendee-contact-form" grid-view="event-attendee-contact-grid" showTitle="false"/>
	    	</group>
	       	<group colSpan="2" cols="4">
	       		<separator title="Leads" colSpan="4"/>
	        	<field name="leadEventAttendeeList" colSpan="4" form-view="event-attendee-lead-form" grid-view="event-attendee-lead-grid" showTitle="false"/>
	        </group>
	    </group>
	</form>
    
    <grid name="crm-task-grid" title="Tasks" model="com.axelor.apps.crm.db.Event" orderBy="-startDateTime">
        <field name="subject"/>
        <field name="taskStatusSelect"/>
        <field name="startDateTime"/>
        <field name="relatedToSelect"/>
    </grid>
    
    <form name="crm-task-form" title="Task" model="com.axelor.apps.crm.db.Event" cols="2" colWidths="*,400"
    	onNew="action-event-new-record">
        <group title="Informations" cols="4" colSpan="1">
        	<field name="subject"/>
	        <field name="taskStatusSelect"/>
	        <field name="clientPartner"/>
        	<field name="contactPartner"/>
	        <spacer/><break/>
         	<group title="Task date" colSpan="4" cols="4" colWidths="25*" css="groupTitle">
		        <field name="startDateTime" onChange="action-meeting-method-compute-start-date-time"/>
		        <field name="endDateTime" onChange="action-meeting-method-compute-end-date-time"/>
		        <field name="durationHours" placeholder="Hours" onChange="action-meeting-method-compute-duration"/>
	        </group>
	        <spacer/><break/>
	        <group title="Reminders" colSpan="4" cols="2">
	        	<field name="eventReminderList" widget="MasterDetail" colSpan="2" showTitle="false"/>
	        </group>
	        <field name="prioritySelect"/>
	        <field name="description" widget="TEXT[height=4]" colSpan="4"/>
        </group>
        <group title="Related to" colSpan="1" cols="2">
	        <field name="relatedToSelect" widget="RefSelect[related=relatedToSelectId]"/>
        </group>
        <group title="Assigned to" cols="4" colSpan="2" canCollapse="true">
	        <field name="userInfo"/>
	    	<field name="team" readonlyIf="!userInfo" onSelect="action-event-attrs-team-domain"/>
        </group>
        <group title="Attendees" cols="4" colSpan="2" canCollapse="true">
        	<field name="contactEventAttendeeList" grid-view="event-attendee-contact-grid" form-view="event-attendee-contact-form" colSpan="4"/>
        	<field name="leadEventAttendeeList" grid-view="event-attendee-lead-grid" form-view="event-attendee-lead-form" colSpan="4"/>
        </group>
    </form>
    
    
     <grid name="ticket-grid" title="Ticket" model="com.axelor.apps.crm.db.Event" orderBy="ticketNumberSeq">
     	<field name="ticketNumberSeq"/>
        <field name="subject"/>
        <field name="ticketStatusSelect"/>
        <field name="eventCategory"/>
        <field name="startDateTime"/>
        <field name="prioritySelect"/>
        <field name="userInfo"/>
        <field name="description"/>
        <field name="progressSelect" widget="SelectProgress"/>
    </grid>
    
    <form name="ticket-form" title="Ticket" model="com.axelor.apps.crm.db.Event" cols="6" colWidths="*,400"
    	onNew="action-event-new-record,action-event-ticket-attrs-default,action-event-record-ticket-status-select,action-event-record-progress-select"
    	onLoad="action-event-ticket-attrs-default"
    	onSave="action-event-set-sequence">
    	<field name="subject" showTitle="false" css="highlight" placeholder="Subject" colSpan="4"/>
    	<group colSpan="6" cols="6"  colWidths="16%,17%,16%,17%,16%,18%">
	    	<field name="ticketNumberSeq" readonly="true"/>
	       	<field name="eventCategory" domain="self.typeSelect = :typeSelect"/>
	       	<field name="ticketStatusSelect"/>
	       	<field name="prioritySelect"/>
			<field name="progressSelect" widget="SelectProgress"/>
	        <break/>
    	</group>
    	<group colSpan="6" cols="6">
   			<group title="Ticket date" colSpan="2" cols="2" colWidths="40%,60%">
		        <field name="startDateTime"/>
		        <field name="endDateTime" title="DeadLine"/>
		        <group colSpan="2" cols="3">
	            	<separator title="Estimated duration" colSpan="3"/>
	                <field name="durationHours" placeholder="Hours" showTitle="false" onChange="action-meeting-method-compute-duration" colSpan="1" />
	                <label title=":" colSpan="1"/>
	                <field name="durationMinutesSelect" placeholder="Minutes" showTitle="false" colSpan="1"/>
	            </group>
	        </group>
	        <group title="Related to" colSpan="2" cols="2"  colWidths="40%,60%">
	        	<field name="clientPartner"/>
	        	<field name="contactPartner"/>
	        	<field name="project" required="true" form-view="project-form" domain="self.clientPartner = :clientPartner || self.contactPartner = :contactPartner || (:contactPartner = null &amp;&amp; :clientPartner = null)"/>
	        	<field name="task" domain="self.project = :project"/>
	        </group>
	        <group colSpan="2" cols="2"  colWidths="40%,60%">
	        	<field name="createdBy" readonly="true"/>
	        	<field name="userInfo" onChange="action-event-record-ticket-responsible-user-info"/>
	        	<field name="responsibleUserInfo"/>
	        </group>
    	</group>
        <notebook colSpan="6">
        	<page title="Description" >
        		<field name="description" widget="Html[lite=true]" showTitle="false" colSpan="6"/>
        	</page>
        	<page title="Comments">
        		<field name="messageList" showTitle="false" colSpan="6">
        			<form title="Comment">
        				<group title="Informations" colSpan="4" readonly="true">
				            <field name="sendedDate"/>
				            <field name="sender"/>
				        </group>
				        <group title="Content" colSpan="4">
				       	 	<field name="content" colSpan="4" showTitle="false" widget="Html[lite=true]"/>
				        </group>
        			</form>
        			<grid title="Comments">
			            <field name="sendedDate"/>
			            <field name="sender"/>
			       	 	<field name="content" colSpan="4" showTitle="false" widget="Html[lite=true]"/>
        			</grid>
        		</field>
        	</page>
        	<page title="Watchers">
        		<field name="userInfoSet" widget="TagSelect" showTitle="false" colSpan="6" onSelect="action-event-attrs-watchers-domain"/>
        	</page>
        	<page title="Past times" showIf="task != null">
        		<field name="pastTimeList" showTitle="false" colSpan="6" grid-view="past-time-ticket-grid" form-view="past-time-ticket-form"/>
        	</page>
        </notebook>
    </form>
    
    <action-attrs name="action-event-attrs-watchers-domain">
    	<attribute name="domain" for="userInfoSet" expr="eval: &quot; self.id IN (${project?.memberUserInfoSet?.collect{it.id}.join(',')})&quot;" if="project?.memberUserInfoSet?.collect{it.id}?.size() > 0"/>
    	<attribute name="domain" for="userInfoSet" expr="eval:" if="project?.memberUserInfoSet?.collect{it.id}?.size() == 0"/>
    </action-attrs>
    
    <action-record name="action-event-default-record-userinfo" model="com.axelor.apps.crm.db.Event">
    	<field name="userInfo" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserInfo()" if="typeSelect == 1 || typeSelect == 2 || typeSelect == 3"/>
   		<field name="team" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserActiveTeam()"/>
    </action-record>
    
    <action-record name="action-event-record-ticket-responsible-user-info" model="com.axelor.apps.crm.db.Event">
    	<field name="responsibleUserInfo" expr="eval: userInfo" if="responsibleUserInfo == null"/>
    </action-record>
    
    <action-attrs name="action-event-attrs-team-domain">
    	<attribute name="domain" for="team" expr="eval: &quot;self.id IN (${userInfo?.teamSet?.collect{it.id}.join(',')})&quot;" if="userInfo?.teamSet?.collect{it.id}?.size() > 0"/>
    </action-attrs>
    
    <action-record name="action-event-default-record" model="com.axelor.apps.crm.db.Event">
    	<field name="startDateTime" expr="eval: __time__" if="startDateTime == null"/>
    	<field name="typeSelect" expr="eval: _typeSelect"/>
    </action-record>
    
    <action-method name="action-meeting-method-compute-start-date-time">
    	<call class="com.axelor.apps.crm.web.EventController" method="computeStartDateTime"/>
    </action-method>
    
    <action-method name="action-event-set-sequence">
		<call class="com.axelor.apps.crm.web.EventController" method="setSequence" />
	</action-method>
	
    <action-method name="action-meeting-method-compute-end-date-time">
    	<call class="com.axelor.apps.crm.web.EventController" method="computeEndDateTime"/>
    </action-method>
    
    <action-method name="action-meeting-method-compute-duration">
    	<call class="com.axelor.apps.crm.web.EventController" method="computeDuration" />
    </action-method>
    
    <action-record name="action-event-record-task-status-select" model="com.axelor.apps.crm.db.Event">
    	<field name="taskStatusSelect" expr="1" if="typeSelect == 3"/>
    </action-record>
    
    <action-record name="action-event-record-status-select" model="com.axelor.apps.crm.db.Event">
    	<field name="statusSelect" expr="1" if="typeSelect == 1 || typeSelect == 2"/>
    </action-record>
    
    <action-record name="action-event-record-ticket-status-select" model="com.axelor.apps.crm.db.Event">
    	<field name="ticketStatusSelect" expr="1"/>
    </action-record>
    
    <action-record name="action-event-record-progress-select" model="com.axelor.apps.crm.db.Event">
    	<field name="progressSelect" expr="0"/>
    </action-record>
    
    <action-record name="action-event-record-call-status-select" model="com.axelor.apps.crm.db.Event">
    	<field name="callStatusSelect" expr="eval: _callAllCrm"/>
    </action-record>
    
    <action-record name="action-ticket-record-new" model="com.axelor.apps.crm.db.Event">
    	<field name="quaternaryStatusSelect" expr="1"/>
<!--     	<field name="ticketNumberSeq" expr="eval: com.axelor.apps.crm.db.Event.all().filter('self.typeSelect = 5').count() + 1"/> -->
    	<field name="prioritySelect" expr="eval: _prioritySelect"/>
    </action-record>
    
    <action-record name="action-event-record-default-duration" model="com.axelor.apps.crm.db.Event">
    	<field name="durationHours" expr="1"/>
    </action-record>
    
    <action-group name="action-event-new-record">
    	<action name="action-event-default-record"/>
    	<action name="action-event-record-default-duration" if="typeSelect != 5"/>
    	<action name="action-ticket-record-new" if="typeSelect == 5"/> <!-- typeSelect == 5: ticket -->
    	<action name="action-event-default-record-userinfo"/>
    	<action name="action-event-record-call-status-select" if="typeSelect == 1"/>
    	<action name="action-event-record-status-select" if="typeSelect == 2 || typeSelect == 1"/>
    	<action name="action-event-record-task-status-select" if="typeSelect == 3"/>
    </action-group>
    
    <action-attrs name="action-event-ticket-attrs-default">
    	<attribute name="hidden" for="responsibleUserInfo" expr="eval: true" if="_clientView"/>
    	<attribute name="required" for="project" expr="eval: true" if="typeSelect == 5"/>
    </action-attrs>
    
    <search-filters name="tasks-filters" model="com.axelor.apps.crm.db.Event" title="Tasks filters">
		<filter title="My Tasks">
			<domain>self.userInfo.internalUser.id = :_internalUser</domain>
		</filter>
		<filter title="My Today Tasks">
			<domain>self.userInfo.internalUser.id = :_internalUser and self.startDateTime &lt;= :_todayDateTime</domain>
		</filter>
		<filter title="My Upcoming Tasks">
			<domain>self.userInfo.internalUser.id = :_internalUser and self.startDateTime &lt; :_newDate and (self.taskStatusSelect = 1 or self.taskStatusSelect = 2)</domain>
		</filter>
		<filter title="My Team Tasks">
			<domain>self.team = :_myActiveTeam</domain>
		</filter>
	</search-filters>
	
	<search-filters name="meeting-filters" model="com.axelor.apps.crm.db.Event" title="Meeting filters">
		<filter title="My Meetings">
			<domain>self.userInfo.internalUser.id = :_internalUser</domain>
		</filter>
		<filter title="My Upcoming Meetings">
			<domain>self.userInfo.internalUser.id = :_internalUser and self.startDateTime &lt; :_newDate</domain>
		</filter>
		<filter title="My Team Meetings">
			<domain>self.team = :_myActiveTeam</domain>
		</filter>
	</search-filters>
	
	<search-filters name="call-filters" model="com.axelor.apps.crm.db.Event" title="Call filters">
		<filter title="My Calls">
			<domain>self.userInfo.internalUser.id = :_internalUser</domain>
		</filter>
		<filter title="My Today Calls">
			<domain>self.userInfo.internalUser.id = :_internalUser and self.startDateTime &lt;= :_todayDateTime</domain>
		</filter>
		<filter title="My Team Calls">
			<domain>self.team = :_myActiveTeam</domain>
		</filter>
	</search-filters>
	
	<search-filters name="ticket-filters" model="com.axelor.apps.crm.db.Event" title="Ticket filters">
		<filter title="My Tickets">
			<domain>self.userInfo.internalUser.id = :_internalUser</domain>
		</filter>
		<filter title="My Team Tickets">
			<domain>self.team = :_myActiveTeam</domain>
		</filter>
		<filter title="Unassigned Tickets">
			<domain>self.userInfo IS NULL</domain>
		</filter>
		<filter title="Urgent Tickets">
			<domain>self.prioritySelect = 3</domain>
		</filter>
		<filter title="New Tickets">
			<domain>self.progressSelect = 0</domain>
		</filter>
		<filter title="Ongoing Tickets">
			<domain>(self.progressSelect != 0 and self.progressSelect != 100) or (self.ticketStatusSelect != 0 and self.ticketStatusSelect != 5)</domain>
		</filter>
		<filter title="Closed Tickets">
			<domain>self.ticketStatusSelect = 5</domain>
		</filter>
	</search-filters>
	
</object-views>