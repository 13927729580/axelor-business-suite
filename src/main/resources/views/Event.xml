<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_0.9.xsd">
    
    <grid name="event-grid" title="Events" model="com.axelor.apps.crm.db.Event" orderBy="startDateTime">
    	<toolbar>
    		<button name="exportCalendar" title="Export calendar" onClick="com.axelor.apps.crm.web.CalendarController:exportCalendar" colSpan="1"/>
    		<button name="importCalendar" title="Import calendar" onClick="com.axelor.apps.crm.web.CalendarController:importCalendar" colSpan="1"/>
    		<button name="synchronizeCalendars" title="Synchronize calendar" onClick="com.axelor.apps.crm.web.CalendarController:synchronizeCalendars" colSpan="1"/>
    	</toolbar>
        <field name="typeSelect"/>
        <field name="subject"/>
        <field name="startDateTime"/>
        <field name="durationHours"/>
        <field name="userInfo"/>
        <field name="team"/>
    </grid>
    
    
    <calendar name="event-calendar" title="Meetings" mode="month" colorBy="calendar" 
    	eventStart="startDateTime" eventStop="endDateTime" eventLength="1" model="com.axelor.apps.crm.db.Event">
    	<field name="subject" />
 	</calendar>
    
    <form name="event-form" title="Events" model="com.axelor.apps.crm.db.Event">
    	<toolbar>
    		<button name="exportCalendar" title="Export calendar" onClick="com.axelor.apps.crm.web.CalendarController:exportCalendar" colSpan="1"/>
    		<button name="importCalendar" title="Import calendar" onClick="com.axelor.apps.crm.web.CalendarController:importCalendar" colSpan="1"/>
    		<button name="synchronizeCalendars" title="Synchronize calendars" onClick="com.axelor.apps.crm.web.CalendarController:synchronizeCalendars" colSpan="1"/>
    	</toolbar>
        <group title="Informations" cols="4" colSpan="1">
        	<field name="subject" colSpan="2"/>
	        <field name="eventStatusSelect" colSpan="2"/>
	        <spacer/><break/>
	        <group title="Event dates" colSpan="4" cols="4" colWidths="25*" css="groupTitle">
		        <field name="startDateTime" onChange="action-meeting-method-compute-start-date-time"/>
		        <field name="endDateTime" onChange="action-meeting-method-compute-end-date-time"/>
		        <field name="durationHours" onChange="action-meeting-method-compute-duration"/>
		        <field name="durationMinutesSelect" showTitle="false" colSpan="1"/>
	        </group>
	        <spacer/><break/>
	        <field name="description" widget="TEXT[height=4]" colSpan="4"/>
	        <field name="reminder"/>
        </group>
        <group title="Related to" colSpan="1" cols="2">
	        <field name="relatedToSelect" widget="RefSelect[related=relatedToSelectId]"/>
        </group>
        <group title="Assignment" cols="4" colSpan="2" canCollapse="true">
	        <field name="userInfo"/>
	    	<field name="team" readonlyIf="!userInfo" onSelect="action-event-attrs-team-domain"/>
        </group>
        <group title="Attendees" cols="4" colSpan="2" canCollapse="true">
        	<field name="contactEventAttendeeList" grid-view="event-attendee-contact-grid" form-view="event-attendee-contact-form" colSpan="4"/>
        	<field name="leadEventAttendeeList" grid-view="event-attendee-lead-grid" form-view="event-attendee-lead-form" colSpan="4"/>
        </group>
        <field name="calendar" widget="SuggestBox"/>
        <field name="calendarEventUid"/>
        
<!--         A completer -->
    </form>
    
    
    <grid name="call-grid" title="Calls" model="com.axelor.apps.crm.db.Event">
        <field name="subject"/>
        <field name="callStatusSelect"/>
        <field name="statusSelect"/>
        <field name="startDateTime"/>
        <field name="relatedToSelect"/>
        <field name="reminder"/>
    </grid>
    
    <form name="call-form" title="Call" model="com.axelor.apps.crm.db.Event" cols="2" colWidths="*,400"
    	onNew="action-event-new-record">
        <group title="Informations" cols="4" colSpan="1">
        	<field name="subject" colSpan="2"/>
	        <field name="callStatusSelect" colSpan="2"/>
	        <field name="statusSelect" showTitle="false" colSpan="1"/>
	        <spacer/><break/>
	        <group title="Call date" colSpan="4" cols="3" css="groupTitle">
	        	<field name="startDateTime" colSpan="2"/>
	         	<field name="durationHours" colSpan="2"/>
		        <field name="durationMinutesSelect" showTitle="false" colSpan="1"/>
	        </group>
	        <spacer/><break/>
	        <field name="description" widget="TEXT[height=4]" colSpan="4"/>
	        <field name="reminder"/>
        </group>
        <group title="Related to" colSpan="1" cols="2">
	        <field name="relatedToSelect" widget="RefSelect[related=relatedToSelectId]"/>
        </group>
        <group title="Assignment" cols="4" colSpan="2" canCollapse="true">
	        <field name="userInfo"/>
	    	<field name="team" readonlyIf="!userInfo" onSelect="action-event-attrs-team-domain"/>
        </group>
        <group title="Attendees" cols="4" colSpan="2" canCollapse="true">
        	<field name="contactEventAttendeeList" grid-view="event-attendee-contact-grid" form-view="event-attendee-contact-form" colSpan="4"/>
        	<field name="leadEventAttendeeList" grid-view="event-attendee-lead-grid" form-view="event-attendee-lead-form" colSpan="4"/>
        </group>
    </form>
    
  <calendar name="meeting-calendar" title="Meetings" mode="month" colorBy="userInfo" 
    eventStart="startDateTime" 
    eventStop="endDateTime" 
    eventLength="1">
    <field name="subject" />
  </calendar>
    
    
    <grid name="meeting-grid" title="Meetings" model="com.axelor.apps.crm.db.Event" >
        <field name="subject"/>
        <field name="statusSelect"/>
        <field name="startDateTime"/>
        <field name="relatedToSelect"/>
        <field name="reminder"/>
    </grid>
    
    <form name="meeting-form" title="Meeting" model="com.axelor.apps.crm.db.Event" cols="2" colWidths="*,400" 
    	onNew="action-event-new-record">
        <group title="Informations" cols="4" colSpan="1">
        	<field name="subject"/>
	        <field name="statusSelect"/>
	        <spacer/><break/>
	        <group title="Meeting dates" colSpan="4" cols="4" colWidths="25*" css="groupTitle">
		        <field name="startDateTime" onChange="action-meeting-method-compute-start-date-time"/>
		        <field name="endDateTime" onChange="action-meeting-method-compute-end-date-time"/>
		        <field name="durationHours" onChange="action-meeting-method-compute-duration"/>
		        <field name="durationMinutesSelect" showTitle="false" colSpan="1"/>
	        </group>
	       	<spacer/><break/>
	        <field name="location"/>
	        <field name="reminder"/>
	        <field name="description" widget="TEXT[height=4]" colSpan="4"/>
        </group>
        <group title="Related to" colSpan="1" cols="2">
	        <field name="relatedToSelect" widget="RefSelect[related=relatedToSelectId]"/>
        </group>
        <group title="Assigned to" cols="4" colSpan="2" canCollapse="true">
	        <field name="userInfo"/>
	    	<field name="team" readonlyIf="!userInfo" onSelect="action-event-attrs-team-domain"/>
        </group>
        <group title="Attendees" cols="4" colSpan="2" canCollapse="true">
        	<field name="contactEventAttendeeList" grid-view="event-attendee-contact-grid" form-view="event-attendee-contact-form" colSpan="4"/>
        	<field name="leadEventAttendeeList" grid-view="event-attendee-lead-grid" form-view="event-attendee-lead-form" colSpan="4"/>
        </group>
    </form>
    
    <grid name="crm-task-grid" title="Tasks" model="com.axelor.apps.crm.db.Event">
        <field name="subject"/>
        <field name="taskStatusSelect"/>
        <field name="startDateTime"/>
        <field name="relatedToSelect"/>
        <field name="reminder"/>
    </grid>
    
    <form name="crm-task-form" title="Task" model="com.axelor.apps.crm.db.Event" cols="2" colWidths="*,400"
    	onNew="action-event-new-record">
        <group title="Informations" cols="4" colSpan="1">
        	<field name="subject"/>
	        <field name="taskStatusSelect"/>
	        <spacer/><break/>
         	<group title="Task date" colSpan="4" cols="4" colWidths="25*" css="groupTitle">
		        <field name="startDateTime" onChange="action-meeting-method-compute-start-date-time"/>
		        <field name="endDateTime" onChange="action-meeting-method-compute-end-date-time"/>
		        <field name="durationHours" onChange="action-meeting-method-compute-duration"/>
	        </group>
	        <spacer/><break/>
	        <field name="taskPartner"/>
	        <field name="reminder"/>
	        <field name="prioritySelect"/>
	        <field name="description" widget="TEXT[height=4]" colSpan="4"/>
        </group>
        <group title="Related to" colSpan="1" cols="2">
	        <field name="relatedToSelect" widget="RefSelect[related=relatedToSelectId]"/>
        </group>
        <group title="Assigned to" cols="4" colSpan="2" canCollapse="true">
	        <field name="userInfo"/>
	    	<field name="team" readonlyIf="!userInfo" onSelect="action-event-attrs-team-domain"/>
        </group>
        <group title="Attendees" cols="4" colSpan="2" canCollapse="true">
        	<field name="contactEventAttendeeList" grid-view="event-attendee-contact-grid" form-view="event-attendee-contact-form" colSpan="4"/>
        	<field name="leadEventAttendeeList" grid-view="event-attendee-lead-grid" form-view="event-attendee-lead-form" colSpan="4"/>
        </group>
    </form>
    
    
     <grid name="ticket-grid" title="Ticket" model="com.axelor.apps.crm.db.Event" orderBy="ticketNumberSeq">
     	<field name="ticketNumberSeq"/>
        <field name="subject"/>
        <field name="ticketStatusSelect"/>
        <field name="eventCategory"/>
        <field name="startDateTime"/>
        <field name="prioritySelect"/>
        <field name="userInfo"/>
        <field name="description"/>
        <field name="progressSelect" widget="Progress"/>
    </grid>
    
    <form name="ticket-form" title="Ticket" model="com.axelor.apps.crm.db.Event" cols="6" colWidths="*,400"
    	onNew="action-event-new-record,action-event-ticket-attrs-default"
    	onLoad="action-event-ticket-attrs-default"
    	onSave="action-event-set-sequence">
    	<group colSpan="6" cols="6"  colWidths="16%,17%,16%,17%,16%,18%">
	    	<field name="ticketNumberSeq" readonly="true"/>
	       	<field name="subject"/>
	       	<field name="eventCategory" domain="self.typeSelect = :typeSelect"/>
	       	<field name="ticketStatusSelect"/>
	       	<field name="prioritySelect"/>
	       	<group colSpan="2">
				<field name="progressSelect" widget="Progress" showIf="$readonly()"/>
				<field name="progressSelect" hideIf="$readonly()"/>
			</group>
	        <break/>
    	</group>
    	<group colSpan="6" cols="6">
   			<group title="Ticket date" colSpan="2" cols="2" colWidths="40%,60%">
		        <field name="startDateTime"/>
		        <field name="endDateTime" title="DeadLine"/>
		        <field name="durationHours"/>
	        </group>
	        <group title="Related to" colSpan="2" cols="2"  colWidths="40%,60%">
	        	<field name="project"/>
	        	<field name="task"/>
	        	<field name="isTimesheetAffected"/>
	        </group>
	        <group colSpan="2" cols="2"  colWidths="40%,60%">
	        	<field name="createdBy" readonly="true"/>
	        	<field name="userInfo"/>
	        	<field name="responsibleUserInfo"/>
	        </group>
    	</group>
        <notebook colSpan="6">
        	<page title="Description" >
        		<field name="description" widget="TEXT[height=4]" showTitle="false" colSpan="6"/>
        	</page>
        	<page title="Comments">
        		<field name="messageList" showTitle="false" colSpan="6">
        			<form title="Comment">
        				<group title="Informations" colSpan="4" readonly="true">
				            <field name="sendedDate"/>
				            <field name="sender"/>
				        </group>
				        <group title="Content" colSpan="4">
				       	 	<field name="content" colSpan="4" showTitle="false" widget="html"/>
				        </group>
        			</form>
        			<grid title="Comments">
			            <field name="sendedDate"/>
			            <field name="sender"/>
			       	 	<field name="content" colSpan="4" showTitle="false" widget="html"/>
        			</grid>
        		</field>
        	</page>
        	<page title="Watchers">
        		<field name="userInfoSet" showTitle="false" colSpan="6"/>
        	</page>
        </notebook>
    </form>
    
    <action-record name="action-event-default-record-userinfo" model="com.axelor.apps.crm.db.Event">
    	<field name="userInfo" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserInfo()" if="typeSelect == 1 || typeSelect == 2 || typeSelect == 3 || typeSelect == 5"/>
    	<field name="responsibleUserInfo" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserInfo()" if="typeSelect == 5"/>
   		<field name="team" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserActiveTeam()"/>
    </action-record>
    
    <action-attrs name="action-event-attrs-team-domain">
    	<attribute name="domain" for="team" expr="eval: &quot;self.id IN (${userInfo?.teamSet?.collect{it.id}.join(',')})&quot;" if="userInfo?.teamSet?.collect{it.id}?.size() > 0"/>
    </action-attrs>
    
    <action-record name="action-event-default-record" model="com.axelor.apps.crm.db.Event">
    	<field name="startDateTime" expr="eval: __time__" if="startDateTime == null"/>
    	<field name="typeSelect" expr="eval: _typeSelect"/>
    </action-record>
    
    <action-method name="action-meeting-method-compute-start-date-time">
    	<call class="com.axelor.apps.crm.web.EventController" method="computeStartDateTime"/>
    </action-method>
    
    <action-method name="action-event-set-sequence">
		<call class="com.axelor.apps.supplychain.web.EventController" method="setSequence" />
	</action-method>
	
    <action-method name="action-meeting-method-compute-end-date-time">
    	<call class="com.axelor.apps.crm.web.EventController" method="computeEndDateTime"/>
    </action-method>
    
    <action-method name="action-meeting-method-compute-duration">
    	<call class="com.axelor.apps.crm.web.EventController" method="computeDuration" />
    </action-method>
    
    <action-record name="action-event-record-task-status-select" model="com.axelor.apps.crm.db.Event">
    	<field name="taskStatusSelect" expr="1" if="typeSelect == 3"/>
    </action-record>
    
    <action-record name="action-event-record-status-select" model="com.axelor.apps.crm.db.Event">
    	<field name="statusSelect" expr="1" if="typeSelect == 1 || typeSelect == 2"/>
    </action-record>
    
    <action-record name="action-event-record-call-status-select" model="com.axelor.apps.crm.db.Event">
    	<field name="callStatusSelect" expr="eval: _callAllCrm"/>
    </action-record>
    
    <action-record name="action-ticket-record-new" model="com.axelor.apps.crm.db.Event">
    	<field name="quaternaryStatusSelect" expr="1"/>
<!--     	<field name="ticketNumberSeq" expr="eval: com.axelor.apps.crm.db.Event.all().filter('self.typeSelect = 5').count() + 1"/> -->
    	<field name="prioritySelect" expr="eval: _prioritySelect"/>
    </action-record>
    
    <action-group name="action-event-new-record">
    	<action name="action-event-default-record"/>
    	<action name="action-ticket-record-new" if="typeSelect == 5"/> <!-- typeSelect == 5: ticket -->
    	<action name="action-event-default-record-userinfo"/>
    	<action name="action-event-record-call-status-select" if="typeSelect == 1"/>
    	<action name="action-event-record-status-select" if="typeSelect == 2 || typeSelect == 1"/>
    	<action name="action-event-record-task-status-select" if="typeSelect == 3"/>
    </action-group>
    
    <action-attrs name="action-event-ticket-attrs-default">
    	<attribute name="hidden" for="isTimesheetAffected" expr="eval: true" if="_clientView"/>
    	<attribute name="hidden" for="responsibleUserInfo" expr="eval: true" if="_clientView"/>
    </action-attrs>
    
</object-views>