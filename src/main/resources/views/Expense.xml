<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_0.9.xsd">

	<grid name="expense-edit-grid" title="Travel expenses" editable="true"
		model="com.axelor.apps.organisation.db.Expense">
		<field name="date" />
		<field name="expenseLineList" grid-view="expense-line-edit-grid" />
		<field name="statusSelect"/>
	</grid>

    <grid name="expense-grid" title="Travel expenses" model="com.axelor.apps.organisation.db.Expense">
        <field name="userInfo"/>
        <field name="date"/>
        <field name="totalAmount"/>
        <field name="currency"/>
        <field name="paymentPeriod"/>
        <field name="statusSelect"/>
        <field name="progress" widget="Progress"/>
    </grid>
    
    <form name="expense-form" title="Travel expense" model="com.axelor.apps.organisation.db.Expense" cols="4"
    onNew="action-expense-default-record" onLoad="action-expense-method-check-validation-status">
		<field name="userInfo"/>
   	 	<field name="statusSelect" widget="NavSelect" showTitle="false"/>
        <field name="date" />
        <field name="totalAmount"/>
       	<field name="currency" />
   	 	<field name="expenseLineList" colSpan="4"/>
   	 	<break/>
   	 	<field name="progress" widget="progress"/>
   	 	<field name="paymentPeriod"/>
   	 	<field name="motif" showIf="statusSelect == 6"/>
   	 	<break/>
       	<group title="Action(s)" colSpan="4">
   			<group colSpan="1" cols="1">
   				<button name="draft" title="Draft" colSpan="2" onClick="save,action-expense-record-draft,save" showIf="statusSelect == 6"/>
        		<button name="submit" title="Submit" colSpan="2" onClick="save,action-expense-record-submit,action-expense-method-check-validation-status,save" showIf="statusSelect == 1"/>
	            <button name="validateManager" title="Validate" colSpan="1" onClick="save,action-expense-method-check-validation-status,action-expense-record-validate-manager,action-expense-alert-validate,action-expense-record-validation-info,save" showIf="statusSelect == 2"/>
	            <button name="validateCommercial" title="Validate" colSpan="1" onClick="save,action-expense-record-validate-commercial,action-expense-record-validation-info,save" showIf="statusSelect == 3"/>
	         	<button name="confirm" title="Confirm" colSpan="1" onClick="save,action-expense-record-confirm,save" showIf="statusSelect == 4"/>
	            <button name="refuse" title="Refuse" colSpan="1" onClick="save,action-expense-record-refuse" showIf="statusSelect == 1 || statusSelect == 2"/>
        		<button name="sum" title="Compute" colSpan="2" onClick="action-expense-sum-expense-line"/>
	        </group>
   			<group colSpan="1" cols="2" readonly="true">
   				<field name="validatedByUserInfo" colSpan="1"/>
             	<field name="validationDate" colSpan="1"/>
   	 			<field name="validationStatusSelect" hideIf="statusSelect == 1 || statusSelect == 6"/>
   			</group>
        </group>
    </form>
    
	<action-record name="action-expense-default-record" model="com.axelor.apps.organisation.db.Expense">
    	<field name="userInfo" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserInfo()"/>
    	<field name="date" expr="call:com.axelor.apps.base.service.administration.GeneralService:getTodayDate()" if="date == null"/>
    	<field name="currency" expr="eval: _activeCompany?.currency"/>	
    	<field name="statusSelect" expr="eval: 1"/>
    </action-record>
    
    <action-record name="action-expense-sum-expense-line" model="com.axelor.apps.organisation.db.Expense">
    	<field name="totalAmount" expr="eval:expenseLineList?.collect(){it?.total}?.sum()"/>
    </action-record>
    
    <action-record name="action-expense-record-submit" model="com.axelor.apps.organisation.db.Expense">
    	<field name="statusSelect" expr="eval: 2"/>
    </action-record>
    
    <action-record name="action-expense-record-validate-manager" model="com.axelor.apps.organisation.db.Expense">
    	<field name="statusSelect" expr="eval: 3" if="validationStatusSelect == 1"/>
    </action-record>
    
    <action-record name="action-expense-record-validate-commercial" model="com.axelor.apps.organisation.db.Expense">
    	<field name="statusSelect" expr="eval: 4"/>
    </action-record>
    
    <action-validate name="action-expense-alert-validate">
    	<alert message="All supporting files have not been provided" if="validationStatusSelect == 2"/>
    </action-validate>
    
    <action-record name="action-expense-record-validation-info" model="com.axelor.apps.organisation.db.Expense">
    	<field name="validatedByUserInfo" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserInfo()" if="validationStatusSelect == 1"/>
    	<field name="validationDate" expr="call:com.axelor.apps.base.service.administration.GeneralService:getTodayDate()" if="validationStatusSelect == 1"/>
    </action-record>
    
    <action-record name="action-expense-record-confirm" model="com.axelor.apps.organisation.db.Expense">
    	<field name="statusSelect" expr="eval: 5"/>
    </action-record>
    
     <action-record name="action-expense-record-refuse" model="com.axelor.apps.organisation.db.Expense">
    	<field name="statusSelect" expr="eval: 6"/>
    </action-record>
    
    <action-record name="action-expense-record-draft" model="com.axelor.apps.organisation.db.Expense">
    	<field name="statusSelect" expr="eval: 1"/>
    </action-record>
    
    <action-method name="action-expense-method-check-validation-status">
    	<call class="com.axelor.apps.organisation.web.ExpenseController" method="checkValidationStatus"/>
    </action-method>
    
</object-views>