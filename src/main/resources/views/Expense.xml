<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_2.1.xsd">

	<grid name="expense-edit-grid" title="Expenses" editable="true"
		model="com.axelor.apps.organisation.db.Expense">
		<field name="date" />
		<field name="company"/>
		<field name="expenseLineList" grid-view="expense-line-edit-grid" />
		<field name="statusSelect"/>
	</grid>

    <grid name="expense-grid" title="Expenses" model="com.axelor.apps.organisation.db.Expense">
        <field name="user"/>
        <field name="date"/>
        <field name="company"/>
        <field name="totalAmount" title="Total (TTC)"/>
        <field name="currency"/>
        <field name="paymentPeriod"/>
        <field name="statusSelect"/>
    </grid>
    
    
	<grid edit-icon="true" name="my-expense-grid" title="My Expenses" model="com.axelor.apps.organisation.db.Expense">
	  <field name="date"/>
	  <field name="company"/>
	  <field name="totalAmount" title="Total (TTC)"/>
	  <field name="currency"/>
	  <field name="paymentPeriod"/>
	  <field name="statusSelect"/>
	</grid>
	    
    
	<form name="expense-form" title="Expense" model="com.axelor.apps.organisation.db.Expense" onLoad="action-expense-method-check-validation-status" onNew="action-expense-group-default">
	  <toolbar>
	    <button name="printExpense" title="Print" colSpan="2" icon="fa-print" onClick="action-print-expenses"/>
	  </toolbar>
	  <panel>
	    <field name="user"/>
	    <field name="statusSelect" showTitle="false" colSpan="12" widget="NavSelect"/>
	    <field name="date"/>
	    <field name="company" widget="SuggestBox" form-view="company-lite-form"/>
	    <field name="totalAmount" title="Total (TTC)"/>
	    <field name="currency"/>
	    <field name="project"/>
	    <panel-related field="expenseLineList" colSpan="12"/>    
	    <field name="paymentPeriod"/>
	    <field name="refusalReason" showIf="statusSelect == 6"/>
	  </panel>
	  <panel-side title="Action(s)">
	    <panel colSpan="12">
	      <button name="draft" title="Draft" showIf="statusSelect == 6" colSpan="2" onClick="action-group-organisation-expense-draft-click"/>
	      <button name="submit" title="Submit" showIf="statusSelect == 1" colSpan="2" onClick="action-group-organisation-expense-submit-click"/>
	      <button name="validateManager" title="Validate" showIf="statusSelect == 2" colSpan="1" onClick="action-group-organisation-expense-validatemanager-click"/>
	      <button name="validateCommercial" title="Validate" showIf="statusSelect == 3" colSpan="1" onClick="action-group-organisation-expense-validatecommercial-click"/>
	      <button name="confirm" title="Confirm" showIf="statusSelect == 4" colSpan="1" onClick="action-group-organisation-expense-confirm-click"/>
	      <button name="refuse" title="Refuse" showIf="statusSelect == 2" colSpan="1" onClick="save,action-expense-record-refuse"/>
	      <button name="compute" title="Compute" colSpan="2" onClick="action-expense-compute-expense-line"/>
	    </panel>
	    <panel readonly="true" colSpan="12">
	      <field name="validatedByUser"  colSpan="12"/>
	      <field name="validationDate"  colSpan="12"/>
	      <field name="validationStatusSelect" hideIf="statusSelect == 1 || statusSelect == 6"  colSpan="12"/>
	    </panel>
	  </panel-side>
	</form>
    
    <action-group name="action-expense-group-default">
    	<action name="action-expense-record-default"/>
    	<action name="action-expense-record-default-currency"/>
    </action-group>
    
    <action-group name="action-group-organisation-expense-draft-click">
    	<action name="save"/>
    	<action name="action-expense-record-draft"/>
    	<action name="save"/>
    </action-group>
    
    <action-group name="action-group-organisation-expense-submit-click">
    	<action name="action-expense-compute-expense-line"/>
    	<action name="save"/>
    	<action name="action-expense-record-submit"/>
    	<action name="action-expense-method-check-validation-status"/>
    	<action name="save"/>
    </action-group>
    
    <action-group name="action-group-organisation-expense-validatemanager-click">
    	<action name="save"/>
    	<action name="action-expense-method-check-validation-status"/>
    	<action name="action-expense-record-validate-manager"/>
    	<action name="action-expense-alert-validate"/>
    	<action name="action-expense-record-validation-info"/>
    	<action name="save"/>
    </action-group>
    
    <action-group name="action-group-organisation-expense-validatecommercial-click">
    	<action name="save"/>
    	<action name="action-expense-record-validate-commercial"/>
    	<action name="action-expense-record-validation-info"/>
    	<action name="save"/>
    </action-group>
    
    <action-group name="action-group-organisation-expense-confirm-click">
    	<action name="save"/>
    	<action name="action-expense-record-confirm"/>
    	<action name="save"/>
    </action-group>
    
	<action-record name="action-expense-record-default" model="com.axelor.apps.organisation.db.Expense">
    	<field name="user" expr="eval:__user__"/>
    	<field name="date" expr="call:com.axelor.apps.base.service.administration.GeneralService:getTodayDate()" if="date == null"/>
    	<field name="statusSelect" expr="eval: 1"/>
		<field name="company" expr="eval:__user__.activeCompany"/>
    </action-record>
    
    <action-record name="action-expense-record-default-currency" model="com.axelor.apps.organisation.db.Expense">
    	<field name="currency" expr="eval: company?.currency"/>	
    </action-record>
    
    <action-record name="action-expense-compute-expense-line" model="com.axelor.apps.organisation.db.Expense">
    	<field name="totalAmount" expr="eval:expenseLineList?.collect(){it?.inTaxTotal}?.sum()"/>
    </action-record>
    
    <action-record name="action-expense-record-submit" model="com.axelor.apps.organisation.db.Expense">
    	<field name="statusSelect" expr="eval: 2"/>
    </action-record>
    
    <action-record name="action-expense-record-validate-manager" model="com.axelor.apps.organisation.db.Expense">
    	<field name="statusSelect" expr="eval: 3" if="validationStatusSelect == 1"/>
    </action-record>
    
    <action-record name="action-expense-record-validate-commercial" model="com.axelor.apps.organisation.db.Expense">
    	<field name="statusSelect" expr="eval: 4"/>
    </action-record>
    
    <action-validate name="action-expense-alert-validate">
    	<alert message="All supporting files have not been provided" if="validationStatusSelect == 2"/>
    </action-validate>
    
    <action-record name="action-expense-record-validation-info" model="com.axelor.apps.organisation.db.Expense">
    	<field name="validatedByUser" expr="eval:__user__" if="validationStatusSelect == 1"/>
    	<field name="validationDate" expr="call:com.axelor.apps.base.service.administration.GeneralService:getTodayDate()" if="validationStatusSelect == 1"/>
    </action-record>
    
    <action-record name="action-expense-record-confirm" model="com.axelor.apps.organisation.db.Expense">
    	<field name="statusSelect" expr="eval: 5"/>
    </action-record>
    
     <action-record name="action-expense-record-refuse" model="com.axelor.apps.organisation.db.Expense">
    	<field name="statusSelect" expr="eval: 6"/>
    </action-record>
    
    <action-record name="action-expense-record-draft" model="com.axelor.apps.organisation.db.Expense">
    	<field name="statusSelect" expr="eval: 1"/>
    </action-record>
    
    <action-method name="action-expense-method-check-validation-status">
    	<call class="com.axelor.apps.organisation.web.ExpenseController" method="checkValidationStatus"/>
    </action-method>
    
    <action-method name="action-print-expenses">
    	<call class="com.axelor.apps.organisation.web.ExpenseController" method="printExpenses"/>
    </action-method>
    
</object-views>