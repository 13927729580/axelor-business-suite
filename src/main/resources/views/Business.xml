<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_2.0.xsd">
    
    <grid name="business-project-grid" title="Business" model="com.axelor.apps.organisation.db.Project">
        <field name="clientPartner"/>
        <field name="contactPartner"/>
        <field name="company"/>
        <field name="name"/>
        <field name="isModel"/>
    </grid>
    
    <form name="business-project-form" title="Business" model="com.axelor.apps.organisation.db.Project" cols="6" 
    onLoad="action-project-method-update-financial-information,save"
    onNew="action-business-project-group-default"
    onSave="save,action-business-project-method-create-default-task-on-save">
    	<group showTitle="false" cols="6" colSpan="6">
	    	<field name="name" showTitle="false" css="highlight" placeholder="Name" colSpan="4"/>
	       	<field name="businessStatusSelect" widget="NavSelect" showTitle="false"/>
    	</group>
    	<group showTitle="false" cols="4">
        	<field name="company" widget="SuggestBox" form-view="company-lite-form" readonlyIf="projectStatusSelect >= 3 || businessStatusSelect >= 2"/>
        	<field name="responsibleUserInfo"/>
	        <field name="clientPartner" domain="self.isContact = false" form-view="partner-form" grid-view="partner-grid"/>
	        <field name="defaultTask" hideIf="!isTimeSheetImputable"/>
	        <field name="contactPartner" domain="self.isContact = true" form-view="partner-contact-form" grid-view="partner-contact-grid"/>
 		</group>
    	<group title="Actions" showTitle="false" colSpan="2" cols="1">
<!-- 	        <button name="createSalesOrder" title="Create quote" colSpan="1"/> -->
<!-- 	        <button name="generateNewInstanceOfProject" title="Generate new project instance" hideIf="!isModel" colSpan="1"/> -->
	        <button name="transformToProject" title="Transform to project" showIf="isProject == false" colSpan="1" onClick="action-business-project-record-transform-in-project,save"/>
	        <button name="createPreSalesTask" title="Create pre-sales task" colSpan="1" onClick="save,action-business-project-method-create-pre-sales-task"/>
	        <button name="updateTaskProgression" title="Update task progress" colSpan="1" onClick="action-project-method-update-task-progress"/>
	        <button name="createProductionOrder" title="Create production order" colSpan="2" onClick="save,action-product-view-create-production-order"/>
	    </group>
	    <group showTitle="false" colSpan="6">
        	<group title="Times" colSpan="6" cols="6">
        		<field name="totalTime"/>
        		<field name="unit"/>  
        		<spacer colSpan="2"/>
        		<separator colSpan="6"/>
	            <field name="plannedTime"/>
	            <field name="spentTime"/>
	            <field name="remainingTime"/>
	        </group>
	        <group title="Description" colSpan="6">
            	<field name="description" showTitle="false" widget="Html" x-lite="true"/>
        	</group>
	        <group name="specificSettings" title="Specific settings" colSpan="6" canCollapse="true" colWidths="25%,25%,25%,25%">
	        	<field name="isProject"/>
	        	<field name="isBusiness"/>
	            <field name="isModel"/>
	            <field name="modelProject" hideIf="isModel" domain="self.isModel = true"/>
	            <field name="parentProject"/>
	            <field name="imputExpense"/>
	            <field name="typeProjectSelect" showIf="imputExpense == true"/>
	            <field name="isReinvoicingExpense"/>
	            <field name="isReinvoicingTime"/>
	            <field name="isTimeSheetImputable"/>
	        </group>
	    </group>
	    <notebook colSpan="6">
	        <page title="Tasks">
	        	<field name="preSalesTask"/>
	            <field name="taskList" grid-view="task-project-grid" form-view="task-form" colSpan="6"/>
	        </page>
	        <page title="Financial information" colSpan="4">
	        	<field name="realEstimatedMethodSelect"/>
	        	<field name="company.currency"/>
	        	<field name="marginCoef"/>
				<spacer/>
				<break/>
<!-- 	        	<field name="exportTypeSelect"/> -->
<!--                 <button name="printProject" colSpan="2" title="View forecast report" onClick="action-print-project-report" icon="fa-print"/> -->
	            <group title="Initial estimated" colSpan="4" cols="6" hideIf="realEstimatedMethodSelect == 1">
	                <field name="initialEstimatedTurnover"/>
	                <field name="initialEstimatedCost"/>
	                <field name="initialEstimatedMargin"/>
	            </group>
	            <group title="Real estimated" colSpan="4" cols="6">
	                <field name="realEstimatedTurnover"/>
	                <field name="realEstimatedCost"/>
	                <field name="realEstimatedMargin"/>
	            </group>
	            <group title="Real invoiced" colSpan="4" cols="6">
	                <field name="realInvoicedTurnover"/>
	                <field name="realInvoicedCost"/>
	                <field name="realInvoicedMargin"/>
	            </group>
	        </page>
	        <page title="Links" colSpan="4" >
	        	<notebook>
	        		<page title="Initial estimated" hideIf="realEstimatedMethodSelect == 1">
	        			<portlet colSpan="4" action="action-business-project-view-validated-sales-order-line"/>
	     				<portlet colSpan="4" action="action-business-project-view-validated-purchase-order-line"/>
	     				<portlet colSpan="4" action="action-business-project-view-initial-estimated-financial-information-update"/>
	        		</page>
	        		<page title="Real estimated">
	        			<portlet colSpan="4" action="action-business-project-view-validated-purchase-order-line"/>
	        			<portlet colSpan="4" action="action-business-project-view-timesheet-line"/>
			     		<portlet colSpan="4" action="action-business-project-view-expense-line"/>
	     				<portlet colSpan="4" action="action-business-project-view-real-estimated-financial-information-update"/>
	        		</page>
	        		<page title="Real invoiced">
	        			<portlet colSpan="4" action="action-business-project-view-customer-invoice-line"/>
			     		<portlet colSpan="4" action="action-business-project-view-supplier-invoice-line"/>
			     		<portlet colSpan="4" action="action-business-project-view-timesheet-line"/>
			     		<portlet colSpan="4" action="action-business-project-view-expense-line"/>
			     		<portlet colSpan="4" action="action-business-project-view-real-invoiced-financial-information-update"/>
	        		</page>
	        	</notebook>
	        </page>
	        <page title="Production informations">
<!-- 	        	<include view="business-project-production-form" from="axelor-production"/> -->
	        	<field name="prodInvTypeSelect"/>
   				<portlet colSpan="4" action="action-business-project-view-production-operation-order"/>
	        </page>
	        <page title="members" colSpan="4">
	            <field name="memberUserInfoSet" colSpan="6"/>
	        </page>
	        <page title="Need">
	            <field name="needTypeSelect"/>
	            <field name="marketTypeSelect"/>
	            <field name="consultationDate"/>
	            <field name="deadline"/>
	            <field name="complexity"/>
	            <field name="competition"/>
	            <field name="plannedBudget"/>     
	            <field name="answerDate"/>
	            <field name="specificationFile"/>
	            <field name="needDescription"/>
	        </page>
	    </notebook>    
	</form>
	
	<action-group name="action-business-project-group-default">
		<action name="action-business-project-record-default"/>
		<action name="action-business-project-record-unit"/>
	</action-group>
	
    <action-record name="action-business-project-record-default" model="com.axelor.apps.organisation.db.Project">
		<field name="isTimeSheetImputable" expr="true"/>
		<field name="isBusiness" expr="true"/>
    	<field name="exportTypeSelect" expr="eval: 'pdf'"/>
    	<field name="realEstimatedMethodSelect" expr="2"/>
    	<field name="responsibleUserInfo" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserInfo()"/>
		<field name="company" expr="call:com.axelor.apps.base.service.user.UserInfoService:getUserActiveCompany()"/>
		<field name="businessStatusSelect" expr="1"/>		
		<field name="unit" expr="eval: company?.administration?.unit"/>
		<field name="marginCoef" expr="1"/>
	</action-record>
	
	<action-record name="action-business-project-record-unit" model="com.axelor.apps.organisation.db.Project">
		<field name="unit" expr="eval: company?.administration?.unit"/>
	</action-record>
	
	<action-record name="action-business-project-record-transform-in-project" model="com.axelor.apps.organisation.db.Project">
		<field name="isProject" expr="true"/>
	</action-record>
			
	<action-method name="action-business-project-method-create-pre-sales-task">
		<call class="com.axelor.apps.organisation.web.ProjectController" method="createPreSalesTask"/>
	</action-method>	
		
	<action-method name="action-business-project-method-create-default-task-on-save">
		<call class="com.axelor.apps.organisation.web.ProjectController" method="createDefaultTask"/>
	</action-method>
	
	<action-method name="action-print-project-report" >
		<call class="com.axelor.apps.organisation.web.ProjectController" method="printProjectReport"/>
	</action-method>
	
	<action-method name="action-project-method-update-financial-information">
		<call class="com.axelor.apps.organisation.web.ProjectController" method="updateFinancialInformation"/>
	</action-method>
  	
  	<action-view name="action-business-project-view-initial-estimated-financial-information-update" title="Financial information updates" model="com.axelor.apps.organisation.db.FinancialInformationUpdate">
  		<view type="grid" name="financial-information-update-grid"/>
		<view type="form" name="financial-information-update-form"/>
  		<domain>self.applicationSelect = 1 and self.task.project.id = :id</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
  	<action-view name="action-business-project-view-validated-sales-order-line" title="Validated Customer order lines" model="com.axelor.apps.supplychain.db.SalesOrderLine">
  		<view type="grid" name="sales-order-line-grid"/>
		<view type="form" name="sales-order-line-form"/>
  		<domain>self.salesOrder.statusSelect = 3 and self.task.project.id = :id</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
  	<action-view name="action-business-project-view-validated-purchase-order-line" title="Validated supplier order lines" model="com.axelor.apps.supplychain.db.PurchaseOrderLine">
  		<view type="grid" name="purchase-order-line-grid"/>
		<view type="form" name="purchase-order-line-form"/>
  		<domain>self.purchaseOrder.statusSelect = 3 and self.task.project.id = :id</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
  	<action-view name="action-business-project-view-real-estimated-financial-information-update" title="Financial information updates" model="com.axelor.apps.organisation.db.FinancialInformationUpdate">
  		<view type="grid" name="financial-information-update-grid"/>
		<view type="form" name="financial-information-update-form"/>
  		<domain>self.applicationSelect = 2 and self.task.project.id = :id</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
  	<action-view name="action-business-project-view-customer-invoice-line" title="Customer invoice lines" model="com.axelor.apps.account.db.InvoiceLine">
  		<view type="grid" name="invoice-line-grid"/>
		<view type="form" name="invoice-line-form"/>
  		<domain>(self.invoice.status.code = 'val' or self.invoice.status.code = 'dis') and self.task.project.id = :id and (self.invoice.operationTypeSelect = 3 or self.invoice.operationTypeSelect = 4)</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
  	<action-view name="action-business-project-view-supplier-invoice-line" title="Supplier invoice lines" model="com.axelor.apps.account.db.InvoiceLine">
  		<view type="grid" name="invoice-line-grid"/>
		<view type="form" name="invoice-line-form"/>
  		<domain>(self.invoice.status.code = 'val' or self.invoice.status.code = 'dis') and self.task.project.id = :id and (self.invoice.operationTypeSelect = 1 or self.invoice.operationTypeSelect = 2)</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
  	<action-view name="action-business-project-view-timesheet-line" title="Timesheet lines" model="com.axelor.apps.organisation.db.TimesheetLine">
  		<view type="grid" name="timesheet-line-employee-grid"/>
		<view type="form" name="timesheet-line-employee-form"/>
  		<domain>self.timesheet.statusSelect = 3 and self.task.project.id = :id</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
  	<action-view name="action-business-project-view-expense-line" title="Expense lines" model="com.axelor.apps.organisation.db.ExpenseLine">
  		<view type="grid" name="expense-line-grid"/>
		<view type="form" name="expense-line-form"/>
  		<domain>self.expense.statusSelect = 3 and self.task.project.id = :id</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
  	<action-view name="action-business-project-view-real-invoiced-financial-information-update" title="Financial information updates" model="com.axelor.apps.organisation.db.FinancialInformationUpdate">
  		<view type="grid" name="financial-information-update-grid"/>
		<view type="form" name="financial-information-update-form"/>
  		<domain>self.applicationSelect = 3 and self.task.project.id = :id</domain>
  		<context name="id" expr="eval: id"/>
  	</action-view>
  	
<!--   	PRODUCTION -->

	<action-view name="action-product-view-create-production-order" title="Create production order" model="com.axelor.apps.base.db.Wizard">
		<view type="form" name="production-order-wizard-form"/>
		<view-param name="popup" value="reload"/>
  		<view-param name="show-toolbar" value="false"/>
  		<view-param name="show-confirm" value="false" />
  		<context name="_businessId" expr="eval: __self__"/>
	</action-view>
  	
  	
</object-views>
