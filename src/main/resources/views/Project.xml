<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://apps.axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://apps.axelor.com/xml/ns/object-views http://apps.axelor.com/xml/ns/object-views/object-views_0.9.xsd">
    
    <grid name="project-grid" title="Affairs/Projects" model="com.axelor.apps.organisation.db.Project">
        <field name="clientPartner"/>
        <field name="contactPartner"/>
        <field name="company"/>
        <field name="affairName"/>
        <field name="isModel"/>
    </grid>
    
    <form cols="6" onNew="action-project-record-default,action-project-unit" name="project-form" title="Affair/Project" model="com.axelor.apps.organisation.db.Project">
	    <group showTitle="false" colSpan="4">
	        <field name="affairName"/>
	        <field name="responsibleUserInfo"/>
	        <field name="defaultTask" hideIf="!isTimeSheetImputable"/>
	        <field name="projectUnit"/>
	        <field name="clientPartner"/>
	        <field name="contactPartner" domain="self.isContact = true"/>
	        <field name="company" widget="SuggestBox"/>
	        <field name="typeDurationSelect"/>
	        <field name="plannedDuration"/>
	        <field name="description" widget="html"/>
	        <group name="specificSettings" title="Specific settings" colSpan="4" canCollapse="true">
	        	<field name="isProject"/>
	        	<field name="isAffair"/>
	            <field name="isModel"/>
	            <field name="modelProject" hideIf="isModel" domain="self.isModel = true"/>
	            <field name="parentProject" onChange="action-project-unit"/>
	            <field name="imputExpense"/>
	            <field name="typeProjectSelect" showIf="imputExpense == true"/>
	            <field name="isReinvoicingExpense"/>
	            <field name="isReinvoicingTime"/>
	            <field name="isTimeSheetImputable"/> 
	        </group>
	    </group>
	    <group title="Actions" showTitle="false" colSpan="2" cols="1">
	        <button name="generateNewInstanceOfProject" title="Generate new project instance" hideIf="!isModel" colSpan="1"/>
	        <button name="generateDraftInvoice" title="Generate draft invoice" colSpan="1" onClick="save,action-project-validate-generate-invoice,action-project-method-create-invoice"/>
	        <button name="showTask" title="Show tasks" colSpan="1" onClick="action-project-view-task"/>
	    </group>
	    <notebook colSpan="6">
	        <page title="Tasks">
	            <field name="taskList" grid-view="task-project-grid" form-view="task-form" colSpan="6"/>
	        </page>
	        <page title="Membres" colSpan="4">
	            <field name="memberUserInfoSet" colSpan="6"/>
	        </page>
	    </notebook>
	</form>

	
    <action-view name="action-project-view-task" title="Tasks" model="com.axelor.apps.organisation.db.Task">
		<view type="grid" name="task-grid"/>
		<view type="form" name="task-form"/>
		<domain>self.project.id = :_projectId</domain>
		<context name="_projectId" expr="eval: __this__.id"/>
	</action-view>
    
    <action-record name="action-project-record-default" model="com.axelor.apps.organisation.db.Project">
		<field name="isTimeSheetImputable" expr="true"/>
	</action-record>
	
    <action-record name="action-project-unit" model="com.axelor.apps.organisation.db.Project">
		<field name="projectUnit" expr="eval: parentProject?.projectUnit" if="parentProject &amp;&amp; parentProject.projectUnit"/>
		<field name="projectUnit" expr="call:com.axelor.apps.base.service.administration.GeneralService:getUnit()" if="!parentProject || parentProject.projectUnit == null"/>
	</action-record>
	
	<action-method name="action-project-method-create-invoice">
		<call class="com.axelor.apps.accountorganisation.web.ProjectInvoiceController" method="createInvoice"/>
	</action-method>
	
	<action-validate name="action-project-validate-generate-invoice">
		<error message="Generating invoice is impossible, the fields clientPartner and contactPartner must be filled." if="clientPartner == null || contactPartner == null"/>
   		<error message="Generating invoice is impossible, please link the task to a saleOrderLine to do so." if="eval: taskList?.collect(){ it?.salesOrderLine }?.contains(null) == true"/>
   		<error message="There is currently no task to invoice. If you need to generate an invoice from a task, please tick the checkbox 'To invoice' and make sure all necessary informations are filled in." if="eval: taskList?.collect(){ it?.isToInvoice }?.contains(true) == false"/>
	</action-validate> 
		
</object-views>