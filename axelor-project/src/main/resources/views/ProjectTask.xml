<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_3.0.xsd">

	
	<grid name="project-grid" title="Projects" model="com.axelor.apps.project.db.ProjectTask">
		<field name="fullName"/>
		<field name="company"/>
		<field name="customer" />
		<field name="fromDate" />
		<field name="toDate" />
		<field name="dueDate" />
		<field name="statusSelect"/>
		<field name="progress" widget="SelectProgress"/>
	</grid>

	<form name="project-form" title="Project" model="com.axelor.apps.project.db.ProjectTask" onNew="action-project-project-default,action-project-task-attrs-duration-title"
	onLoad="action-project-task-record-set-visible-duration,action-project-task-attrs-duration-title">
		<panel title="Overview">
			<field name="statusSelect" widget="NavSelect"/>
			<field name="project" title="Parent Project" hideIf="$popup()" domain="self.taskTypeSelect = 'project'" form-view="project-form" grid-view="project-grid"/>
			<field name="code"/>
			<field name="name"/>
			<field name="company"/>
			<field name="customer" requiredIf="project == null &amp;&amp; taskTypeSelect == 'project'" domain="self.isCustomer = true"/>
			<field name="assignedTo" title="Person In Charge" onSelect="action-project-attrs-assigned-to-domain"/>
			<field name="saleOrder" domain="self.clientPartner = :customer" requiredIf="toInvoice" if-module="axelor-business-project"/>
			<field name="fromDate" />
			<field name="toDate" />
			<field name="$visibleDuration" title="Duration" type="decimal" onChange="action-project-task-record-set-stored-duration"/>
			<field name="$visibleTimeSpent" title="Time Spent" type="decimal" onChange="action-project-task-record-set-stored-time-spent"/>
			<field name="dueDate" />
			<field name="progress" widget="SelectProgress"/>
			<field name="$visibleLeadDelay" title="Lead/Delay" type="decimal" onChange="action-project-task-record-set-stored-lead-delay"/>
			<field name="imputable" if-module="axelor-business-project"/>
			<field name="invoicingTypeSelect" if-module="axelor-business-project"/>
			<field name="invoiceStatusSelect"/>
			<field name="toInvoice"/>
			<field name="invoiced" showIf="toInvoice"/>
		</panel>
		<panel-tabs>
			<panel title="Invoicing" if-module="axelor-business-project" showIf="invoicingTypeSelect == 3">
				<field name="product"/>
  				<field name="price" onChange="action-project-task-record-compute-exTaxTotal"/>
  				<field name="qty" onChange="action-project-task-record-compute-exTaxTotal"/>
  				<field name="unit" />
  				<field name="exTaxTotal" readonly="true"/>
			</panel>
			<panel title="Related Projects">
				<panel-dashlet action="action-project-task-view-show-project" colSpan="12"/>
			</panel>
			<panel title="Tasks">
				<panel-dashlet action="action-project-task-view-show-task" colSpan="12"/>
			</panel>
			<panel title="Other elements to invoice" if-module="axelor-business-project">
				<panel-related field="elementsToInvoiceList" colSpan="12"/>
			</panel>
			<panel title="Log Times">
				<panel-related field="timesheetLineList" colSpan="12" grid-view="timesheet-line-project-grid" form-view="timesheet-line-project-form" if-module="axelor-human-resource"/>
			</panel>
			<panel title="Project Tree">
				<panel-dashlet action="action-view-show-project-tree" colSpan="12" title="Project Tree"/>
			</panel>
			<panel title="Description">
				<field name="description" showTitle="false" colSpan="12" widget="html"/>
				<field name="taskTypeSelect" hidden="true" />
				<field name="duration" hidden="true"/>
				<field name="timeSpent" hidden="true"/>
				<field name="leadDelay" hidden="true"/>
			</panel>
			<panel title="Financial Information">
				<panel title="Sales">
					<field name="totalSaleOrdersFinalized"/>
					<field name="totalSaleOrdersConfirmed"/>
					<field name="totalSaleOrdersInvoiced"/>
				</panel>
				<panel title="Purchases">
					<field name="totalPurchaseOrdersFinalized"/>
					<field name="totalPurchaseOrdersConfirmed"/>
					<field name="totalPurchaseOrdersInvoiced"/>
				</panel>
				<panel title="Internal">
					<panel title="Log Times">
						<field name="totalTimesPlanned"/>
						<field name="totalTimesRealised"/>
					</panel>
					<panel title="Expenses">
						<field name="totalExpenses"/>
					</panel>
					<panel title="Production">
						<field name="totalEstimatedCosts"/>
						<field name="totalRealCosts"/>
					</panel>
					<button name="dashBoardButton" title="See DashBoard"/>
					<button name="computeDetailsButton" title="See Compute Details"/>
				</panel>
				<panel title="Margins">
					<field name="totalProducedTO"/>
					<field name="estimatedMargin"/>
					<field name="realTimesMargin"/>
					<field name="realInvoicingMargin"/>
					<button name="monthlyDetails" title="See Monthly Details"/>
				</panel>
			</panel>
		</panel-tabs>
		<panel title="Settings" sidebar="true">
			<field name="membersSet" widget="TagSelect"/>
		</panel>
	</form>
	
	<grid name="task-grid" title="Tasks" model="com.axelor.apps.project.db.ProjectTask">
		<field name="name"/>
		<field name="assignedTo"/>
		<field name="fromDate" />
		<field name="toDate" />
		<field name="dueDate" />
		<field name="statusSelect"/>
		<field name="progress" widget="SelectProgress"/>
	</grid>

	<form name="task-form" title="Task" model="com.axelor.apps.project.db.ProjectTask" onNew="action-project-task-attrs-hide-invoicing-panel,action-project-task-default,action-project-task-attrs-duration-title"
	onLoad="action-project-task-attrs-hide-invoicing-panel,action-project-task-record-set-visible-duration,action-project-task-attrs-duration-title">
	    <panel>
	    	<field name="statusSelect" widget="NavSelect"/>
	        <field name="project" onChange="action-project-task-attrs-hide-invoicing-panel" required="true" title="Project" hideIf="$popup()" domain="self.taskTypeSelect = 'project'" form-view="project-form" grid-view="project-grid"/>
		    <field name="name" colSpan="12" />
			<field name="assignedTo" title="Assigned To" onSelect="action-task-attrs-assigned-to-domain"/>
			<field name="fromDate" />
			<field name="toDate" />
			<field name="$visibleDuration" title="Duration" type="decimal" onChange="action-project-task-record-set-stored-duration"/>
			<field name="$visibleTimeSpent" title="Time Spent" type="decimal" onChange="action-project-task-record-set-stored-time-spent"/>
			<field name="dueDate" />
			<field name="progress" widget="SelectProgress"/>
			<field name="$visibleLeadDelay" title="Lead/Delay" type="decimal" onChange="action-project-task-record-set-stored-lead-delay"/>
			<field name="imputable" if-module="axelor-business-project"/>
			<field name="invoiceStatusSelect"/>
			<field name="toInvoice"/>
			<field name="invoiced" showIf="toInvoice"/>
		</panel>
		<panel-tabs>
			<panel name="invoicingPanel" title="Invoicing" if-module="axelor-business-project" hidden="true">
				<field name="product"/>
  				<field name="price" onChange="action-project-task-record-compute-exTaxTotal"/>
  				<field name="qty" onChange="action-project-task-record-compute-exTaxTotal"/>
  				<field name="unit" />
  				<field name="exTaxTotal" readonly="true"/>
			</panel>
			<panel title="Log Times">
				<panel-related field="timesheetLineList" colSpan="12" grid-view="timesheet-line-project-grid" form-view="timesheet-line-project-form" if-module="axelor-human-resource"/>
			</panel>
			<panel title="Description">
				<field name="description" showTitle="false" colSpan="12" widget="html"/>
				<field name="taskTypeSelect" hidden="true" />
				<field name="duration" hidden="true"/>
				<field name="timeSpent" hidden="true"/>
				<field name="leadDelay" hidden="true"/>
			</panel>
		</panel-tabs>
	</form>
	
	
	<grid name="project-task-grid" title="Projects/Tasks" model="com.axelor.apps.project.db.ProjectTask">
		<field name="fullName"/>
		<field name="customer" />
		<field name="fromDate" />
		<field name="toDate" />
		<field name="dueDate" />
		<field name="statusSelect"/>
		<field name="progress" widget="SelectProgress"/>
		<field name="taskTypeSelect"/>
	</grid>

	<form name="project-task-form" title="Project/Task" model="com.axelor.apps.project.db.ProjectTask" onNew="action-project-task-attrs-hide-invoicing-panel,action-project-project-default,action-project-task-attrs-duration-title"
	onLoad="action-project-task-attrs-hide-invoicing-panel,action-project-task-record-set-visible-duration,action-project-task-attrs-duration-title">
		<panel title="Overview">
			<field name="statusSelect" widget="NavSelect"/>
			<field name="project" requiredIf="taskTypeSelect == 'task'" onChange="action-project-task-attrs-hide-invoicing-panel" title="Parent Project" hideIf="$popup()" domain="self.taskTypeSelect = 'project'" form-view="project-form" grid-view="project-grid"/>
			<field name="code"/>
			<field name="name"/>
			<field name="company" hideIf="taskTypeSelect == 'task'"/>
			<field name="customer" requiredIf="project == null &amp;&amp; taskTypeSelect == 'project'" domain="self.isCustomer = true" hideIf="taskTypeSelect == 'task'"/>
			<field name="assignedTo" title="Person In Charge" onSelect="action-project-attrs-assigned-to-domain,action-task-attrs-assigned-to-domain"/>
			<field name="saleOrder" domain="self.clientPartner.id = :customer.id" requiredIf="toInvoice" if-module="axelor-business-project" hideIf="taskTypeSelect == 'task'"/>
			<field name="fromDate" />
			<field name="toDate" />
			<field name="$visibleDuration" title="Duration" type="decimal" onChange="action-project-task-record-set-stored-duration"/>
			<field name="$visibleTimeSpent" title="Time Spent" type="decimal" onChange="action-project-task-record-set-stored-time-spent"/>
			<field name="dueDate" />
			<field name="progress" widget="SelectProgress"/>
			<field name="$visibleLeadDelay" title="Lead/Delay" type="decimal" onChange="action-project-task-record-set-stored-lead-delay"/>
			<field name="imputable" if-module="axelor-business-project"/>
			<field name="invoicingTypeSelect" if-module="axelor-business-project" hideIf="taskTypeSelect == 'task'"/>
			<field name="invoiceStatusSelect"/>
			<field name="toInvoice"/>
			<field name="invoiced" showIf="toInvoice"/>
		</panel>
		<panel-tabs>
			<panel name="invoicingPanel" title="Invoicing" if-module="axelor-business-project" hidden="true">
				<field name="product"/>
  				<field name="price" onChange="action-project-task-record-compute-exTaxTotal"/>
  				<field name="qty" onChange="action-project-task-record-compute-exTaxTotal"/>
  				<field name="unit" />
  				<field name="exTaxTotal" readonly="true"/>
			</panel>
			<panel title="Related Projects">
				<panel-dashlet action="action-project-task-view-show-project" colSpan="12"/>
			</panel>
			<panel title="Tasks" hideIf="taskTypeSelect == 'task'">
				<panel-dashlet action="action-project-task-view-show-task" colSpan="12"/>
			</panel>
			<panel title="Log Times">
				<panel-related field="timesheetLineList" colSpan="12" grid-view="timesheet-line-project-grid" form-view="timesheet-line-project-form" if-module="axelor-human-resource"/>
			</panel>
			<panel title="Other elements to invoice" if-module="axelor-business-project" hideIf="taskTypeSelect == 'task'">
				<panel-related field="elementsToInvoiceList" colSpan="12"/>
			</panel>
			<panel title="Project Tree" hideIf="taskTypeSelect == 'task'">
				<panel-dashlet action="action-view-show-project-tree" colSpan="12" title="Project Tree"/>
			</panel>
			<panel title="Description">
				<field name="description" showTitle="false" colSpan="12" widget="html"/>
				<field name="taskTypeSelect" hidden="true" />
				<field name="duration" hidden="true"/>
				<field name="timeSpent" hidden="true"/>
				<field name="leadDelay" hidden="true"/>
			</panel>
		</panel-tabs>
		<panel title="Settings" sidebar="true">
			<field name="membersSet" widget="TagSelect" hideIf="taskTypeSelect == 'task'"/>
		</panel>
	</form>
	
	<action-attrs name="action-project-task-attrs-hide-invoicing-panel">
		<attribute name="hidden" for="invoicingPanel" expr="eval: invoicingTypeSelect != 3 &amp;&amp; project?.invoicingTypeSelect != 3"/>
	</action-attrs>
	
	<action-attrs name="action-task-attrs-assigned-to-domain">
	    <attribute name="domain" for="assignedTo" expr="eval:&quot;self.id in (${(_parent?.membersSet?.collect{it->it.id}+[0,0]).join(',')}) &quot;" if="taskTypeSelect == 'task'"/>
	</action-attrs>
	
	<action-attrs name="action-project-attrs-assigned-to-domain">
	    <attribute name="domain" for="assignedTo" expr="eval:&quot;self.id in (${(membersSet?.collect{it->it.id}+[0,0]).join(',')}) &quot;" if="taskTypeSelect == 'project'"/>
	</action-attrs>
	
	<action-record name="action-project-project-default" model="com.axelor.apps.project.db.ProjectTask">
		<field name="taskTypeSelect" expr="eval:'project'" />
		<field name="company" expr="eval:__user__.activeCompany"/>
		<field name="product" expr="eval: com.axelor.apps.base.service.administration.GeneralService.getGeneral().getProductInvoicingProjectTask()"/>
	</action-record>
	
	<action-record name="action-project-task-default" model="com.axelor.apps.project.db.ProjectTask">
		<field name="taskTypeSelect" expr="eval:'task'" />
		<field name="company" expr="eval:__user__.activeCompany"/>
		<field name="product" expr="eval: com.axelor.apps.base.service.administration.GeneralService.getGeneral().getProductInvoicingProjectTask()"/>
	</action-record>
	
	<action-view name="action-view-show-project-tree" title="Project Tree" model="com.axelor.apps.project.db.ProjectTask">	
		<view type="tree" name="project-tree"/>
    	<view type="form" name="project-form"/>
    	<domain>self.project.id = :id</domain>
     	<context name="id" expr="eval: id"/>
	</action-view>
	
	<tree name="project-tree" title="Projects">
    	
    	<column name="name" type="string"/>
    	<column name="assignedTo" type="reference"/>
    	<column name="progress" type="integer"/>
    	<column name="taskTypeSelect" type="string"/>
		
		<node model="com.axelor.apps.project.db.ProjectTask" domain="self.project.id = :id" onClick="action-task-view">
			<field name="name" as="name"/>
			<field name="assignedTo" as="assignedTo"/>
			<field name="progress" as="progress"/>
			<field name="taskTypeSelect" as="taskTypeSelect"/>
		</node>    	
		
		<node model="com.axelor.apps.project.db.ProjectTask" parent="project" draggable="true" onClick="action-project-view">
			<field name="name" as="name"/>
			<field name="assignedTo" as="assignedTo"/>
			<field name="progress" as="progress"/>
			<field name="taskTypeSelect" as="taskTypeSelect"/>
		</node>
    
	</tree>
	
	<action-view name="action-project-view" title="Projects" model="com.axelor.apps.project.db.ProjectTask">
    	<view type="form" name="project-form"/>
        <view-param name="popup" value="reload"/>
        <view-param name="show-toolbar" value="false"/>
  		<view-param name="show-confirm" value="false" />
    	<context name="_showRecord" expr="eval: id"/>
    </action-view>
	
	<action-view name="action-task-view" title="Tasks" model="com.axelor.apps.project.db.ProjectTask">
    	<view type="form" name="task-form"/>
        <view-param name="popup" value="reload"/>
        <view-param name="show-toolbar" value="false"/>
  		<view-param name="show-confirm" value="false" />
    	<context name="_showRecord" expr="eval: id"/>
    </action-view>
    
    <action-attrs name="action-project-task-attrs-duration-title">
	    <attribute name="title" for="timesheetLineList.visibleDuration" expr="eval:__user__.employee?.timeLoggingPreferenceSelect == 'days' ? com.axelor.i18n.I18n.get('Days') : __user__.employee?.timeLoggingPreferenceSelect == 'minutes' ? com.axelor.i18n.I18n.get('Minutes') : com.axelor.i18n.I18n.get('Hours')"/>
	</action-attrs>
	
	<action-view name="action-project-task-view-show-project" title="Related Projects" model="com.axelor.apps.project.db.ProjectTask">
		<view type="grid" name="project-grid" />
		<view type="form" name="project-form" />
		<domain>self.taskTypeSelect = 'project' AND self.project.id = :id</domain>
	</action-view>
	
	<action-view name="action-project-task-view-show-task" title="Tasks" model="com.axelor.apps.project.db.ProjectTask">
		<view type="grid" name="task-grid" />
		<view type="form" name="task-form" />
		<domain>self.taskTypeSelect = 'task' AND self.project.id = :id</domain>
	</action-view>
	
	<action-record name="action-project-task-record-set-stored-duration" model="com.axelor.apps.project.db.ProjectTask">
	    <field name="duration" expr="call:com.axelor.apps.base.service.administration.GeneralService:getDurationHours($visibleDuration)"/>
	</action-record>
	
	<action-record name="action-project-task-record-set-stored-time-spent" model="com.axelor.apps.project.db.ProjectTask">
	    <field name="timeSpent" expr="call:com.axelor.apps.base.service.administration.GeneralService:getDurationHours($visibleTimeSpent)"/>
	</action-record>
	
	<action-record name="action-project-task-record-set-stored-lead-delay" model="com.axelor.apps.project.db.ProjectTask">
	    <field name="leadDelay" expr="call:com.axelor.apps.base.service.administration.GeneralService:getDurationHours($visibleLeadDelay)"/>
	</action-record>
	
	<action-record name="action-project-task-record-set-visible-duration" model="com.axelor.apps.project.db.ProjectTask">
	    <field name="$visibleDuration" expr="call:com.axelor.apps.base.service.administration.GeneralService:getGeneralDuration(duration)"/>
	    <field name="$visibleTimeSpent" expr="call:com.axelor.apps.base.service.administration.GeneralService:getGeneralDuration(timeSpent)"/>
	    <field name="$visibleLeadDelay" expr="call:com.axelor.apps.base.service.administration.GeneralService:getGeneralDuration(leadDelay)"/>
	</action-record>
	
	<action-record name="action-project-task-record-compute-exTaxTotal" model="com.axelor.apps.project.db.ProjectTask">
		<field name="exTaxTotal" expr="eval: price*qty"/>
	</action-record>

</object-views>
