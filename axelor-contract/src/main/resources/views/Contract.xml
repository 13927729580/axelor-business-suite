<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.0.xsd">

    <grid name="contract-grid" title="Contracts" model="com.axelor.apps.contract.db.Contract">
        <field name="contractId"/>
        <field name="name"/>
        <field name="targetType"/>
        <field name="company"/>
        <field name="partner"/>
        <field name="startDate"/>
        <field name="statusSelect"/>
    </grid>

    <form name="contract-form" title="Contract" model="com.axelor.apps.contract.db.Contract" width="large" onNew="action-record-contract-default-record" readonlyIf="statusSelect == 3">
        <toolbar>
            <button name="printContractBtn" title="Print" hidden="true" icon="fa-print" onClick="notImplementedYet"/>
        </toolbar>
        <panel>
            <panel colSpan="9">
                <field name="statusSelect" showTitle="false" readonly="true" colSpan="12">
                    <viewer depends="contractId,versionNumber"><![CDATA[
			<h3>
            <span x-translate>Contract</span><span ng-show="record.contractId"> - {{ record.contractId }} <span ng-show="record.versionNumber &gt; 0"> - {{ record.versionNumber }}</span></span>
            <span class="label label-default pull-right" x-translate ng-show="record.statusSelect == 1">Draft</span>
            <span class="label label-info pull-right" x-translate ng-show="record.statusSelect == 2">Active</span>
            <span class="label label-important pull-right" x-translate ng-show="record.statusSelect == 3">Closed</span>
          </h3>
            ]]></viewer>
                </field>
                <field name="targetType" readonlyIf="id" onChange="action-contract-attrs-domains-template"/>
                <field name="company" canEdit="false"/>
                <field name="name" colSpan="6" css="highlight"/>
                <field name="partner" showIf="targetType" canEdit="false" onChange="action-attrs-contract-update-partner" required="true"/>
                <field if="__config__.app.getApp('contract').getIsInvoicingManagement()" name="currency"/>
                <panel title="Contract Dates" hidden="true" showIf="id" colSpan="12">
                    <field name="createdOn" colSpan="3"/>
                    <field name="createdBy" colSpan="3"/>
                    <field name="startDate" readonly="true" showIf="statusSelect >= 2" colSpan="3"/>
                    <field name="endDate" hidden="true" showIf="statusSelect == 3" colSpan="3"/>
                </panel>
            </panel>
            <panel colSpan="3" stacked="true">
                <panel hidden="true" showIf="statusSelect == 1 || currentVersion.statusSelect == 1 || currentVersion.statusSelect == 2" stacked="true">
                    <field name="$contractTemplate" title="Contract template to use" type="MANY-TO-ONE" canNew="false" canEdit="false" target="com.axelor.apps.contract.db.ContractTemplate"/>
                    <button name="copyFromTemplate" title="Use this template" prompt="Do you really wish to fill your contract based on this template ?" onClick="save,com.axelor.apps.contract.web.ContractController:copyFromTemplate"/>
                </panel>
                <panel stacked="true">
                    <field name="nextVersion" hidden="true"/>
                    <button if="__config__.app.getApp('contract').isAmendmentManagement" name="newVersionBtn" title="New version" showIf="id &amp;&amp; nextVersion == null &amp;&amp; currentVersion.statusSelect == 3" onClick="save,action-view-contract-add-version"/>
                    <button if="__config__.app.getApp('contract').isAmendmentManagement" name="showNextVersionBtn" title="Show next version" showIf="id &amp;&amp; nextVersion != null" onClick="save,action-view-contract-show-version"/>
                    <button if="__config__.app.getApp('contract').isAmendmentManagement" name="deleteNextVersionBtn" title="Delete next version" showIf="id &amp;&amp; nextVersion != null" onClick="save,com.axelor.apps.contract.web.ContractController:deleteNextVersion"/>
                    <button name="waitingBtn" title="Waiting" showIf="id &amp;&amp; currentVersion.statusSelect == 1" onClick="save,com.axelor.apps.contract.web.ContractController:waiting"/>
                    <button name="ongoingBtn" title="Ongoing" showIf="id &amp;&amp; currentVersion.statusSelect == 2" onClick="save,com.axelor.apps.contract.web.ContractController:ongoing"/>
                    <button if="__config__.app.getApp('contract').isRenewalManagement" name="testBtn" title="Renew (test)" showIf="id &amp;&amp; statusSelect != 3" onClick="save,com.axelor.apps.contract.web.ContractController:renew"/>
                </panel>
                <panel title="Notes" stacked="true">
                    <field name="note" showTitle="false"/>
                </panel>
            </panel>
        </panel>
        <panel-tabs>
            <panel title="Current version">
                <field name="currentVersion" showTitle="false" colSpan="12" x-show-icons="false">
                    <editor x-viewer="true" x-show-on-new="true" x-show-titles="true">
                        <field name="statusSelect" showTitle="false" readonly="true" colSpan="6" widget="NavSelect"/>
                        <panel showIf="id" colSpan="6">
                            <field name="createdOn"/>
                            <field name="createdBy"/>
                        </panel>
                        <panel readonly="true" showIf="statusSelect >= 3" colSpan="9">
                            <field name="activatedBy" colSpan="4"/>
                            <field name="activationDate" colSpan="4"/>
                            <field name="endDate" hidden="true" readonly="true" showIf="endDate" colSpan="4"/>
                        </panel>
                        <field name="doNotRenew" hidden="true" showIf="isTacitRenewal" colSpan="3"/>
                        <field name="supposedActivationDate" hideIf="!supposedEndDate &amp;&amp; $readonly()" colSpan="3"/>
                        <field name="supposedEndDate" hideIf="!supposedEndDate &amp;&amp; $readonly()" colSpan="3"/>
                    </editor>
                </field>
            </panel>
            <panel title="Content">
                <panel name="contractLineListPanel" colSpan="12">
                    <field name="currentVersion" showTitle="false" showIf="isInvoicingManagement" colSpan="12" x-show-icons="false">
                        <editor x-viewer="true" x-show-on-new="true" x-show-titles="false">
                            <field name="contractLineList" showTitle="false" colSpan="12" form-view="contract-line-form" grid-view="contract-line-grid"/>
                        </editor>
                    </field>
                </panel>
                <field name="consumptionLineList" showIf="isConsumptionManagement" colSpan="12" form-view="consumption-line-form" grid-view="consumption-line-grid"/>
                <field name="additionalBenefitList" showIf="isAdditionaBenefitManagement" colSpan="12" form-view="additional-contract-line-form" grid-view="contract-line-grid"/>
                <field name="currentVersion" showTitle="false" colSpan="12" x-show-icons="false">
                    <editor x-viewer="true" x-show-on-new="true" x-show-titles="true">
                        <field name="description" colSpan="12" widget="html"/>
                    </editor>
                </field>
            </panel>
            <panel title="Invoicing" showIf="isInvoicingManagement">
                <field name="invoicePeriodStartDate" showIf="currentVersion.isPeriodicInvoicing" colSpan="4"/>
                <field name="invoicePeriodEndDate" showIf="currentVersion.isPeriodicInvoicing" colSpan="4"/>
                <field name="invoicingDate" colSpan="4"/>
                <button name="invoicingBtn" title="Invoicing" showIf="id &amp;&amp; currentVersion.statusSelect == 3 &amp;&amp; $get('currentVersion.isPeriodicInvoicing') == false" onClick="save,com.axelor.apps.contract.web.ContractController:invoicing"/>
                <panel-dashlet readonly="false" colSpan="12" height="350" action="action-contract-view-invoicing"/>
            </panel>
            <panel if="__config__.app.getApp('contract').getIsRenewalManagement()" title="Reconductions" colSpan="12">
                <field name="renewalNumber" hidden="true" showIf="renewalNumber > 0"/>
                <field name="lastRenewalDate" hidden="true" showIf="renewalNumber > 0"/>
                <panel title="Next renewal" colSpan="12">
                    <field name="currentVersion" showTitle="false" hidden="true" showIf="currentVersion.isTacitRenewal" x-show-icons="false">
                        <editor x-viewer="true" x-show-on-new="true" x-show-titles="true">
                            <field name="doNotRenew" colSpan="12"/>
                        </editor>
                    </field>
                </panel>
            </panel>
            <panel title="Termination" showIf="statusSelect != 1" colSpan="12">
                <field name="engagementStartDate" readonly="true" showIf="currentVersion.isWithEngagement"/>
                <field name="terminationDemandDate" hideIf="!currentVersion.isWithEngagement" requiredIf="currentVersion.isWithEngagement"/>
                <field name="terminatedDate"/>
                <field name="terminatedBy" readonly="true" hideIf="!terminatedManually" colSpan="3"/>
                <field name="terminatedManually" showIf="terminatedManually" colSpan="3"/>
                <button name="terminatedBtn" title="Terminate" showIf="id &amp;&amp; statusSelect == 2" onClick="save,com.axelor.apps.contract.web.ContractController:terminated"/>
            </panel>
            <panel if="__config__.app.getApp('contract').isConfigContract" title="Config.">
                <panel if="__config__.app.getApp('contract').isInvoicingManagement" title="Invoicing" colSpan="12">
                    <field name="isInvoicingManagement" readonlyIf="statusSelect > 1"/>
                    <panel hideIf="!isInvoicingManagement" colSpan="12">
                        <field name="isConsumptionManagement" colSpan="6"/>
                        <field name="isAdditionaBenefitManagement" colSpan="6"/>
                        <panel name="isConsumptionBeforeEndDatePanel" colSpan="6">
                            <field name="currentVersion" showTitle="false" colSpan="12" x-show-icons="false">
                                <editor x-viewer="true" x-show-on-new="true" x-show-titles="true">
                                    <field name="isConsumptionBeforeEndDate" colSpan="12"/>
                                </editor>
                            </field>
                        </panel>
                    </panel>
                    <panel name="invoicingSubPanel" colSpan="12">
                        <field name="currentVersion" showTitle="false" readonlyIf="currentVersion.statusSelect > 2" colSpan="12" x-show-icons="false">
                            <editor x-viewer="true" x-show-on-new="true" x-show-titles="true">
                                <field name="paymentMode" widget="SuggestBox" canEdit="false" form-view="payment-mode-form" grid-view="payment-mode-grid"/>
                                <field name="paymentCondition" widget="SuggestBox" canEdit="false" form-view="payment-condition-form" grid-view="payment-condition-grid"/>
                                <field name="invoicingMoment"/>
                                <field name="automaticInvoicing" readonlyIf="statusSelect > 2"/>
                                <field name="isPeriodicInvoicing" readonlyIf="statusSelect > 2"/>
                                <panel title="Periodic invoicing" showIf="isPeriodicInvoicing" colSpan="12">
                                    <field name="invoicingFrequency"/>
                                    <field name="isTimeProratedInvoice"/>
                                    <field name="isVersionProratedInvoice" showIf="isTimeProratedInvoice"/>
                                </panel>
                            </editor>
                        </field>
                    </panel>
                </panel>
                <panel if="__config__.app.getApp('contract').isRenewalManagement" title="Renewal" colSpan="12">
                    <field name="currentVersion" showTitle="false" readonlyIf="currentVersion.statusSelect > 2" colSpan="12" x-show-icons="false">
                        <editor x-viewer="true" x-show-on-new="true" x-show-titles="true">
                            <field name="isTacitRenewal"/>
                            <field name="renewalDuration"/>
                        </editor>
                    </field>
                </panel>
                <field name="currentVersion" showTitle="false" readonlyIf="currentVersion.statusSelect > 2" colSpan="12" x-show-icons="false">
                    <editor x-viewer="true" x-show-on-new="true" x-show-titles="true">
                        <panel title="Termination" colSpan="12">
                            <field name="isWithEngagement" colSpan="3"/>
                            <field name="engagementStartFromVersion" showIf="isWithEngagement" colSpan="3" requiredIf="isWithEngagement"/>
                            <field name="engagementDuration" showIf="isWithEngagement" canNew="true" requiredIf="isWithEngagement"/>
                            <spacer/>
                            <field name="isWithPriorNotice"/>
                            <field name="priorNoticeDuration" showIf="isWithPriorNotice" canNew="true" requiredIf="isWithPriorNotice"/>
                            <spacer/>
                        </panel>
                    </editor>
                </field>
                <panel title="Technical" colSpan="12">
                    <field name="toClosed"/>
                </panel>
            </panel>
            <panel-related hidden="true" readonly="true" showIf="versionHistory &amp;&amp; versionHistory.length > 0" field="versionHistory" form-view="contract-archived-version-form">
                <field name="createdOn"/>
                <field name="activationDate"/>
                <field name="endDate"/>
                <field name="statusSelect"/>
            </panel-related>
        </panel-tabs>
    </form>

    <action-attrs name="action-attrs-contract-on-load">
        <attribute name="readonly" for="isConsumptionBeforeEndDatePanel" expr="eval: __config__.app.getApp('contract').getIsUnchangableContract() || version.statusSelect >= 3"/>
        <attribute name="readonly" for="invoicingSubPanel" expr="eval: __config__.app.getApp('contract').getIsUnchangableContract() || version.statusSelect >= 3"/>
        <attribute name="readonly" for="contractLineListPanel" expr="eval: __config__.app.getApp('contract').getIsUnchangableContract() || version.statusSelect >= 3"/>
        <attribute name="readonly" for="engagementStartDate" expr="eval: __config__.app.getApp('contract').getIsUnchangableContract()"/>
        <attribute name="hidden" for="isConsumptionManagement" expr="eval: !__config__.app.getApp('contract').getIsConsumptionManagement()"/>

    </action-attrs>

    <action-record name="action-record-contract-default-record" model="com.axelor.apps.contract.db.Contract">
        <field name="statusSelect" expr="eval: 1"/>
        <field name="company"  expr="eval: __user__.activeCompany"/>
        <field name="targetType" expr="eval: _xTargetType" if="_xTargetType != null"/>
        <field name="currentVersion" expr="action:action-record-contract-version-default-record"/>
        <field name="partner" expr="eval: _partner"/>
        <field name="currency" expr="eval: __user__.activeCompany.currency"/>
    </action-record>

    <action-record name="action-record-contract-version-default-record" model="com.axelor.apps.contract.db.ContractVersion">
        <field name="statusSelect" expr="eval: 1"/>
    </action-record>

    <action-attrs name="action-attrs-contract-partner-domain">
        <attribute for="partner" name="domain" expr="eval: &quot;self IS NULL&quot;"/>
        <attribute for="partner" name="domain" expr="eval: &quot;self.isCustomer IS TRUE&quot;" if="targetType == 1"/>
        <attribute for="partner" name="domain" expr="eval: &quot;self.isSupplier IS TRUE&quot;" if="targetType == 2"/>
    </action-attrs>

    <!-- Archived versions -->

    <!--
     TODO: Add invoicing fields
     -->

    <form name="contract-archived-version-form" title="Version" model="com.axelor.apps.contract.db.ContractVersion">
        <panel title="Informations">
            <field name="statusSelect" colSpan="12" readonly="true" widget="NavSelect" showTitle="false"/>
            <panel showIf="id" colSpan="12">
                <field name="createdOn"/>
                <field name="createdBy"/>
            </panel>
            <panel showIf="statusSelect >= 3" colSpan="12" readonly="true">
                <field name="activationDate"/>
                <field name="activatedBy"/>
            </panel>
            <field name="supposedEndDate"/>
            <field name="endDate" hidden="true" showIf="endDate" readonly="true"/>
            <field name="description" colSpan="12" widget="html"/>
        </panel>
    </form>

    <!-- Next version views -->

    <action-view name="action-view-contract-show-version" title="Version" model="com.axelor.apps.contract.db.ContractVersion">
        <view type="grid" name="contract-version-next-grid"/>
        <view type="form" name="contract-version-next-form"/>
        <context name="_showRecord" expr="eval: nextVersion.id"/>
    </action-view>

    <action-view name="action-view-contract-add-version" title="Nouvelle version" model="com.axelor.apps.contract.db.ContractVersion">
        <view type="form" name="contract-version-next-form"/>
        <view type="grid" name="contract-version-next-grid"/>
        <view-param name="forceEdit"  value="true"/>
        <context name="_xContractId" expr="eval: id"/>
        <context name="_xIsNextVersion" expr="true"/>
    </action-view>

    <grid name="contract-version-next-grid" title="Versions" model="com.axelor.apps.contract.db.ContractVersion">
        <field name="contract.contractId"/>
        <field name="contract.name"/>
        <field name="contract.partner"/>
        <field name="activationDate"/>
        <field name="statusSelect"/>
    </grid>

    <form name="contract-version-next-form" title="Version" model="com.axelor.apps.contract.db.ContractVersion"
          onSave="save,com.axelor.apps.contract.web.ContractController:saveNextVersion"
          onLoad="action-record-contract-version-load"
          onNew="com.axelor.apps.contract.web.ContractVersionController:newVersion,action-record-contract-version-load">
        <panel readonly="true">
            <field name="contractNext.targetType"/>
            <field name="contractNext.company"/>
            <field name="contractNext.name" css="highlight"/>
            <field name="contractNext.partner" showIf="contractNext.targetType"/>
            <field name="contractNext.currency" if="__config__.app.getApp('contract').isInvoicingManagement"/>
            <panel title="Dates" colSpan="12">
                <panel colSpan="12">
                    <field name="contractNext.createdOn"/>
                    <field name="contractNext.createdBy"/>
                </panel>
                <field name="contractNext.statusSelect" hidden="true"/>
                <field name="contractNext.startDate" hidden="true" showIf="contractNext.statusSelect == 2"/>
                <field name="contractNext.endDate" hidden="true" showIf="contractNext.statusSelect == 3"/>
            </panel>
        </panel>
        <panel-tabs>
            <panel title="Current version">
                <field name="statusSelect" colSpan="12" readonly="true" widget="NavSelect" showTitle="false"/>
                <panel showIf="id" colSpan="12">
                    <field name="createdOn"/>
                    <field name="createdBy"/>
                </panel>
                <field name="supposedActivationDate" hideIf="statusSelect &gt; 2"/>
                <panel showIf="statusSelect == 3" colSpan="12" readonly="true">
                    <field name="activationDate"/>
                    <field name="activatedBy"/>
                </panel>
                <field name="supposedEndDate"/>
                <field name="endDate" hidden="true" showIf="statusSelect == 4" readonly="true"/>
                <field name="doNotRenew" hidden="true" showIf="$get('contractNext.isTacitRenewal') == true"/>
            </panel>
            <panel title="Content">
                <field name="description" colSpan="12" widget="html"/>
                <field name="contractLineList" colSpan="12" if="__config__.app.getApp('contract').isInvoicingManagement"/>
            </panel>
            <panel title="Config.">
                <panel title="Invoicing" if="__config__.app.getApp('contract').isInvoicingManagement" colSpan="12">
                    <field name="isConsumptionBeforeEndDate" colSpan="12"/>
                    <field name="paymentMode" grid-view="payment-mode-grid" form-view="payment-mode-form" widget="SuggestBox" canEdit="false"/>
                    <spacer/>
                    <field name="paymentCondition" canEdit="false" widget="SuggestBox" form-view="payment-condition-form" grid-view="payment-condition-grid"/>
                    <field name="invoicingMoment"/>
                    <field name="automaticInvoicing" readonlyIf="statusSelect &gt; 2"/>
                    <field name="isPeriodicInvoicing" readonlyIf="statusSelect &gt; 2"/>
                    <panel showIf="isPeriodicInvoicing" title="Periodic invoicing" colSpan="12">
                        <field name="invoicingFrequency"/>
                        <field name="isProratedFirstInvoice"/>
                        <field name="isProratedLastInvoice"/>
                        <field name="isTimeProratedInvoice" />
                        <field name="isVersionProratedInvoice" showIf="isTimeProratedInvoice"/>
                    </panel>
                </panel>
                <panel title="Renewal" if="__config__.app.getApp('contract').isRenewalManagement" colSpan="12">
                    <field name="isTacitRenewal" />
                    <field name="renewalDuration" />
                </panel>
                <panel colSpan="12" title="Termination">
                    <field name="isWithEngagement" colSpan="3" />
                    <field name="engagementStartFromVersion" showIf="isWithEngagement" requiredIf="isWithEngagement" colSpan="3" />
                    <field name="engagementDuration" showIf="isWithEngagement" requiredIf="isWithEngagement" canNew="true" />
                    <spacer/>
                    <field name="isWithPriorNotice" />
                    <field name="priorNoticeDuration" showIf="isWithPriorNotice" requiredIf="isWithPriorNotice" canNew="true" />
                </panel>
            </panel>
        </panel-tabs>

        <panel sidebar="true">
            <button name="waitingBtn" title="Waiting" onClick="save,com.axelor.apps.contract.web.ContractController:waitingNextVersion" showIf="id &amp;&amp; statusSelect == 1"/>
            <button name="ongoingBtn" title="Ongoing" onClick="save,com.axelor.apps.contract.web.ContractController:activeNextVersion,close" showIf="id &amp;&amp; statusSelect == 2"/>
        </panel>
        <panel sidebar="true" title="Notes">
            <field name="contractNext.note" showTitle="false"/>
        </panel>
        <panel hidden="true">
            <field name="contractNext"/>
            <field name="$_xIsNext" type="Boolean"/>
        </panel>
    </form>

    <action-attrs name="action-record-contract-version-load">
        <attribute for="$_xIsNext" name="value" expr="eval: contractNext"/>
        <attribute for="$_xIsNext" name="value" expr="eval: _xIsNextVersion" if="_xIsNextVersion"/>
    </action-attrs>

    <action-view name="action-contract-view-invoicing" model="com.axelor.apps.account.db.Invoice" title="Invoices">
        <view type="grid" name="invoice-lite-grid" />
        <view type="form" name="invoice-form" />
        <domain>self.contract.id = :contractId</domain>
        <context name="contractId" expr="eval: id"/>
    </action-view>

    <action-attrs name="action-contract-attrs-domains-template">
        <attribute for="$contractTemplate" name="domain" expr="eval: &quot;self.targetType = ${targetType}&quot;"/>
        <attribute for="partner" name="domain" expr="eval: &quot;self.isCustomer = true&quot;" if="targetType == 1"/>
        <attribute for="partner" name="domain" expr="eval: &quot;self.isSupplier = true&quot;" if="targetType == 2"/>
    </action-attrs>

</object-views>