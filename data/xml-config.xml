<?xml version="1.0"?>
<xml-inputs xmlns="http://apps.axelor.com/xml/ns/data-import"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://apps.axelor.com/xml/ns/data-import http://apps.axelor.com/xml/ns/data-import/data-import_0.8.xsd">

	<adapter name="Sinapse" type="com.axelor.data.adapter.JodaAdapter">
		<option name="type" value="LocalDate" />
		<option name="format" value="dd/MM/yyyy HH:mm:ss" />
	</adapter>
	
	<adapter name="SinapseDateTime" type="com.axelor.data.adapter.JodaAdapter">
		<option name="type" value="DateTime" />
		<option name="format" value="dd/MM/yyyy HH:mm:ss" />
	</adapter>
	
	<adapter name="LocalDateHistoConso" type="com.axelor.data.adapter.JodaAdapter">
		<option name="type" value="LocalDate" />
		<option name="format" value="MM/yyyy" />
	</adapter>
	
	<input file="[me.id]" root="MacroEvenements" > 
	
		<bind node="MacroEvenement" type="com.axelor.apps.event.db.MacroEvent" 
		 call="com.axelor.csv.script.ImportSinapseME:importMacroEvent" >

			<!-- ID Sinapse -->
			<bind eval="MEV_ERP_ID" to="sinapseId"/>
		
			<!-- EN TETE -->
			<bind node="@typeEvt" 		to="macroEventType" search="self.code = :macroEventType" update="false"/>
			<bind node="@emetteur"		to="trackingPartner" search="self.dsoNum = :trackingPartner" update="false"/>
			<bind node="@numeroEvt"		to="useCase" />
			<bind node="@envoi"			to="trackingMeId" />
			<bind 						to="meId" eval="useCase + '-' + trackingMeId" alias="me_id"/>
			<bind node="@statut" 		alias="me_status" />
			<bind 						to="meStatus" search="self.code = :meStatus" 
				eval="me_status== 'V' ? 'val' : (me_status == 'A' ? 'ala' : (me_status == 'E' ? 'fai' : ''))" update="false"/>
			<bind node="@dateEnvoi" 	to="sendDate" adapter="SinapseDateTime" />
			
			<!-- PCT -->
		  	<bind node="PCT/@reference"	to="mpt" search="self.name = :mpt" update="true" />
      		<bind node="PCT/@type"		to="mptType" />     			
			<bind node="PCT/@fluide" 	to="fluidType" 
				eval="fluidType == '1' ? 'elec' : (fluidType == '2' ? 'gas' : fluidType == '4' ? 'cable' : 'none')" />
			<bind node="PCT/@pro" 		to="proOk" />
			<bind node="PCT/@segment" 	to="segment" search="self.code = :segment" update="false" />
			
		  	<!-- INFORMATION PCT -->
			<bind node="PCT/ChampsValeurs/ChampValeur" to="mptGenericValueEventList">
				<bind node="@code" alias="generic_code"/>
				<bind to="genericFieldEvent" search="self.code = :generic_code" update="false">
				       <bind to="code" alias="generic_code"/>
				       <bind to="name" alias="generic_code"/>
				</bind>
				<bind node="@valeurCodeChoix"	to="code" />
				<bind node="text()"	to="value" />
			</bind>
      		
		  	<!-- AFFAIRE -->
		  	<bind node="PCT/Affaire/@numeroAffaire"	to="affairId" />
		  	<bind node="PCT/Affaire/@numeroAffaire"	to="crmRequest" 		
		  		search="self.affairNum = :crmRequest and self.dsoPartner.dsoNum = :trackingPartner" />
		  	<bind node="PCT/Affaire/@dateCreation"	to="createDate" 		adapter="SinapseDateTime" />
		  	<bind node="PCT/Affaire/@dateDebutRDV"	to="startMeetingDate" 	adapter="SinapseDateTime"/>
		  	<bind node="PCT/Affaire/@dateFinRDV"	to="endMeetingDate" 	adapter="SinapseDateTime" />
		  	<bind node="PCT/Affaire/@dateReception"	to="receptionDate" 		adapter="SinapseDateTime"/>
		  	<bind node="PCT/Affaire/@dateCloture"	to="closeDate" 			adapter="SinapseDateTime"/>
		  	<bind node="PCT/Affaire/@dateModif"		to="updateDate" 		adapter="SinapseDateTime" />
		  	<bind node="PCT/Affaire/@statut" 		to="affairStatus" 		search="self.code = :affairStatus" update="false"/>
		  		
		  	<bind node="PCT/Affaire/Couts/@coutGlobal"								to="totalPrice" />
		  	<bind node="PCT/Affaire/Couts/CoutVariante/@codeFacturation"			to="variantProduct"
		  		search="self.productCodeEquivList.codeProductDso = :variantProduct and self.productCodeEquivList.dsoCatalog.dsoPartner.dsoNum = :trackingPartner" />
		  	<bind node="PCT/Affaire/Couts/CoutVariante/text()"						to="variantPrice" />
		  	
		  	<bind node="PCT/Affaire/Couts/@express"									to="expressOk" />
		  	<bind node="PCT/Affaire/Couts/CoutExpress/@codeFacturation"				to="expressProduct" 
		  		search="self.productCodeEquivList.codeProductDso = :expressProduct and self.productCodeEquivList.dsoCatalog.dsoPartner.dsoNum = :trackingPartner" />
		  	<bind node="PCT/Affaire/Couts/CoutExpress/text()"						to="expressPrice" />
		  	
		  	<bind node="PCT/Affaire/Couts/@deplacementVain"							to="vainTravelOk" />
      		<bind node="PCT/Affaire/Couts/CoutDeplacementVain/text()"				to="vainTravelPrice" />
		  	<bind node="PCT/Affaire/Couts/CoutAnnulationTardive/@codeFacturation" 	to="vainTravelProduct"
		  		search="self.productCodeEquivList.codeProductDso = :vainTravelProduct and self.productCodeEquivList.dsoCatalog.dsoPartner.dsoNum = :trackingPartner" />
		  	
		  	<bind node="PCT/Affaire/Couts/@annulationTardive" 						to="cancelLateOk" />
		  	<bind node="PCT/Affaire/Couts/CoutAnnulationTardive/@codeFacturation" 	to="cancelLateProduct"
		  		search="self.productCodeEquivList.codeProductDso = :cancelLateProduct and self.productCodeEquivList.dsoCatalog.dsoPartner.dsoNum = :trackingPartner" />		  	
		  	<bind node="PCT/Affaire/Couts/CoutAnnulationTardive/text()"				to="cancelLatePrice" />
		  	
		  	<bind node="PCT/Affaire/Prestations/Prestation/@codePrestation" 		to="provisionCode"/>
		  	
		  	
		  	<!-- INFORMATION AFFAIRE -->
			<bind node="PCT/Affaire/Prestations/ChampsValeurs/ChampValeur" to="provisionGenericValueEventList">
				<bind node="@code" 	alias="prestation_code_generique"/>
				<bind to="genericFieldEvent" search="self.code = :genericFieldEvent" eval="prestation_code_generique" update="false" >
					<bind to="code" alias="prestation_code_generique" />
					<bind to="name" alias="prestation_code_generique"/>
				</bind>
				<bind node="text()"	to="value" />
			</bind>
      		
			<!-- INDEX -->
			<bind node="PCT/Consommations/ListeIndex/Index" to="indexEventList" > 					 
				<bind node="@date" 		 	to="indexEventDate" adapter="LocalDate"/>
				<bind node="@type" 			to="indexEventType" search="self.code = :indexEventType and self.typeSelect = 'type'" update="false" />
				<bind node="@sousType" 		to="indexEventSubType" search="self.code = :indexEventSubType and self.typeSelect = 'subtype'" update="false" />
				<bind node="IndexValeur" 	to="indexEventLineList" >
					<bind node="@code" 			to="indexEventCode" search="self.code = :indexEventCode and self.typeSelect = 'code'" update="false" />
					<bind node="@libelleCadran" to="dial" search="self.code = :dial" update="false" />
					<bind node="@coef"			to="coef" />
					<bind node="@passageAZero" 	to="zeroCrossingOk" adapter="Boolean"/>
					<bind node="text()" 		to="value"/>
				</bind>		
			</bind>
			 
			 <!-- CONSOMMATION -->
			<bind node="PCT/Consommations/Consommation" to="consumptionEventList" >
				<bind node="@debut" 	to="startDate" 	adapter="LocalDate"/>
				<bind node="@fin" 		to="endDate" 	adapter="LocalDate"/>
		  		<bind node="CnsValeur"	to="consumptionEventLineList" >
		  			<bind node="@code" 				to="consumptionCodeParameter" 	search="self.name = :code_conso and self.parameterType.code = 'typeConso'" update="false" alias="code_conso" />
		  			<bind 			 				to="qtyUnit" 					search="self.id = (SELECT consumptionCodeUnit FROM Parameter WHERE name = :code_conso and parameterType.code = 'typeConso')" update="false" />
					<bind node="@libellePeriode"	to="postParameter" 	search="self.sinapseCode = :postParameter and self.parameterType.code = 'poste'" update="false" />
					<bind node="text()" 			to="qty"/>
				</bind>
			</bind> 			
			
			<!-- RESPONSABLE D'EQUILIBRE -->
			<bind node="PCT/RE/@codeEic" 			to="balanceResponsiblePartner" 
				search="self.breCode = :balanceResponsiblePartner and self.breOk = 'true'" update="false"/>
				
			<!-- FOURNISSEUR -->
			<bind node="PCT/Fournisseur/@codeEic" 	to="providerPartner" 
				search="self.eicCode = :providerPartner and self.providerOk = 'true'" update="false"/>
				
			<!-- UTILISATEUR RESEAU-->
			<bind node="PCT/UtilisateurReseau/@nom"	to="networkUser" />
			
			<!-- CONTRAT ELEC -->

			<bind node="PCT/ContratElec[@nature='fourniture']/PS/@psUnique" 	alias="ps_unique_four"/>
			<bind node="PCT/ContratElec[@nature='acheminement']/PS/@psUnique" 	alias="ps_unique_ach"/>
			
			<bind node="PCT/ContratElec[@nature='acheminement']/Tarif/@code"		to="routingPricingCode" />
			<bind node="PCT/ContratElec[@nature='fourniture']/Tarif/@code"			to="provisionPricingCode" />
			
			<bind node="PCT/ContratElec[@nature='acheminement']/Tarif/@dateDebut"	to="routingPricingStartDate" 	adapter="LocalDate"/>
			<bind node="PCT/ContratElec[@nature='fourniture']/Tarif/@dateDebut"		to="provisionPricingStartDate"	adapter="LocalDate" />
			
			<bind node="PCT/ContratElec[@nature='acheminement']/Tarif/@dateFin"		to="routingPricingEndDate" 		adapter="LocalDate"/>
			<bind node="PCT/ContratElec[@nature='fourniture']/Tarif/@dateFin"		to="provisionPricingEndDate" 	adapter="LocalDate" />
			
			
			<bind node="PCT/ContratElec[@nature='acheminement']/PS" 				to="routingPowerEventList" 				
				if="ps_unique_ach != null &amp;&amp; !ps_unique_ach?.empty">
				<bind node="@psUnique" 	to="value" 			alias="ps_unique_ach"/>
				<bind 					to="postParameter" 	search="self.name = 'PS' and self.parameterType.code = 'poste'" update="false"/>
			</bind>
			
			<bind node="PCT/ContratElec[@nature='fourniture']/PS" 					to="provisionPowerEventList" 
				if="ps_unique_fr != null &amp;&amp; !ps_unique_fr?.empty">
				<bind node="@psUnique" 	to="value" alias="ps_unique_fr"/>
				<bind 					to="postParameter" search="self.name = 'PS' and self.parameterType.code = 'poste'" /> 
			</bind>

			<bind node="PCT/ContratElec[@nature='acheminement']/PS/@date"			to="powerEventStartDate" 		adapter="LocalDate"/>
<!-- 			<bind node="PCT/ContratElec[@nature='fourniture']/PS/@date"				to="provisionPowerStartDate" 	adapter="LocalDate" /> -->

			<bind node="PCT/ContratElec[@nature='fourniture']/PS/Puissance"			to="provisionPowerEventList" 
				if="ps_unique_four == null" >
				<bind node="text()"				to="value" />
				<bind node="@libellePeriode"	to="postParameter" search="self.sinapseCode = :postParameter and self.parameterType.code = 'poste'"/>				
			</bind>
			
			<bind node="PCT/ContratElec[@nature='acheminement']/PS/Puissance"		to="routingPowerEventList" 
				if="ps_unique_ach == null">
				<bind node="text()"				to="value" />
				<bind node="@libellePeriode" 	to="postParameter" search="self.sinapseCode = :postParameter and self.parameterType.code = 'poste'"/>
			</bind>
			

			<!-- FACTURE -->
			<bind node="PCT/Facture/@dateFacture" to="invoiceDate" adapter="LocalDate"/>
			<bind node="PCT/Facture/@numFacture"  to="invoiceId" />
			 
			<!-- LIGNE DE FACTURE -->
			<bind node="PCT/Facture/LigneFacture" to="invoiceLineEventList" >
				<bind node="@codeArticle"	to="product" search="self.code = :product" update="false"/>
				<bind node="@codeArticle"	to="articleId" />
				<bind node="@codeRecap"		to="summaryId" />
				<bind node="@dateDebut"		to="startDate" adapter="LocalDate"/>
				<bind node="@dateFin" 		to="endDate" adapter="LocalDate" />
				<bind node="@quantite" 		to="qty"/>
				<bind node="@prixUnitaire" 	to="price"/>
				<bind node="@codeUnite" 	to="priceUnit" search="self.code = :priceUnit" update="false"/>
				<bind node="text()" 		to="amount"/>
			</bind>
			
			<!-- HISTORIQUE DE CONSO -->
			<bind node="PCT/Facture/HistoriqueConsosActif/TotalActifFacture" to="consumptionEventHistoryList" >
				<bind node="@date" 		to="historyDate" adapter="LocalDateHistoConso"/>
				<bind node="@type" 		to="type"/>
				<bind node="text()" 	to="value"/>
			</bind>
				
		</bind>
		
	</input>

</xml-inputs>
